var widget=require("./class-widget");var storage=require("./class-storage");var utils=require("./utils");widget._setupSegments=function(f,d,i,j){var g=[];var f=$.extend(true,{},f);f.sc=f.sc||1;f.sl=f.sl||"h";f.sa=f.sa||"tl";f.sp=f.sp||[0,0,0,0];var c=widget._enumSegments(f,i);var k=f.tlwh||f.wh;var e=(f.sl=="h"?2:3)-(f.tlwh?0:2);if(typeof k[e]=="string"){if(!d){var b=f.of?$("#"+f.of):$("#canvasPages .active .widgetHolder");d=[0,0,b.width(),b.height()]}var a=f.sl=="h"?d[2]:d[3];if(k[e]=="a"&&c.autoSizeSegments.length>0){k[e]=a}else{var h=utils.fromPercentString(k[e],a);if(!isNaN(h)){k[e]=h}}}c.rootTlwh=k;widget._setSegmentTLWH(f,c);return c};widget._enumSegments=function(i,k){function e(B,y,x){if(!y||!(y.tlwh||y.wh)){return}var A={wId:B,wObj:y};if(!x||k===undefined){v.push(A)}else{v.splice(k,0,A);k++}var z=y.tlwh?y.tlwh[c]:y.wh[c-2];if(y.autoSize||typeof z==="string"){y.autoSize=true;q.push(A)}else{m+=z}}var v=[];var q=[];var m=0;var c=i.sl=="h"?2:3;if(i.segments&&i.segments.length>0){if(i.segments.length>0&&i.segments[0].hasOwnProperty("id")){var b=0;var a={};for(var n=0,w=i.segments.length;n<w;n++){var o=widget.get(i.segments[n].id);if(o){var t=i.segments[n].widget;e(t,o);b++;if(a[t]){a[t]++}else{a[t]=1}}}for(var f=b;f<i.sc;f++){var p=Number.MAX_VALUE;var r;for(var s=0;s<i.seg.length;s++){var u=i.seg[s];var j=a[u]||0;if(j<p){p=j;r=u}}var d=widget.get(r);e(r,d,true)}}else{for(var n=0,w=i.segments.length;n<w;n++){var u=i.segments[n].originalID;var d=widget.get(u);if(!d){d=widget.get(i.segments[n].widget)}else{d.id=i.segments[n].widget}e(i.segments[n].widget,d)}}}else{var l=i.seg.length;for(var s=0,h=0;s<i.sc;s++,h=s%l){var u=i.seg[h];var g=widget.get(u);e(u,g)}}return{segments:v,autoSizeSegments:q,totalSize:m}};widget._setSegmentTLWH=function(j,a){var o=j.segmentRoot||j.id;var e=j.tlwh||[0,0,j.wh[0],j.wh[1]];var k=j.sl=="h"?1:0;var h=j.sl=="h"?2:3;var i=[j.sp[1]||0,j.sp[0]||0];var d=j.sp[2+k]||0;var c=e[h]-i[k]-d-a.totalSize;if(a.autoSizeSegments.length>0){var m=Math.floor(c/a.autoSizeSegments.length);var l=c-(m*a.autoSizeSegments.length);for(var n=0;n<a.autoSizeSegments.length;n++,l--){var g=a.autoSizeSegments[n].wObj;var q=m+Number(l>0);a.totalSize+=q;if(g.tlwh){g.tlwh[h]=q}else{g.wh[h-2]=q}g.of=g.of||o}}if(e[h]=="a"||a.autoSize){a.autoSize=true;e[h]=a.totalSize+i[k]+d}var f=0;var b=0;if(!a.autoSize){switch(j.sa){case"br":i[k]=e[h]-d-a.totalSize;break;case"c":i[k]+=c>>1;break;case"d":f=Math.floor(c/(j.sc+1));b=c-(f*(j.sc+1));break}}for(var n=0;n<a.segments.length;n++,b--){i[k]+=f+Number(b>0);a.segments[n].pos=[i[0],i[1]];var g=a.segments[n].wObj;var p=g.tlwh||[0,0,g.wh[0],g.wh[1]];i[k]+=p[h];g.of=g.of||o}if(a.autoSize){a.rootTlwh=e;if(j.tlwh){j.tlwh[h]=e[h]}else{j.wh[h-2]=e[h]}}};widget._updateSegments=function(m,h,p){var x=h.segments;var j=$("#"+m.segmentRoot);for(var t=0;t<x.length;t++){var b=widget._setSegmentBorder(m,x,t);var A=x[t];var y=m.segments[t].id;if(y&&(y.substr(0,2)=="w_"||(y.substr(0,1)=="w"&&y.length==33))){var q={left:parseInt(j.get(0).style.left,10),top:parseInt(j.get(0).style.top,10)};var v=widget.get(y);var c=$("#"+y);var n={left:parseInt(c.get(0).style.left,10),top:parseInt(c.get(0).style.top,10)};var z=A.pos[1]+q.left-n.left;var s=A.pos[0]+q.top-n.top;var l=z!=0||s!=0;var g={tlwh:$.merge([],v.tlwh)};var k=typeof g.tlwh[2]=="string"||typeof g.tlwh[3]=="string";var C=false;var o=objTlwh=[0,0,j.width(),j.height()];if(m.lockTo!=m.segmentRoot){var r=storage.get(m.segmentRoot,{returnModel:true}).getPage().id;var f=$("#"+r);o=[0,0,f.width(),f.height()]}var w=widget._setTMPLVars(y,A.wObj,o);var e=$("canvas, img",c);p=p||{};var a=p.redraw=="all"||(p.redraw=="seg"&&p.segId==y);if(l){c.css({left:n.left+z+"px",top:n.top+s+"px"});g.tlwh[0]=A.pos[0];g.tlwh[1]=A.pos[1]}if(k){C=w.absTLWH[2]!=e.width()||w.absTLWH[3]!=e.height()}else{var B=[e.width(),e.height()];C=B[0]!=g.tlwh[2]||B[1]!=g.tlwh[3]}if(C||a){function u(F,G,E){G.add(F).add($("textarea, .widgetText",G)).css({width:E[2]+"px",height:E[3]+"px"});F.attr({width:E[2],height:E[3]})}if(p.redraw=="img"&&e.length&&e.get(0).tagName=="CANVAS"){if(!e.data("replacing")){e.data("replacing",true);var D=new Image();D.src=e.get(0).toDataURL("image/png");D.onload=(function(G,F,H,E){return function(){if(G.data("cancelReplace")){G.data({replacing:false,cancelReplace:false})}else{$(F).data("origCanvas",G);G.data("replacing",false).replaceWith(F);var I=widget._setTMPLVars(H,E.wObj,[0,0,j.width(),j.height()]);u($(F),$("#"+H),I.absTLWH)}}})(e,D,y,A)}}else{u(e,c,w.absTLWH)}}if(b){g.b=$.merge([],A.wObj.b)}if(p.redraw!="none"&&p.redraw!="img"&&(b||C||a)){if(e.data("replacing")){e.data("cancelReplace",true)}else{var d=e.data("origCanvas");if(d){e.replaceWith(d).data("origCanvas",null);d.attr({width:w.absTLWH[2],height:w.absTLWH[3]}).css({width:w.absTLWH[2]+"px",height:w.absTLWH[3]+"px"})}}widget._drawCanvasOrImage(c,w)}widget.set(g,y);var i=$('#canvasPages [data-segment="'+y+'"]').not(c);widget._updateDependents(y,o,i)}}widget.set({tlwh:m.tlwh,sc:x.length,segments:m.segments},m.segmentRoot);widget._updateSegmentRoot(m.segmentRoot,m,h);if(m.ca!="tl"){var o=m.tlwh;if(m.lockTo!=m.segmentRoot){var f=$("#"+storage.get(m.segmentRoot,{returnModel:true}).getPage().id);o=[0,0,f.width(),f.height()]}widget.resetCache();widget._updateDependents(m.segmentRoot,o)}};widget._updateSegmentRoot=function(i,h,b){var f=h.tlwh||[0,0,h.wh[0],h.wh[1]];var e=widget._getSegmentRootTLWH(i,h,b);if(!utils.arraysEqual(h.tlwh,e)||utils.isPercentString(e[2])||utils.isPercentString(e[3])){var a=$("#canvasPages .active .widgetHolder");var g=[0,0,a.width(),a.height()];var d=widget._setTMPLVars(i,h,g);d.tlwh=$.merge([],e);var c=$("#"+i);c.css({top:d.absTLWH[0]+"px",left:d.absTLWH[1]+"px",width:e[2]+"px",height:e[3]+"px"});widget._drawCanvasOrImage(c,d)}};widget._getSegmentRootTLWH=function(h,e,a){var b;if(a&&a.rootTlwh){b=a.rootTlwh}else{var g=!e.sl||e.sl=="h";var d=g?2:3;b=$.merge([],e.tlwh);if(b[d]=="a"){a=widget._enumSegments(e);var c=e.sp?e.sp[g?0:1]:0;var f=e.sp?e.sp[g?3:2]:0;b[d]=a.totalSize+c+f}}return b};widget._setSegmentBorder=function(g,e,b){if(!e){e=g.segments||[]}if(e&&e.length>0){var a=e.length-1;var f=g.sl||"h";var h="bs";if(a>0){switch(b){case 0:h=f=="h"?"bls":"bts";break;case a:h=f=="h"?"brs":"bbs";break;default:h="bms";break}}}var c=e[b].wObj;if(!c.hasOwnProperty("bs")){c.bs=c.b}var d=c.b;c.b=$.merge([],c[h]||c.b||[]);return !utils.arraysEqual(c.b,d||[])};widget._isMultiSegment=function(b){if(b==""){return false}function a(e){var d=storage.get(e),c=d&&d.seg;return c&&c.length>0}return a(b)||a($("#"+b).attr("data-segment-root"))};widget._addSegment=function(){var c=[];var a=fluid.selection.getSelectionModel().map(function(d){return d.get("id")});var b=$("#"+a.join(", #"));b.each(function(){var f=$(this).attr("id");var p=$(this).attr("data-segment");var o=Boolean(p);if(o&&p!=f){f=p}var j=widget.getSegmentRoots($(this));var k=j.attr("id");var h=widget.get(k);var g;if(o){g=0;for(var i=h.segments.length;g<i;g++){if(h.segments[g].id==f){g++;break}}}if(h&&h.seg){var n=$("#canvasPages .active");var e=n.find(".widgetHolder");var m=[0,0,e.width(),e.height()];h.sc++;var d=widget._setupSegments(h,null,g);if(typeof g=="undefined"){g=d.segments.length-1}var l=d.segments[g];var f=widget._createSaveAndDraw(l.wObj,h.lockTo,n,l.pos,e,m,j.attr("id"),true);h.segments.splice(g,0,{id:f,widget:l.wId});widget._updateSegments(h,d);c.push(f)}return false});fluid.selection.select(a);return c};widget._insertSegmentObj=function(b,d,a,c){b.segments.splice(c,0,{id:d,widget:a.wId});b.sc++;widget._updateSegments(b,widget._setupSegments(b))};widget._getLastSegment=function(b){var c=storage.get(b);var a=c&&c.segments;if(a&&a.length>0){return a[a.length-1].id}return false};widget.getSegmentsFromSelection=function(a){var b=$([]);$(a).each(function(){var d=$(this);var c=d.attr("data-segment");if(!c&&d.hasClass("segmentRootWidget")){var c=widget._getLastSegment(d.attr("id"))}b=b.add($("#"+c))});return b};widget._deleteSegment=function(c,f){function a(){var j=$(this);var m=j.attr("data-segment");var g=j.attr("data-segment-root");if(!m){return}var h=storage.get(g);if(!h){return}var l=$.extend(true,{},storage.get(g));var i=0;for(;i<l.segments.length;i++){if(l.segments[i].id==m){break}}widget.remove(m);l.segments.splice(i,1);l.sc--;storage.set(g,l);if(l.segments.length==0){widget.del($("#"+g));contextMenu.hide();propInspector.resetPropInspector();return}var e=widget._setupSegments(l,null,i,true);widget._updateSegments(l,e);if($("#"+g).hasClass("ui-selected")){b.push(g)}else{var k=(i>0)?i-1:0;b.push(l.segments[k].id)}}var b=[];var d=f?$("#"+f):widget.getSegmentsFromSelection(".ui-selected");d.each(a);fluid.selection.select(b);return false};widget._getSegmentPosition=function(b){var d=$(b).attr("id");var c=storage.get($(b).attr("data-segment-root"));var e=0;for(var a=c.segments.length;e<a;e++){if(c.segments[e].id==d){break}}return e};module.exports=widget;