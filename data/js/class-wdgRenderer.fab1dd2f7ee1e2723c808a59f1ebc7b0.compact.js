var widget=require("./class-widget");var storage=require("./class-storage");var browserDetect=require("./browserdetect");var utils=require("./StackBlur");require("./fluid/modules/upload");if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b&&a?this:a,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}if(!window.fluid){window.fluid={}}fluid.wdgProvider=function(){var a=window.widgets?$.extend(true,{},widgets):null;return{getWidgets:function(d){var c=$.extend(true,{},a.summary);if(d){for(var b in c){if(c.hasOwnProperty(b)){c[b].originId=b}}}return c},getRootWidgets:function(e,d){var b=[];for(var c in a.summary){if(a.summary.hasOwnProperty(c)&&a.summary[c].g&&(e==undefined||a.summary[c].g.indexOf(e)!=-1)){b.push(a.summary[c]);if(d){b[b.length-1].originId=c}}}return b},getWdgGroups:function(){return $.extend(true,{},a.g)},getChildWidgets:function(b,e){var d=[];var f;var h;for(var c=0;c<b.ad.length;c++){f=b.ad[c][0];if(a&&a.summary[f]){h=$.extend(true,{},a.summary[f])}else{h=$.extend(true,{},widgets.summary[f])}if(e){h.originId=f}d.push(h)}return d},getById:function(b){if(a&&a.summary[b]){return $.extend(true,{},a.summary[b])}else{return $.extend({},widgets.summary[b])}},getChildById:function(d,c){parentChildren=c&&c.ad?c.ad:null;if(parentChildren&&parentChildren.length){for(var b=0;b<parentChildren.length;b++){if(d==parentChildren[b][0]){return parentChildren[b]}}}return false}}}();fluid.widget=function(){return{handleCollection:function(f,d,e){if(f.length==undefined){var a={};f=$.extend(true,{},f);e.unshift({});for(var c in f){if(f.hasOwnProperty(c)){e[0]=f[c];a[c]=d.apply(this,e)}}return a}else{var a=[];e.unshift({});for(var b=0;b<f.length;b++){e[0]=f[b];a.push(d.apply(this,e))}return a}},setSizeLimit:function(b,c,a){return this.handleCollection(b,function(e,f,d){if(!e.wh){e.wh=[f,d]}else{if(typeof e.wh[0]=="string"){e.wh[0]=f}if(typeof e.wh[1]=="string"){e.wh[1]=d}}return e},[c,a])},setRootSizeLimit:function(b,c,a){return this.handleCollection(b,function(e,f,d){if(!e.g){return e}if(!e.wh){e.wh=[f,d]}else{if(typeof e.wh[0]=="string"){e.wh[0]=f}if(typeof e.wh[1]=="string"){e.wh[1]=d}}return e},[c,a])},hasChildWidgets:function(a){return a.ad&&a.ad.length?true:false},hasSegments:function(a){return a.sc?true:false},isTextWidget:function(a){if(a.tc){return true}else{return false}},isShapeWidget:function(a){if(a.b||a.bg||a.bgc||a.bgd||a.i){return true}else{return false}},isUploadWidget:function(a){if(a.upload==="y"){return true}else{return false}}}}();fluid.wdgRenderer=function(a,b){this.canvasSize=[a||320,b||480];this.useCanvas=true;this.renderingQueue={};this.renditions={};this.imagesToLoad={};this.uploadsToLoad={};this.imagesLoaded={};this.canvases={};this.cropping={x:12004,y:9804,x2:0,y2:0};this.renderBlur=true;this.useOneCanvas=true;this.setCropping=function(c){if(c.x<this.cropping.x){this.cropping.x=c.x}if(c.y<this.cropping.y){this.cropping.y=c.y}if(c.x+c.width>this.cropping.x2){this.cropping.x2=c.x+c.width}if(c.y+c.height>this.cropping.y2){this.cropping.y2=c.y+c.height}};this.generateCanvas=function(d,c){this.canvas=$("<canvas>").attr({width:(c&&c.width!==undefined)?c.width:this.canvasSize[0],height:(c&&c.height!==undefined)?c.height:this.canvasSize[1]});if(d){this.canvas.attr({id:"pag-"+d})}this.canvases[d]=this.canvas;this.ctx=this.canvas.get(0).getContext("2d")};this.percentToPixel=function(e,f,c){var d;if(f.wh[0].indexOf&&f.wh[0].indexOf("%")!==-1){d=parseInt(f.wh[0],10)/100;d=d*c.box[2];e[2]=d}if(f.wh[1].indexOf&&f.wh[1].indexOf("%")!==-1){d=parseInt(f.wh[1],10)/100;d=d*c.box[3];e[3]=d}return e};this.getPixelDimensions=function(d,e,c){if(e.wh&&typeof e.wh[0]=="number"){d[2]=e.wh[0]}if(e.wh&&typeof e.wh[1]=="number"){d[3]=e.wh[1]}return d};this.parseBoxValue=function(e,d){if(typeof(e)==="number"&&!isNaN(e)){return e}else{var c=(parseFloat(e||0)/100)*(d||0);return isNaN(c)?0:c}};this.calculateBox=function(j,d,c){if(!d){d={box:[0,0,this.canvasSize[0],this.canvasSize[1]]}}var f=[0,0];var h;if(j.tlwh){f=[this.parseBoxValue(j.tlwh[1],d.box[2]),this.parseBoxValue(j.tlwh[0],d.box[3]),this.parseBoxValue(j.tlwh[2],d.box[2]),this.parseBoxValue(j.tlwh[3],d.box[3])];return f}if(!j.wh){f[2]=d.box[2];f[3]=d.box[3]}else{f=this.getPixelDimensions(f,j,d);f=this.percentToPixel(f,j,d)}if(c){if(!c[3]||c[3][1]=="l"){if(typeof c[1]=="number"){f[0]=c[1]}else{if(typeof c[1]=="string"){f[0]=(parseInt(c[1],10)/100)*d.box[2]}}}else{if(c[3][1]=="c"){var e;if(typeof c[1]=="number"){e=c[1]}else{e=(parseInt(c[1],10)/100)*d.box[2]}f[0]=(d.box[2]-f[2])/2+e}else{if(typeof c[1]=="number"){f[0]=d.box[2]-f[2]-c[1]}else{if(typeof c[1]=="string"){h=(parseInt(c[1],10)/100)*d.box[3];f[0]=d.box[2]-f[2]-h}}}}if(!c[3]||c[3][0]=="t"){if(typeof c[2]=="number"){f[1]=c[2]}else{if(typeof c[2]=="string"){f[1]=(parseInt(c[2],10)/100)*d.wh[1]}}}else{if(c[3][1]=="c"){var i;if(typeof c[2]=="number"){i=c[2]}else{i=(parseInt(c[2],10)/100)*d.box[3]}f[1]=(d.box[3]-f[3])/2+i}else{if(typeof c[2]=="number"){f[1]=d.box[3]-f[3]-c[2]}else{if(typeof c[2]=="string"){h=(parseInt(c[2],10)/100)*d.wh[1];f[1]=d.wh[1]-f[3]-h}}}}}f[0]=f[0]+d.box[0];f[1]=f[1]+d.box[1];return f};this.renderUpload=function(e,f,c){$canvas=f||this.canvas;function j(m,l){if(!e.box[2]||!e.box[3]){e.box[2]=l.width;e.box[3]=l.height}var k=m.get(0).getContext("2d");k.drawImage(l,e.box[0],e.box[1],e.box[2],e.box[3]);l.onload=null;l.onerror=null}function i(n,l,m){n.addClass("failureImage");var k=n.get(0).getContext("2d");k.font="32pt Arial";k.fillText("Image",35,50);k.fillText("not found",10,115)}function d(){i();widget._convertCanvasToImg($(ctx.canvas),widgEl.find("img"),tmplVars)}function h(){var k=e.data||false;if(k&&k.substr(0,5)!="data:"){k=ajax.apiObjectUrl("img",e.data)}else{if(e.id){k=ajax.apiObjectUrl("img",e.id)}}return k||i()}if(c){j($canvas,c);return this.canvas}fluid.upload.get({id:e.data||e.id,callback:function(m,k){if(k.success){if(k.image){j.call(this,m,k.image)}else{if(k.imgData){var l=new Image();l.onload=j.bind(this,m,l);l.onerror=i.bind(this,m,l);l.src=k.imgData}}}else{var l=new Image();i.call(this,m,l)}}.bind(this,$canvas),priority:fluid.upload.priority.pageZoomedOut})};this.adjustWords=function(d){var e=[];for(var c=0;c<d.length;c++){if(d[c]!==""){e.push(d[c])}else{if(browserDetect.browser==="Firefox"){e[e.length-1]+=" "}}}return e};this.wrapText=function(s,p,f,m,j,t){if(f[3]<0){return 0}var k=p.split(" ");var u="";var c="";var r=0;var i,q;var h;var o=" ";var l=f[1];if(isNaN(m)){m=13}k=this.adjustWords(k);if(p.match(/[\u3131-\uCB4C]/)){o="";k=p.split("")}for(var d=0;d<k.length;d++){i=u+k[d]+o;q=s.measureText(i).width;if(browserDetect.browser!=="Firefox"){q=q+Math.round(-0.285714286*parseFloat(t)+0.075)}if(q>f[2]&&k.length!==1){c=k[d]+o;if(browserDetect.browser!=="Firefox"&&k[d].indexOf("-")!==-1){var e=u+k[d].substring(0,k[d].indexOf("-")+1);if(s.measureText(e).width<=f[2]){u=e;c=k[d].substring(k[d].indexOf("-")+1)+o}}if(l+m*0.5>f[1]+f[3]){return r}h=s.measureText(u).width;if(browserDetect.browser!=="Firefox"){h=h+Math.round(-0.285714286*parseFloat(t)+0.075)}if(h>f[2]&&u.indexOf(" ")===u.length-1&&browserDetect.browser!=="Firefox"){c=o+c}if(j&&j[1]==="c"){s.fillText(u,f[0]+(f[2]/2)-(h/2),l)}else{if(j&&j[1]==="r"){s.fillText(u,f[0]+f[2]-h,l)}else{s.fillText(u,f[0],l)}}u=c;l+=m;r++}else{u=i}}if(l+m*0.5>f[1]+f[3]){return r}h=s.measureText(u).width;h=h+Math.round(-0.285714286*parseFloat(t)+0.075);if(j&&j[1]==="c"){s.fillText(u,f[0]+(f[2]/2)-(h/2),l)}else{if(j&&j[1]==="r"){s.fillText(u,f[0]+f[2]-h,l)}else{s.fillText(u,f[0],l)}}return r};this.renderText=function(m,l){var y=m.ts.replace(/"/g,"");if(!this.useOneCanvas){if(this.renderingMode==="singlepage"){return $('<div class="widgetText" style="'+y+';width: 100%;height:100%;">'+m.tc+"</div>")}else{return $('<div class="widgetText" style="'+y+";width:"+(m.box[2]+3)+"px;height:"+m.box[3]+"px; top:"+m.box[1]+"px; left:"+m.box[0]+'px;">'+m.tc+"</div>")}}else{var o=0;var u=m.tc.replace(/&nbsp/g," ");var f=u.split("\n");var e;var l=l||this.canvas;var r=l.get(0).getContext("2d");var p=y.match(/font:[a-zA-Z0-9\s:\/]*;/);var d=y.match(/[0-9]+px/);if(d){d=parseInt(d[0],10)}if(p){p=p[0];p=p.replace("font:","");p=p.replace(";","")}else{var h="normal";if(y.indexOf("font-style")!==-1){h=y.substring(y.indexOf("font-style")+11,y.indexOf(";",y.indexOf("font-style"))).trim()}var k="normal";if(y.indexOf("font-variant")!==-1){k=y.substring(y.indexOf("font-variant")+13,y.indexOf(";",y.indexOf("font-variant"))).trim()}var n="normal";if(y.indexOf("font-weight")!==-1){n=y.substring(y.indexOf("font-weight")+12,y.indexOf(";",y.indexOf("font-weight"))).trim()}d=y.substring(y.indexOf("font-size")+10,y.indexOf(";",y.indexOf("font-size"))).trim();var A=y.substring(y.indexOf("font-family")+12,y.indexOf(";",y.indexOf("font-family"))).trim();e=y.substring(y.indexOf("line-height")+12,y.indexOf(";",y.indexOf("line-height"))).trim();p=h+" "+k+" "+n+" "+d+" "+A}var v=y.substring(y.indexOf("color")+6,y.indexOf(";",y.indexOf("color"))).trim();if(v.indexOf("rgb(")!==-1){v=utils.rgb2hex(v)}var j=y.indexOf(";",y.indexOf("text-align"))!==-1?y.substring(y.indexOf("text-align")+11,y.indexOf(";",y.indexOf("text-align"))).trim():y.substring(y.indexOf("text-align")+11).trim();var t="";if(y.indexOf("text-decoration")!==-1){t=y.substring(y.indexOf("text-decoration")+16,y.indexOf(";",y.indexOf("text-decoration"))).trim()}var B=0;if(y.indexOf("padding-top")!==-1){o=y.indexOf(";",y.indexOf("padding-top"));if(o!==-1){B=parseInt(y.substring(y.indexOf("padding-top")+12,o).trim(),10)}else{B=parseInt(y.substring(y.indexOf("padding-top")+12).trim(),10)}}var c=0;if(y.indexOf("margin-top")!==-1){o=y.indexOf(";",y.indexOf("margin-top"));if(o!==-1){c=parseInt(y.substring(y.indexOf("margin-top")+11,y.indexOf(";",y.indexOf("margin-top"))).trim(),10)}else{c=parseInt(y.substring(y.indexOf("margin-top")+11).trim(),10)}}r.fillStyle=v;r.font=p;r.textBaseline="top";var z=0;var q=0;if(e&&parseFloat(e)){z=Math.round(-0.07*parseFloat(d)+2.66);q=Math.round(0.5*(parseFloat(e)-parseFloat(d))-2.75);e=parseFloat(e)}else{if(p.indexOf("/")!==-1&&parseFloat(p.substring(p.indexOf("/")+1))){z=Math.round(-0.07*parseFloat(d)+2.66);e=parseFloat(p.substring(p.indexOf("/")+1))}else{e=Math.round(1.14*parseFloat(d))}}if(browserDetect.browser==="Firefox"){z=z+Math.round(0.148148148*parseFloat(d)+0.5)}var s=0;var C=[m.box[0],m.box[1]+z+q+B+c,m.box[2],m.box[3]];var w=m.ca||"lt";if(j==="center"){w=w[0]+"c"}else{if(j==="right"){w=w[0]+"r"}else{if(j==="left"){w=w[0]+"l"}}}if(f.length==1){this.wrapText(r,u,C,e,w,d)}else{for(var x=0;x<f.length;x++){s=s+this.wrapText(r,f[x],[C[0],C[1]+(x+s)*e,C[2],C[3]-(x+s)*e],e,w,d)}}return l}};this.paintCanvas=function(m,k){var q=this;if(!this.useOneCanvas){k=$("<canvas>").attr({width:this.renderingMode==="singlepage"?m.box[2]:this.canvasSize[0],height:this.renderingMode==="singlepage"?m.box[3]:this.canvasSize[1]})}else{if(!k){k=this.canvas}}var u=k.get(0).getContext("2d");var q=this;var l={blur:function(){if(m.blur){if(q.renderBlur){var x=document.createElement("img"),z=widget.renderBlurLayerImmediate.call(q,m.id),c=jQuery.extend([],m.box),i,A;if(!z){return false}if(c[0]<0){c[0]=0}if(c[1]<0){c[1]=0}if(c[2]>z.width){c[2]=z.width}if(c[3]>z.height){c[3]=z.height}var y=storage.get(m.id,{returnModel:true});if(y){A=y.getPage().getBox();if(c[0]+c[2]>A[2]){c[2]=A[2]-c[0]}if(c[1]+c[3]>A[3]){c[3]=A[3]-c[1]}}u.drawImage(z,c[0],c[1],c[2],c[3],c[0],c[1],c[2],c[3])}}},background:function(){u.save();function z(){var C=(m.bgc)?m.bgc:["#CAD1D7","#C4CBD3"];var E=[5,2];var D="v";if(m.bgd){D=m.bgd[0];E=[m.bgd[1],m.bgd[2]]}u.fillStyle=C[1];u.fill();u.fillStyle=C[0];if(D=="v"){for(var F=E[0];F<p;){u.fillRect(F,0,E[1],o);F+=E[0]}}else{for(var F=E[0];F<o;){u.fillRect(0,F,p,E[1]);F+=E[0]}}}if(!p){p=0}if(!o){o=0}if(m.bg=="c"){u.fillStyle=m.bgc[0];u.fill()}else{if(m.bg=="s"){z()}else{if(m.bg=="l"){var i=q.useOneCanvas?m.box[0]:0;var y=q.useOneCanvas?m.box[1]:0;var x=q.useOneCanvas?m.box[1]+m.box[3]:m.box[3];g=u.createLinearGradient(i,y,i,x);l._gradient(g,u,m)}else{if(m.bg=="lrl"){g=u.createLinearGradient(m.box[0],m.box[1],m.box[0]+m.box[2],m.box[1]);l._gradient(g,u,m)}else{if(m.bg=="ld"){g=u.createLinearGradient(m.box[0],m.box[1],m.box[0]+m.box[2],m.box[1]+m.box[3]);l._gradient(g,u,m)}else{if(m.bg=="ld2"){g=u.createLinearGradient(m.box[0]+m.box[2],m.box[1],m.box[0],m.box[1]+m.box[3]);l._gradient(g,u,m)}else{if(m.bg=="r"){var c=m.box[3]/2;var B=m.box[0]+m.box[2]/2;var A=m.box[1]+c;g=u.createRadialGradient(B,A,0,B,A,c);l._gradient(g,u,m)}}}}}}}u.restore()},border:function(B,x,y,i){var A=0,z=0;B.lineWidth=(typeof d)==="number"?d:v;B.strokeStyle=x.b[1];B.stroke();B.save()},path:function(ad,ah,L,J,H,i,C,G,K){ad.beginPath();var M=Math.floor(G/2);var X=J+M;var ab=H+M;var af=J+C-M;var Z=H+i-M;var T=Z-ab;var R=af-X;var W=["cloud","thumbsD","thumbsU"];if(K.sh&&K.sh[3]&&K.sh[2]){X+=Math.floor(K.sh[3]-K.sh[2]/2);ab+=Math.floor(K.sh[3]-K.sh[2]/2);af-=Math.floor(K.sh[3]+K.sh[2]/2);Z-=Math.floor(K.sh[3]+K.sh[2]/2)}if($.isArray(L)){for(var ac=0;ac<4;ac++){L[ac]=L[ac]||0}}else{L=[L,L,L,L]}if(ah=="sq"){var ae=Math.min((Z-ab)/2,(af-X)/2);L[0]=Math.min(L[0],ae);L[1]=Math.min(L[1],ae);L[2]=Math.min(L[2],ae);L[3]=Math.min(L[3],ae);ad.moveTo(ab+L[0],X),ad.lineTo(Z-L[1],X),ad.quadraticCurveTo(Z,X,Z,X+L[1]),ad.lineTo(Z,af-L[2]),ad.quadraticCurveTo(Z,af,Z-L[2],af),ad.lineTo(ab+L[3],af),ad.quadraticCurveTo(ab,af,ab,af-L[3]),ad.lineTo(ab,X+L[0]),ad.quadraticCurveTo(ab,X,ab+L[0],X)}if(ah=="arrU"){var O=(Z-ab)+(5/4);var B=(ab+Z)/2;var i=Z-ab;ad.moveTo(B,X+G);ad.lineTo(Z-(G/2),X+O);ad.lineTo(B+i*0.15,X+O);ad.lineTo(B+i*0.15,af);ad.lineTo(B-i*0.15,af);ad.lineTo(B-i*0.15,X+O);ad.lineTo(ab+(G/2),X+O);ad.lineTo(B,X+G)}if(ah=="arrD"){var O=(Z-ab)+(5/4);var B=(ab+Z)/2;var i=Z-ab;var D=af-X;var Q=(Z-ab)*1.5;if(D<=Q){O=(af-X)/2}ad.moveTo(B,af-G);ad.lineTo(Z-(G/2),af-O);ad.lineTo(B+i*0.15,af-O);ad.lineTo(B+i*0.15,X);ad.lineTo(B-i*0.15,X);ad.lineTo(B-i*0.15,af-O);ad.lineTo(ab+(G/2),af-O);ad.lineTo((ab+Z)/2,af)}if(ah=="arrR"){var O=(af-X)+(5/4);var A=(X+af)/2;var C=af-X;var E=Z-ab;var N=(af-X)*1.5;if(E<=N){O=(Z-ab)/2}ad.moveTo(Z-G,(X+af)/2);ad.lineTo(Z-O,af-(G/2));ad.lineTo(Z-O,A+C*0.15);ad.lineTo(ab,A+C*0.15);ad.lineTo(ab,A-C*0.15);ad.lineTo(Z-O,A-C*0.15);ad.lineTo(Z-O,X+(G/2));ad.lineTo(Z-G,(X+af)/2)}if(ah=="arrL"){var O=(af-X)+(5/4);var A=(X+af)/2;var C=af-X;var E=Z-ab;var N=(af-X)*1.5;if(E<=N){O=(Z-ab)/2}ad.moveTo(ab+G,(X+af)/2);ad.lineTo(ab+O,af-(G/2));ad.lineTo(ab+O,A+C*0.15);ad.lineTo(Z,A+C*0.15);ad.lineTo(Z,A-C*0.15);ad.lineTo(ab+O,A-C*0.15);ad.lineTo(ab+O,X+(G/2));ad.lineTo(ab+G,(X+af)/2)}if(ah=="image"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(Z,af);ad.lineTo(ab,af);ad.lineTo(ab,X-Math.floor(G/2));ad.moveTo(ab,X);ad.lineTo(Z,af);ad.moveTo(Z,X);ad.lineTo(ab,af)}else{if(ah=="tri"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(Z,af);ad.lineTo(ab,X)}else{if(ah=="tri"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(Z,af);ad.lineTo(ab,X)}else{if(ah=="trR"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(ab,af);ad.lineTo(ab,X)}else{if(ah=="ttrL"){ad.moveTo(Z,X);ad.lineTo(Z,af);ad.lineTo(ab,af);ad.lineTo(Z,X)}else{if(ah=="ttrR"){ad.moveTo(ab,X);ad.lineTo(Z,af);ad.lineTo(ab,af);ad.lineTo(ab,X)}else{if(ah=="triU"){ad.moveTo((ab+Z)/2,X);ad.lineTo(Z,af);ad.lineTo(ab,af);ad.lineTo((ab+Z)/2,X)}else{if(ah=="triD"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo((ab+Z)/2,af);ad.lineTo(ab,X)}else{if(ah=="triR"){ad.moveTo(ab,X);ad.lineTo(Z,(X+af)/2);ad.lineTo(ab,af);ad.lineTo(ab,X)}else{if(ah=="triL"){ad.moveTo(Z,X);ad.lineTo(ab,(X+af)/2);ad.lineTo(Z,af);ad.lineTo(Z,X)}else{if(ah=="ribU"){ad.moveTo(ab,X);ad.lineTo((ab+Z)/2,X+(af-X)*0.25);ad.lineTo(Z,X);ad.lineTo(Z,af);ad.lineTo(ab,af);ad.lineTo(ab,X)}else{if(ah=="ribD"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(Z,af);ad.lineTo((ab+Z)/2,X+0.75*(af-X));ad.lineTo(ab,af);ad.lineTo(ab,X)}else{if(ah=="flagR"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(ab+(4/5)*T,(X+af)/2);ad.lineTo(Z,af);ad.lineTo(ab,af);ad.lineTo(ab,X)}else{if(ah=="flagL"){ad.moveTo(ab,X);ad.lineTo(ab+(1/5)*T,(X+af)/2);ad.lineTo(ab,af);ad.lineTo(Z,af);ad.lineTo(Z,X);ad.lineTo(ab,X)}else{if(ah=="houseU"){ad.moveTo((ab+Z)/2,X);ad.lineTo(Z,X+(3/7)*R);ad.lineTo(Z,af);ad.lineTo(ab,af);ad.lineTo(ab,X+(3/7)*R);ad.lineTo((ab+Z)/2,X)}else{if(ah=="houseD"){ad.moveTo((ab+Z)/2,af);ad.lineTo(Z,X+(4/7)*R);ad.lineTo(Z,X);ad.lineTo(ab,X);ad.lineTo(ab,X+(4/7)*R);ad.lineTo((ab+Z)/2,af)}else{if(ah=="oct"){ad.moveTo(ab+(21/72)*T,X);ad.lineTo(ab+(51/72)*T,X);ad.lineTo(Z,X+(21/72)*R);ad.lineTo(Z,X+(51/72)*R);ad.lineTo(ab+(51/72)*T,af);ad.lineTo(ab+(21/72)*T,af);ad.lineTo(ab,X+(51/72)*R);ad.lineTo(ab,X+(21/72)*R);ad.lineTo(ab+(21/72)*T,X)}else{if(ah=="star"){var B=(ab+Z)/2;var i=Z-ab;var C=af-X;ad.moveTo(B,X);ad.lineTo(ab+(33/54)*i,X+(39/102)*C);ad.lineTo(Z,X+(39/102)*i);ad.lineTo(ab+(75/108)*i,X+(63/102)*C);ad.lineTo(ab+(87/108)*i,af);ad.lineTo(B,X+(39/51)*C);ad.lineTo(ab+(21/108)*i,af);ad.lineTo(ab+(33/108)*i,X+(63/102)*C);ad.lineTo(ab,X+(39/102)*C);ad.lineTo(ab+(21/54)*i,X+(39/102)*C);ad.lineTo(B,X)}else{if(ah=="pgL"){ad.moveTo(ab,af);ad.lineTo(Z,af);ad.lineTo(Z,X);ad.lineTo(ab+(Z-ab)/3,X);ad.lineTo(ab,X+(af-X)/4);ad.lineTo(ab,af)}else{if(ah=="pgR"){ad.moveTo(Z,af);ad.lineTo(ab,af);ad.lineTo(ab,X);ad.lineTo(ab+(Z-ab)*0.66,X);ad.lineTo(Z,X+(af-X)*0.25);ad.lineTo(Z,af)}else{if(ah=="pointrL"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(ab+(5/7)*T,X+(3/7)*R);ad.lineTo(ab+(5/7)*T,af);ad.lineTo(ab,X)}else{if(ah=="pointrR"){ad.moveTo(ab,X);ad.lineTo(Z,X);ad.lineTo(ab+(2/7)*T,af);ad.lineTo(ab+(2/7)*T,X+(3/7)*R);ad.lineTo(ab,X)}else{if(ah=="ldL"){ad.moveTo(ab,X);ad.lineTo(ab+2,X);ad.lineTo(Z,af);ad.lineTo(Z-2,af);ad.lineTo(ab,X)}else{if(ah=="ldR"){ad.moveTo(Z,X);ad.lineTo(Z-2,X);ad.lineTo(ab,af);ad.lineTo(ab+2,af);ad.lineTo(Z,X)}else{if(ah=="dropD"){ad.moveTo((ab+Z)/2,X);ad.lineTo(ab+T/6,(X+af)/2);ad.bezierCurveTo(ab-(T*(1.5/6)),af+(R/6.2),Z+(T*(1.5/6)),af+(R/6.2),ab+T*(5/6),(X+af)/2);ad.lineTo((ab+Z)/2,X)}else{if(ah=="dropU"){ad.moveTo((ab+Z)/2,af);ad.lineTo(ab+T/6,(X+af)/2);ad.bezierCurveTo(ab-(T*(1.5/6)),X-(R/6.2),Z+(T*(1.5/6)),X-(R/6.2),ab+T*(5/6),(X+af)/2);ad.lineTo((ab+Z)/2,af)}else{if(ah=="oval"){ad.moveTo(ab,(af+X)/2);ad.bezierCurveTo(ab+T*(1/4),X-(R/7),ab+T*(3/4),X-(R/7),Z,(af+X)/2);ad.bezierCurveTo(ab+T*(3/4),af+(R/7),ab+T*(1/4),af+(R/7),ab,(af+X)/2)}else{if(ah=="cloud"){ad.moveTo(ab+T*(1.5/9),af);ad.bezierCurveTo(ab,af,ab,X+R*(7/11),ab+T*(1.6/9),X+R*(7/11));ad.bezierCurveTo(ab+T/9,X+R/3,ab+T/3,X+R/6.3,ab+T*(4/9),X+R/3.2);ad.bezierCurveTo(ab+T*(4.5/9),X,ab+T*(7.4/9),X,ab+T*(7.3/9),(af+X)/2);ad.bezierCurveTo(Z,(af+X)/2,Z,af,ab+T*(7.7/9),af);ad.lineTo(ab+T*(1.5/9),af)}else{if(ah=="person"){ad.moveTo(ab,af);ad.bezierCurveTo((ab+Z)/16,(X+af)*(11/14),(ab+Z)*(3/16),(X+af)*(10/14),(ab+Z)*(6/16),(af+X)*(9/14));ad.bezierCurveTo((ab+Z)*(2.5/16),(X+af)*(4/7),(ab+Z)*(2.5/16),X,(ab+Z)/2,X);ad.bezierCurveTo((ab+Z)*(13.5/16),X,(ab+Z)*(13.5/16),(X+af)*(4/7),(ab+Z)*(10/16),(af+X)*(9/14));ad.bezierCurveTo((ab+Z)*(13/16),(X+af)*(10/14),(ab+Z)*(15/16),(X+af)*(11/14),Z,af);ad.lineTo(ab,af)}else{if(ah=="thumbsU"){ad.moveTo(ab,X+R*(16/17));ad.lineTo(ab,X+R*(15/34));ad.bezierCurveTo(ab+T*(2/15),X+R*(7/17),ab+T*(9/30),X+R*(4/17),ab+T/3,X+R*(3/34));ad.bezierCurveTo(ab+T*(5.2/15),X,ab+T*(9/15),X,ab+T*(8.5/15),X+R*(2/17));ad.lineTo(ab+T*(7/15),X+R*(11/34));ad.bezierCurveTo(ab+T*(9/15),X+R*(13/34),ab+T*(11/15),X+R*(13/34),ab+T*(12/15),X+R*(13/34));ad.bezierCurveTo(Z,X+R*(13/34),Z,X+R*(19/34),ab+T*(12/15),X+R*(19/34));ad.bezierCurveTo(ab+T*(14/15),X+R*(19/34),ab+T*(27/30),X+R*(12/17),ab+T*(23/30),X+R*(12/17));ad.bezierCurveTo(ab+T*(13/15),X+R*(12/17),ab+T*(25/30),X+R*(29/34),ab+T*(11/15),X+R*(29/34));ad.bezierCurveTo(ab+T*(25/30),X+R*(29/34),ab+T*(12/15),af,ab+T*(8.5/15),af);ad.bezierCurveTo((ab+Z)/2,af,ab+T/5,af,ab,X+R*(16/17))}else{if(ah=="thumbsD"){ad.moveTo(ab,X+R/17);ad.lineTo(ab,X+R*(19/34));ad.bezierCurveTo(ab+T*(2/15),X+R*(10/17),ab+T*(9/30),X+R*(13/17),ab+T/3,X+R*(31/34));ad.bezierCurveTo(ab+T*(5.2/15),af,ab+T*(9/15),af,ab+T*(8.5/15),X+R*(15/17));ad.lineTo(ab+T*(7/15),X+R*(23/34));ad.bezierCurveTo(ab+T*(9/15),X+R*(21/34),ab+T*(11/15),X+R*(21/34),ab+T*(12/15),X+R*(21/34));ad.bezierCurveTo(Z,X+R*(21/34),Z,X+R*(15/34),ab+T*(12/15),X+R*(15/34));ad.bezierCurveTo(ab+T*(14/15),X+R*(15/34),ab+T*(27/30),X+R*(5/17),ab+T*(23/30),X+R*(5/17));ad.bezierCurveTo(ab+T*(13/15),X+R*(5/17),ab+T*(25/30),X+R*(5/34),ab+T*(11/15),X+R*(5/34));ad.bezierCurveTo(ab+T*(25/30),X+R*(5/34),ab+T*(12/15),X,ab+T*(8.5/15),X);ad.bezierCurveTo(ab+T/2,X,ab+T/5,X,ab,X+R/17)}else{if(ah=="arcL"){var i=Z-ab;var C=af-X;var Y=(C>=(i*2))?i:C/2;ad.moveTo(ab+Y,X);ad.arcTo(ab,X,ab,X+Y,Y);ad.arcTo(ab,X+(2*Y),ab+Y,X+(2*Y),Y);ad.lineTo(ab+Y,X)}else{if(ah=="arcR"){var i=Z-ab;var C=af-X;var Y=(C>=(i*2))?i:C/2;ad.moveTo(ab,X);ad.arcTo(ab+Y,X,ab+Y,X+Y,Y);ad.arcTo(ab+Y,X+(2*Y),ab,X+(2*Y),Y);ad.lineTo(ab,X)}else{if(ah=="arcU"){var i=Z-ab;var C=af-X;var Y=(i>=(C*2))?C:i/2;ad.moveTo(ab,X+Y);ad.arcTo(ab,X,ab+Y,X,Y);ad.arcTo(ab+(2*Y),X,ab+(2*Y),X+(2*Y),Y);ad.lineTo(ab,X+Y)}else{if(ah=="arcD"){var i=Z-ab;var C=af-X;var Y=(i>=(C*2))?C:i/2;ad.moveTo(ab,X);ad.arcTo(ab,X+Y,ab+Y,X+Y,Y);ad.arcTo(ab+(2*Y),X+Y,ab+(2*Y),X,Y);ad.lineTo(ab,X)}else{if(ah=="folder"){var i=Z-ab;var C=af-X;ad.moveTo(ab+(3/8)*i,X+(2/15)*C);ad.lineTo(Z-L[1],X+(2/15)*C);ad.quadraticCurveTo(Z,X+(2/15)*C,Z,(X+(2/15)*C)+L[1]);ad.lineTo(Z,af-L[2]);ad.quadraticCurveTo(Z,af,Z-L[2],af);ad.lineTo(ab+L[3],af);ad.quadraticCurveTo(ab,af,ab,af-L[3]);ad.lineTo(ab,X+L[0]);ad.quadraticCurveTo(ab,X,ab+L[0],X);ad.lineTo(ab+(5/16)*i,X);ad.lineTo(ab+(3/8)*i,X+(2/15)*C)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if(ah=="speechRight"){ad.moveTo(Z-17,af);ad.lineTo(Z-96,af-13);ad.lineTo(ab,af-13);ad.lineTo(ab,X);ad.lineTo(Z,X);ad.lineTo(Z,af-13);ad.lineTo(Z-38,af-13);ad.lineTo(Z-17,af)}if(ah=="speechLeft"){ad.moveTo(ab+17,af);ad.lineTo(ab+96,af-13);ad.lineTo(Z,af-13);ad.lineTo(Z,X);ad.lineTo(ab,X);ad.lineTo(ab,af-13);ad.lineTo(ab+38,af-13);ad.lineTo(ab+17,af)}else{if(ah=="bubr"){right=H+i-1;bottom=J+C-2;tailSize=7;if(m.b){J=J+m.b[0]/2;H=H+m.b[0]/2;right=right-m.b[0]/2;bottom=bottom-m.b[0]/2}ad.moveTo(right-tailSize,bottom-7);ad.lineTo(right-tailSize,J+L[1]);ad.quadraticCurveTo(right-tailSize,J,right-L[1]-tailSize,J);ad.lineTo(H+L[0],J);ad.quadraticCurveTo(H,J,H,J+L[0]);ad.lineTo(H,bottom-L[3]);ad.quadraticCurveTo(H,bottom,H+L[3],bottom);ad.lineTo(right-19,bottom);ad.quadraticCurveTo(right-15,bottom-1,right-14,bottom-2);ad.quadraticCurveTo(right-7,bottom+1,right-1,bottom-2);ad.quadraticCurveTo(right-tailSize,bottom-3,right-tailSize,bottom-7)}else{if(ah=="bubl"){right=H+i-1;bottom=J+C-2;tailSize=7;if(m.b){J=J+m.b[0]/2;H=H+m.b[0]/2;right=right-m.b[0]/2;bottom=bottom-m.b[0]/2}ad.moveTo(right,bottom-L[2]);ad.lineTo(right,J+L[1]);ad.quadraticCurveTo(right,J,right-L[1],J);ad.lineTo(H+L[0]+tailSize,J);ad.quadraticCurveTo(H+tailSize,J,H+tailSize,J+L[0]);ad.lineTo(H+tailSize,bottom-6);ad.quadraticCurveTo(H+4,bottom-1,H+1,bottom-2);ad.quadraticCurveTo(H+2,bottom+2,H+13,bottom-2);ad.quadraticCurveTo(H+15,bottom,H+19,bottom);ad.lineTo(right-L[2],bottom);ad.quadraticCurveTo(right,bottom,right,bottom-L[2])}else{if(ah=="arrowL"||ah=="arrowR"||ah=="arrowU"||ah=="arrowD"){var ag=2;if(K.aCurve){ag=K.aCurve}var P=12;if(K.aSize){P=K.aSize}if(ah=="arrowL"){ad.moveTo(ab+P,X);ad.lineTo(Z-L[1],X);ad.quadraticCurveTo(Z,X,Z,X+L[1]);ad.lineTo(Z,af-L[2]);ad.quadraticCurveTo(Z,af,Z-L[2],af);ad.lineTo(ab+P,af);ad.bezierCurveTo(ab+P-ag,af,ab,((af+X)/2)+ag,ab,(af+X)/2);ad.bezierCurveTo(ab,((af+X)/2)-ag,P-ag+ab,X,ab+P,X)}else{if(ah=="arrowR"){ad.moveTo(ab+L[0],X);ad.lineTo(Z-P,X);ad.bezierCurveTo(Z-P+ag,X,Z,((X+af)/2)-ag,Z,(X+af)/2);ad.bezierCurveTo(Z,((X+af)/2)+ag,Z-P+ag,af,Z-P,af);ad.lineTo(ab+L[3],af);ad.quadraticCurveTo(ab,af,ab,af-L[3]);ad.lineTo(ab,X+L[0]);ad.quadraticCurveTo(ab,X,ab+L[0],X)}else{if(ah=="arrowD"){var F=(K.aW)?K.aW:F;var z=(ab+Z)/2;var aa=F/2;ad.moveTo(ab+L[0],X);ad.lineTo(Z-L[1],X);ad.quadraticCurveTo(Z,X,Z,X+L[1]);ad.lineTo(Z,af-P-L[2]);ad.quadraticCurveTo(Z,af-P,Z-L[2],af-P);ad.lineTo(z+aa,af-P);ad.lineTo(z,af);ad.lineTo(z-aa,af-P);ad.lineTo(ab+L[3],af-P);ad.quadraticCurveTo(ab,af-P,ab,af-P-L[3]);ad.lineTo(ab,X+L[0]);ad.quadraticCurveTo(ab,X,ab+L[0],X)}else{if(ah=="arrowU"){var F=(K.aW)?K.aW:20;var z=(ab+Z)/2;var aa=F/2;ad.moveTo(ab+L[0],X+P);ad.lineTo(z-aa,X+P);ad.lineTo(z,X);ad.lineTo(z+aa,X+P);ad.lineTo(Z-L[1],X+P);ad.quadraticCurveTo(Z,X+P,Z,X+P+L[1]);ad.lineTo(Z,af-L[2]);ad.quadraticCurveTo(Z,af,Z-L[2],af);ad.lineTo(ab+L[2],af);ad.quadraticCurveTo(ab,af,ab,af-L[3]);ad.lineTo(ab,X+P+L[0]);ad.quadraticCurveTo(ab,X+P,ab+L[3],X+P)}}}}}else{if(ah=="c"){var V=i/2,U=C/2,I=Math.min(V,U),S=Math.min(G|0,I),Y=I-S/2;d=S;ad.arc(H+V,J+U,Y,0,Math.PI*2,true)}}}}}ad.closePath()},_gradient:function(B,D,y){var x=["#ffffff","#000000"];var A=[0,1];if(y.bgc&&y.bgd){x=y.bgc;A=y.bgd}for(var z=0;z<x.length&&z<A.length;z++){try{B.addColorStop(A[z],x[z])}catch(C){}}D.fillStyle=B;D.fill()},_glaze:function(B,z){var F=5,C=q.useOneCanvas?2+z.box[1]:2,y=q.useOneCanvas?10+z.box[0]:10,x=z.box[2]-27,E=10,i=0,D=7;if(z.s=="bubl"){y+=D}l.path(B,"sq",F,C,y,x,E,i,z);var A=B.createLinearGradient(0,C+E,0,C);A.addColorStop(0,"rgba(231, 231, 231, 0.2)");A.addColorStop(0.59,"rgba(240, 240, 240, 0.25)");A.addColorStop(1,"rgba(249, 249, 249, 0.3)");B.fillStyle=A;B.fill();B.restore()},_shadow:function(x,i){x.shadowColor=i.sh[0];x.shadowOffsetX=i.sh[1];x.shadowOffsetY=i.sh[2];x.shadowBlur=i.sh[3]},_effect:function(J,D){var x=D.fx;for(var E=0;E<x.length;E++){var G=x[E];if(G[0]=="dots"){var N=G[1];var H=G[2];var M=G[3];J.fillStyle=G[4];var z=D.box[2];var y=D.box[3];var K=N+H;var F=N+M;var L=parseInt(z/K)+1;var I=parseInt(y/F)+1;var C=0;for(var B=0;B<I;B++){C=(C)?0:N;for(var A=0;A<L;A++){J.beginPath();J.arc((A*K)+C,(B*F),N/2,0,2*Math.PI);J.closePath();J.fill()}}}}},_setImage:function(y,i){try{y.drawImage(y.canvas,0,0)}catch(x){}}};var j=this.renderingMode==="singlepage"?0:m.box[0];var n=this.renderingMode==="singlepage"?0:m.box[1];var p=m.box[2];var o=m.box[3];var v=0;var h=0;var r=m.b;var d=null;if(r){v=r[0];h=r.length>3?r.slice(2):r[2]}var f=m.s?m.s:"sq";u.save();if(!this.skipImages&&storage.get(m.id)){l.blur()}l.path(u,f,h,n,j,p,o,v,m);if(m.sh){l._shadow(u,m)}if(m.bg){l.background(u,m)}u.restore();if(r&&v>0){l.border(u,m,p,o)}if(m.glaze&&m.glaze=="y"){l._glaze(u,m)}if(m.fx&&m.fx.length>0){l._effect(u,m)}if(m.i){for(var s=0;s<m.i.length;s++){var t=m.i[s];var w=new Image();function e(){var i=t[5];if(typeof(i)=="string"&&i.search("%")!=-1){i=(p*parseInt(i)/100)-t[3]/2}else{if(i<0){i=parseInt(p)+t[5]-t[3]}}var c=t[6];if(typeof(c)=="string"&&c.search("%")!=-1){c=(o*parseInt(c)/100)-t[4]/2}else{if(c<0){c=parseInt(o)+t[6]-t[4]}}if(q.imagesLoaded[t[0]]){u.drawImage(q.imagesLoaded[t[0]],t[1],t[2],m.box[2],m.box[3],i+j,c+n,m.box[2],m.box[3])}else{w.onload=function(){try{u.drawImage(w,t[1],t[2],m.box[2],m.box[3],i+j,c+n,m.box[2],m.box[3]);if(u.canvas.hasOwnProperty("onchange")){u.canvas.onchange()}}catch(x){}};w.src=t[0]}}$(w).ready(e)}}else{}if(!this.useCanvas){k=this.canvasToImg(k)}return k};this.canvasToImg=function(d){var c=d.get(0).toDataURL("image/png");return $('<img src="'+c+'">')};this.renderOne=function(c,i,e){var h={$rendition:{},childWidgets:[]};if(!c.box){c.box=this.calculateBox(c,i,e)}if(fluid.widget.isShapeWidget(c)){h.$shapeRendition=this.paintCanvas(c)}if(fluid.widget.isUploadWidget(c)){}if(fluid.widget.isTextWidget(c)){h.$textRendition=this.renderText(c)}if(fluid.widget.hasChildWidgets(c)){var f=fluid.wdgProvider.getChildWidgets(c,true);for(var d=0;d<f.length;d++){h.childWidgets.push(this.renderOne(f[d],c,c.ad[d]))}}if(fluid.widget.hasSegments(c)){h.segments=this.renderSegments(c)}if(!h.childWidgets.length){delete h.childWidgets}return h};this.renderSegments=function(d){var e=[];var c=[];for(var f=0;f<d.sc;f++){if(d.segments&&d.segments.length){e.push({wdgObj:storage.get(d.segments[f].id),box:[]})}else{e.push({wdgObj:fluid.wdgProvider.getById(d.seg[f%d.seg.length]),box:[]})}}for(f=0;f<e.length;f++){if(e[f].wdgObj.wh){e[f].wdgObj.tlwh=[0,0,e[f].wdgObj.wh[0],e[f].wdgObj.wh[1]]}if(e[f].wdgObj.tlwh&&typeof(e[f].wdgObj.tlwh[2])==="number"){e[f].box[2]=e[f].wdgObj.tlwh[2]}else{if(e[f].wdgObj.tlwh){if(e[f].wdgObj.tlwh&&e[f].wdgObj.tlwh[2]==="a"){e[f].box[2]=d.box[2]/d.sc}else{if(e[f].wdgObj.tlwh[2].indexOf("%")!==-1){e[f].box[2]=(parseFloat(e[f].wdgObj.tlwh[2])/100)*d.box[2]}}}}if(e[f].wdgObj.tlwh&&typeof(e[f].wdgObj.tlwh[3])==="number"){e[f].box[3]=e[f].wdgObj.tlwh[3]}else{if(e[f].wdgObj.tlwh){if(e[f].wdgObj.tlwh&&e[f].wdgObj.tlwh[3]==="a"){e[f].box[3]=d.box[3]/d.sc}else{if(e[f].wdgObj.tlwh[3].indexOf("%")!==-1){e[f].box[3]=(parseFloat(e[f].wdgObj.tlwh[3])/100)*d.box[3]}}}}}if(d.sl=="h"){if(d.sa=="tl"||!d.sa){for(f=0;f<e.length;f++){e[f].box[0]=(f*(d.box[2]/d.sc));e[f].box[1]=0+d.sp[1]}}else{if(d.sa=="d"){for(f=0;f<e.length;f++){e[f].box[0]=(f*(d.box[2]/d.sc))+Math.max(d.box[2]/d.sc-e[f].box[2],0)/2;e[f].box[1]=(d.box?d.box[1]:0)+d.sp[1]}}}}else{for(f=0;f<e.length;f++){e[f].box[0]=d.box?d.box[0]:0;e[f].box[1]=(d.box?d.box[1]:0)+(f*e[f].box[3])}}for(f=0;f<e.length;f++){if(f===0&&e[f].wdgObj.bts){e[f].wdgObj.b=e[f].wdgObj.bts}else{if(f===e.length-1&&e[f].wdgObj.bbs){e[f].wdgObj.b=e[f].wdgObj.bbs}else{if(e[f].wdgObj.bms&&d.sl==="v"){e[f].wdgObj.b=e[f].wdgObj.bms}}}if(f===0&&e[f].wdgObj.bls){e[f].wdgObj.b=e[f].wdgObj.bls}else{if(f===e.length-1&&e[f].wdgObj.brs){e[f].wdgObj.b=e[f].wdgObj.brs}else{if(e[f].wdgObj.bms&&d.sl==="h"){e[f].wdgObj.b=e[f].wdgObj.bms}}}e[f].wdgObj.box=e[f].box;c.push(this.renderOne(e[f].wdgObj))}return c};this.renderRecursive=function(d,h){var f={};if(d.length){var c=[];for(var e=0;e<d.length;e++){this.generateCanvas(d[e].originId);f=this.renderOne(d[e],h);c.push(f)}}else{this.generateCanvas(d.originId);f=this.renderOne(d,h)}return c||f};this.onPageRenderFinish=function(f){this.renderingQueue[f]=null;if(this.afterPageRendered){var j=this.canvases[f].get(0).toDataURL("image/png");this.afterPageRendered(f,j,1,false)}else{var h=[];var e=fluid.main.project.id;var j=this.canvases[f].get(0).toDataURL("image/jpeg",0.5);var i=$("#"+f+"canvas.page-preview");var d=storage.get(f);var c=storage.get(f,{returnModel:true});if(!c){return}c.set({imgData:j});if(fluid.main.project.useLocalDb){h.push({id:f,data:j,project:e})}requestAnimationFrame(function(){if(!storage.get(f)||!storage.get(f).widgets||storage.get(f).widgets.length===0){return}var k=$('<img class="page-preview" src="'+j+'">');var l=new Image();l.src=j;k.insertAfter(i);setTimeout(function(){i.remove()}.bind(i),650);l.onload=function(){var n=$("#scaled-"+f);var m=fluid.zoom.getAllPagesParams().newScale;n.get(0).innerHTML="";$("#scaled-"+f).append(l);n.css({top:d.y*m,left:d.x*m,width:d.width*m,height:d.height*m})}.bind(this)}.bind(this));if(fluid.main.project.useLocalDb){dbStorage.set("rastPages",h)}}};this.onRenderFinish=function(){if(typeof window.callPhantom==="function"){$("#canvas").css({top:(-this.cropping.y+15)+"px",left:(-this.cropping.x+15)+"px"});window.callPhantom({event:"finishedrendering",cropping:this.cropping})}else{if(!this.afterPageRendered){var d=[];var c=fluid.main.project.id;$("canvas.page-preview").each(function(){var h=$(this).parents(".screen").attr("id");var f=storage.get(h);if(!f||!f.widgets||!f.widgets.length){return}var i=$(this).get(0).toDataURL("image/jpeg",0.5);var e=storage.get(h,{returnModel:true});e.set({imgData:i});requestAnimationFrame(function(){var j=$('<img class="page-preview" src="'+i+'">');j.insertAfter($(this));setTimeout(function(){$(this).remove()}.bind(this),500)}.bind(this))})}}};this.countRemainingLoads=function(d){var e=0;if(d){for(var f in this.imagesToLoad[d]){e++}for(var f in this.uploadsToLoad[d]){e++}return e}else{for(var d in this.imagesToLoad){if(this.imagesToLoad.hasOwnProperty(d)){for(var c in this.imagesToLoad[d]){if(this.imagesToLoad[d].hasOwnProperty(c)){e++}}}}for(var d in this.uploadsToLoad){if(this.uploadsToLoad.hasOwnProperty(d)){for(var c in this.uploadsToLoad[d]){if(this.uploadsToLoad[d].hasOwnProperty(c)){e++}}}}return e}};this.onImgLoadErr=function(f,l,e){if(!e.src||e.src.indexOf("data/img")!==-1){if(this.imagesToLoad[f][l]){delete this.imagesToLoad[f][l]}if(this.uploadsToLoad[f][l]){delete this.uploadsToLoad[f][l]}var j=this.countRemainingLoads(f);if(j===0){for(var h=0;h<this.renderingQueue[f].length;h++){var d=this.renderingQueue[f][h];if(fluid.widget.isShapeWidget(d)){this.paintCanvas(d,this.canvases[f])}if(fluid.widget.isUploadWidget(d)){this.renderUpload(d,this.canvases[f],this.imagesLoaded[d.data])}if(fluid.widget.isTextWidget(d)){this.renderText(d,this.canvases[f])}}if(this.countRemainingLoads()===0){this.onRenderFinish()}}var c=this.countRemainingLoads();fluid.main.fire("image.loaded",{step:c,countdown:true});if(c==0){fluid.main.fire("images.loaded");this.onPageRenderFinish(f)}return}var k=new Image();k.onload=this.onImgLoad.bind(this,f,l);k.onerror=this.onImgLoadErr.bind(this,f,l);k.src="data/img/"+l};this.onImgLoad=function(e,c,k){this.imagesLoaded[c]=k;if(this.imagesToLoad[e][c]){delete this.imagesToLoad[e][c]}if(this.uploadsToLoad[e][c]){delete this.uploadsToLoad[e][c]}var f=this.countRemainingLoads(e);if(f===0){for(var j=0;j<this.renderingQueue[e].length;j++){var h=this.renderingQueue[e][j];if(fluid.widget.isShapeWidget(h)){this.paintCanvas(h,this.canvases[e])}if(fluid.widget.isUploadWidget(h)){this.renderUpload(h,this.canvases[e],this.imagesLoaded[h.data])}if(fluid.widget.isTextWidget(h)){this.renderText(h,this.canvases[e])}}this.onPageRenderFinish(e);if(this.countRemainingLoads()===0){this.onRenderFinish()}}var l=fluid.main.uploads&&fluid.main.uploads.get(c);var m=fluid.main.project;if(l&&c.indexOf("i_")===0&&window.uploadsCache&&!window.uploadsCache[c]){if(!fluid.main.project.uploadCanvas||utils.isTaintedCanvas(m.uploadCanvas)){m.uploadCanvas=document.createElement("canvas")}m.uploadCanvas.width=k.naturalWidth;m.uploadCanvas.height=k.naturalHeight;m.uploadCanvasCtx=m.uploadCanvas.getContext("2d");m.uploadCanvasCtx.drawImage(evt.target,0,0);var d=m.uploadCanvas.toDataURL("image/png");if(l&&d){l.set({imgData:d})}}var n=this.countRemainingLoads();fluid.main.fire("image.loaded",{step:n,countdown:true});if(n==0){fluid.main.fire("images.loaded")}};this.pageRenderOne=function(e){var i={$rendition:{}};if(!this.skipImages){var d=this.countRemainingLoads()==0;if(!this.imagesToLoad[this.pageId]){this.imagesToLoad[this.pageId]={}}if(!this.uploadsToLoad[this.pageId]){this.uploadsToLoad[this.pageId]={}}var f=false;if(e.i&&!this.imagesToLoad[this.pageId][e.i[0][0]]){f=true}if(e.upload==="y"&&!this.uploadsToLoad[this.pageId][e.data]){f=true}if(f||this.renderingQueue[this.pageId].length>0){if(e.i&&!this.imagesToLoad[this.pageId][e.i[0][0]]){var c=new Image();this.imagesToLoad[this.pageId][e.i[0][0]]=true;c.onload=this.onImgLoad.bind(this,this.pageId,e.i[0][0],c);c.onerror=this.onImgLoadErr.bind(this,this.pageId,e.i[0][0],c);c.src=e.i[0][0];if(d){fluid.main.fire("images.loading")}}else{if(e.upload==="y"&&!this.uploadsToLoad[this.pageId][e.data]){var h=storage.get(e.data);this.uploadsToLoad[this.pageId][e.data]=e.id;if(window.uploadsCache&&window.uploadsCache[e.data]){c.src=uploadsCache[e.data]}else{fluid.upload.get({id:e.data,callback:function(l,q,r){if(r.success){var n=new Image();n.onload=this.onImgLoad.bind(this,l,q,n);n.onerror=this.onImgLoadErr.bind(this,l,q,n);var o=atob(r.imgData.split(";base64,")[1]);var p=new Array(o.length);for(var m=0;m<o.length;m++){p[m]=o.charCodeAt(m)}var k=new Uint8Array(p);var j=new Blob([k],{type:"image/png"});n.src=URL.createObjectURL(j);if(d){fluid.main.fire("images.loading")}}else{var n=new Image();this.onImgLoadErr.call(this,l,q,n)}}.bind(this,this.pageId,e.data),priority:fluid.upload.priority.pageZoomedOut})}}}this.renderingQueue[this.pageId].push(e);i.$shapeRendition=this.canvas;return i}}if(fluid.widget.isShapeWidget(e)||e.segments){i.$shapeRendition=this.paintCanvas(e)}if(!this.skipImages&&fluid.widget.isUploadWidget(e)){i.$shapeRendition=this.renderUpload(e)}if(fluid.widget.isTextWidget(e)){i.$textRendition=this.renderText(e)}return i};this.calculatePageBox=function(c,d){return storage.get(d,{returnModel:true}).getBox()};this.exceedsPage=function(d,c){if(d.box==undefined){return false}if(d.box[0]<0||d.box[1]<0){return true}if(d.box[0]+d.box[2]>c.width){return true}if(d.box[1]+d.box[3]>c.height){return true}return false};this.renderPage=function(d,c,f){if(this.renderingQueue[d.id]&&this.renditions[d.id]){return this.renditions[d.id]}else{this.renderingQueue[d.id]=[]}if(this.finishTimeout){clearTimeout(this.finishTimeout);delete this.finishTimeout}var i={};var e=[];var h=[];for(var j in d.widgets){d.widgets[j].id=j;d.widgets[j].box=this.calculatePageBox(d,j);if(!f){if(this.useOneCanvas&&this.exceedsPage(d.widgets[j],d)){h.push(j)}}}this.setCropping(d);this.generateCanvas(d.id);this.pageId=d.id;i=this.pageRenderOne({st:"b",ca:"tl",bg:"c",bgc:["#ffffff"],box:[0,0,this.canvasSize[0],this.canvasSize[1]],wg:[1],id:"dummy-bg-"+(new Date().getTime())});e.push(i);for(var j in d.widgets){if(d.widgets[j].st&&d.widgets[j].st==="b"){i=this.pageRenderOne(d.widgets[j]);i.id=j;i.lockTo=d.widgets[j].lockTo;i.box=d.widgets[j].box;e.push(i)}}for(var j in d.widgets){if((!d.widgets[j].st||d.widgets[j].st!=="b")&&!(c&&d.widgets[j].dm==="t")){i=this.pageRenderOne(d.widgets[j]);i.id=j;i.lockTo=d.widgets[j].lockTo;i.box=d.widgets[j].box;e.push(i)}}if(this.countRemainingLoads(d.id)===0){this.onPageRenderFinish(d.id)}if(this.countRemainingLoads()===0){this.finishTimeout=setTimeout(this.onRenderFinish.bind(this),200)}this.renditions[d.id]=e;return e};this.preparePage=function(e){var d=$.extend({id:e},storage.get(e));d.widgets=d.widgets.reduce(function(h,f){h[f]=$.extend({},storage.get(f));h[f].id=f;return h},{});for(var c in d.widgets){d.widgets[c].box=this.calculatePageBox(d,c)}return d},this.renderWdg=function(k,f){var c;var j=[0,0];f=$.extend({},f);f.widgets={};this.renderingQueue[k]=[];this.pageId=k;for(var d=0;f.ad&&d<f.ad.length;d++){c=f.ad[d][0];var e={wh:[widgets.summary[c].wh[0],widgets.summary[c].wh[1]]};(e.wh[0]=="a")&&(e.wh[0]="100%");(e.wh[1]=="a")&&(e.wh[1]="100%");e.tlwh=[f.ad[d][2],f.ad[d][1],e.wh[0],e.wh[1]];f.widgets[c]={id:c,box:this.calculateBox(e)};f.widgets[c]=$.extend(f.widgets[c],widgets.summary[c]);delete f.widgets[c].blur;j[0]=Math.max(j[0],f.widgets[c].box[0]+f.widgets[c].box[2]);j[1]=Math.max(j[1],f.widgets[c].box[1]+f.widgets[c].box[3])}var h=Math.max(j[0],j[1]);this.generateCanvas(k,{width:h,height:h});for(var d=0;f.ad&&d<f.ad.length;d++){this.renderSubWdg(f.widgets[f.ad[d][0]])}if(this.countRemainingLoads(k)===0){this.onPageRenderFinish(k)}},this.renderSubWdg=function(d){this.pageRenderOne(d);if(d.ad&&d.ad.length){var e,c;for(var f=0;f<d.ad.length;f++){e=d.ad[f][0];c=$.extend({},widgets.summary[e]);c.id=e;c.box=this.calculateBox(c,d,d.ad[f]);c.blur=false;this.renderSubWdg(c)}}else{if(d.sc){this.renderSegments(d)}}};this.renderWidgetsBelow=function(e,h,k){h=h||this.preparePage(this.pageId);var d=0,n=storage.get(h.id).widgets,f=n.length,c=this.ctx;for(;d<f;d++){if(n[d]===e){break}var l=h.widgets[n[d]];if(!l.dm){if((fluid.widget.isUploadWidget(l)||l.i)&&k){var j=document.getElementById(n[d]),m=j?(j.querySelector("img")||j.querySelector("canvas")):null;if(m){c.drawImage(m,l.box[0],l.box[1],l.box[2],l.box[3])}}else{this.pageRenderOne(l)}}}if(this.countRemainingLoads(h.id)===0){this.onPageRenderFinish(h.id)}if(this.countRemainingLoads()===0){this.finishTimeout=setTimeout(this.onRenderFinish.bind(this),200)}};this.onProjectUnloaded=function(c){if(!this.canceledPreview){this.canceledPreview=[]}this.canceledPreview.push(c)};this.renderProjectPreview=function(t,m){t=$.extend({},t);if(this.currentProjectId&&t[this.currentProjectId]){return}this.previewSize={width:205,height:160};var A=$("<canvas></canvas>");var k=A.get(0).getContext("2d");this.canvas=A;var n=$('<canvas class="project-preview" width="'+this.previewSize.width+'" height="'+this.previewSize.height+'"></canvas>').css({position:"relative"});var v=n.get(0).getContext("2d");var l;var q;var c={};var z={};for(var h in t){if(t.hasOwnProperty(h)){if(h.indexOf("w_")===0||(h.indexOf("w")===0&&h.length==33)){z[h]=$.extend({},t[h])}else{if(h.indexOf("x_")===0||(h.indexOf("x")===0&&h.length==33)){c[h]=$.extend({},t[h])}else{if(h.indexOf("p_")===0||(h.indexOf("p")===0&&h.length==33)){l=$.extend({},t[h]);q=h}}}}}this.lastProjectId=q;this.currentProjectId=q;var p=l.pages;if(!p){m.call(this,q,n);this.currentProjectId=null;return}var d;var B={x:l.canvasWidth,y:l.canvasHeight,x2:0,y2:0};for(var x=0;x<p.length;x++){d=c[p[x]];if(!d){continue}if(d.x<B.x){B.x=d.x}if(d.y<B.y){B.y=d.y}if(d.x+d.width>B.x2){B.x2=d.x+d.width}if(d.y+d.height>B.y2){B.y2=d.y+d.height}}var C={x:this.previewSize.width/(B.x2-B.x),y:this.previewSize.height/(B.y2-B.y)};C.x=Math.min(C.x,C.y);C.y=Math.min(C.x,C.y);this.skipImages=true;var f=[];for(var x=0;x<p.length;x++){if(!c[p[x]]){continue}var d=$.extend({},c[p[x]]);f.push(d);if(d.widgets&&d.widgets.length>0){var y={};for(var w=0;w<d.widgets.length;w++){y[d.widgets[w]]=z[d.widgets[w]]}}d.widgets=d.widgets.length>0?y:[];d.id=p[x];this.canvasSize=[d.width||320,d.height||480];if(!this.widgetsCache){this.widgetsCache={}}if(!this.pagesCache){this.pagesCache={}}for(var h in d.widgets){if(d.widgets.hasOwnProperty(h)&&d.widgets[h]){d.widgets[h].id=h;d.widgets[h].box=this.calculatePageBox(d,h);this.widgetsCache[h]=d.id}}this.pagesCache[d.id]=d}var e=$.extend({},l.links);var u;var o;var r;for(var x=0;x<e.linkDest.length;x++){if(!this.pagesCache||!this.pagesCache[e.linkDest[x]]){continue}u=this.widgetsCache[e.linkOrigin[x]];if(u===undefined){continue}o={x:this.pagesCache[u].x+this.pagesCache[u].width*0.5,y:this.pagesCache[u].y+this.pagesCache[u].height*0.5};o.x=(o.x-B.x)*C.x;o.y=(o.y-B.y)*C.y;r={x:this.pagesCache[e.linkDest[x]].x+this.pagesCache[e.linkDest[x]].width*0.5,y:this.pagesCache[e.linkDest[x]].y+this.pagesCache[e.linkDest[x]].height*0.5};r.x=(r.x-B.x)*C.x;r.y=(r.y-B.y)*C.y;v.beginPath();v.strokeStyle="#009ecc";v.moveTo(o.x,o.y);v.lineTo(r.x,r.y);v.stroke()}function s(E){d=f[E];A.attr({width:d.width,height:d.height});k.fillStyle="#ffffff";k.fillRect(0,0,d.width,d.height);this.canvasSize=[d.width||320,d.height||480];for(var G in d.widgets){if(d.widgets.hasOwnProperty(G)&&d.widgets[G]){d.widgets[G].id=G;d.widgets[G].box=this.calculatePageBox(d,G)}}v.fillStyle="#ffffff";v.fillRect((d.x-B.x)*C.x,(d.y-B.y)*C.y,d.width*C.x,d.height*C.y);var j=storage.get(f[E].id,{returnModel:true});var F=j?j.get("imgData"):null;if(!j||!F){for(var G in d.widgets){if(d.widgets.hasOwnProperty(G)&&d.widgets[G]){if(d.widgets[G].st&&d.widgets[G].st==="b"){this.pageRenderOne(d.widgets[G])}}}for(var G in d.widgets){if(d.widgets.hasOwnProperty(G)&&d.widgets[G]){if(!d.widgets[G].st||d.widgets[G].st!=="b"){if(!j||!j.getBox()){page.calculateWdgPositions(d.id)}this.pageRenderOne(d.widgets[G])}}}}var D=new Image();if(!j||!F){D.src=A.get(0).toDataURL("image/jpeg")}else{D.src=F}D.onload=(function(K,I,M,L,H,J){v.drawImage(K,I,M,L,H);if(this.canceledPreview&&this.canceledPreview.indexOf(q)!==-1){var i=this.canceledPreview.indexOf(q);this.canceledPreview[i]=null}else{if(E<f.length-1){setTimeout(s.bind(this,E+1),100)}else{fluid.main.fire("thumbnailReady",q,n.get(0));m.call(this,q,n);this.currentProjectId=null}}}).bind(this,D,(d.x-B.x)*C.x,(d.y-B.y)*C.y,d.width*C.x,d.height*C.y,d.id)}if(f.length>0){setTimeout(s.bind(this,0),200)}else{m.call(this,q,n);this.currentProjectId=null}return n};this.flattenRenditions=function(d){if(d.length){var e=[];for(var c=0;c<d.length;c++){e.push(this.flattenRendition(d[c]))}return e}else{return[this.flattenRendition(d)]}};this.flattenRendition=function(d){var h=[];var f=d.childWidgets;var c=d.segments;h.push(d.$rendition);if(f&&f.length){for(var e=0;e<f.length;e++){h=h.concat(this.flattenRendition(f[e]))}}if(c&&c.length){for(e=0;e<c.length;e++){h=h.concat(this.flattenRendition(c[e]))}}return h}};