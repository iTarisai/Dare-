var model=require("../fluid.model");var collection=require("../fluid.collection");var page=require("./page");var wdg=require("./widget");var wdgGroup=require("./widgetGroup");var link=require("./link");var dbStorage=require("../../class-dbStorage");if(!fluid.models){fluid.models={}}fluid.models.project=fluid.Model.extend({attrBlackList:["visiblePages","uniqueUploads"],silentSyncAttrs:["updated","saved","preview","canvasPosX","canvasPosY","currentZoom","visiblePages","uniqueUploads"],silentSaveAttrs:["updated","saved","currentZoom"],initialize:function(a,b){if(!this.get("id")){if(b.projectId){this.set("id",b.projectId);this.id=b.projectId}}if(!this.pages){this.pages=new fluid.Pages(null,{projectModel:this})}if(!this.widgets){this.widgets=new fluid.Widgets(null,{projectModel:this})}if(!this.links){this.links=new fluid.Links(null,{projectModel:this})}if(!this.wdgGroups){this.wdgGroups=new fluid.WidgetGroups(null,{projectModel:this})}if(b&&b.syncOnChange!==false){this.pages.on("all",this.onChange,this);this.widgets.on("all",this.onChange,this);this.widgets.on("add",this.addUniqueUpload,this);this.widgets.on("remove",this.removeUniqueUpload,this);this.links.on("all",this.onChange,this);this.on("all",this.onChange,this);this.on("change:uniqueUploads",this.updateLibrary,this);this.on("change:name",this.updateLibraryTab,this);this.save();fluid.api.on("apicallsuccess",function(d,c){if(c.type==="projectSync"&&c.objectId===this.get("id")){this.synced=true}})}this.synced=false;fluid.main.on("thumbnailReady",function(c,d){if(d===this.id){this.modifiedSinceThumb=false}},this)},defaults:{uniqueUploads:[]},isSynced:function(){return this.synced},setModified:function(a){if(a===true||a===false){this.synced=!a}},onChange:function(e,b){if(!b.changedAttributes){return}var a=b.changedAttributes(),d,c;if(a){a=_.keys(a);d=_.difference(a,this.silentSyncAttrs);c=_.difference(a,this.silentSaveAttrs);if(d.length){this.setModified(true);this.synced=false;this.modifiedSinceThumb=true;fluid.main.fire("api:projectModelChanged")}if(c.length){if(!this.debouncedSave){this.debouncedSave=_.debounce(this.save,50)}this.debouncedSave.apply(this,arguments)}}},addUniqueUpload:function(c,a){var d=a.attributes.data;if(d){var b=_.clone(this.get("uniqueUploads"));if(b.indexOf(d)===-1){b.push(d);this.set({uniqueUploads:b})}}},removeUniqueUpload:function(b,a){var f=a.attributes.data;if(f){var e=a.id;var d=this.widgets.find(function(g){return(g.id!==e&&g.attributes.data&&g.attributes.data===f)});if(!d){var c=this.get("uniqueUploads");c=_.without(c,f);this.set({uniqueUploads:c})}}},updateLibrary:function(c){var b=c.previousAttributes().uniqueUploads;var a=c.attributes.uniqueUploads;var d;if(b.length<a.length){d=_.difference(a,b);d.forEach(function(e){fluid.main.trigger("projectTab.uploadAdded",{projectId:c.id,uploadId:e})})}else{if(b.length>a.length){d=_.difference(b,a);d.forEach(function(e){fluid.main.trigger("projectTab.uploadRemoved",{projectId:c.id,uploadId:e})})}}fluid.main.trigger("projectTab.setCounter",{projectId:c.id,count:a.length})},updateLibraryTab:function(a){fluid.main.trigger("projectTab.changeNameOfActiveTab",{id:a.attributes.id,name:a.attributes.name})},save:function(b){var a=this.bundle({getAll:true});dbStorage.set("projects",{id:this.id,data:a},function(){if(b&&b.call){b()}})},parse:function(n,a){var p;if(typeof n==="string"){n=JSON.parse(n)}if(a.projectId&&n[a.projectId]){p=n[a.projectId];p.id=a.projectId}else{var e=this.findProjectInBundle(n)[1];p=e[1];p.id=e[0]}var b=p.pages,g,k=[],o=[],t,r,s,u,m,v,d,c;if(b&&b.length){for(t=0,r=b.length;t<r;t++){m=b[t];if(!m){continue}if(n[m]){d=_.clone(n[m]);d.id=m;k.push(d);g=d.widgets;if(g.length){for(s=0,u=g.length;s<u;s++){v=g[s];if(n[v]&&n[v].lockTo&&!n[n[v].lockTo]){n[v]=null}if(n[v]&&n[v].of&&!n[n[v].of]){n[v]=null}if(fluid.main.uploads&&n[v]&&n[v].data&&!(n.uploads[n[v].data]&&fluid.main.uploads.get(n[v].data))){n[v]=null}if(n[v]){c=_.clone(n[v]);c.id=v;c.pageId=m;o.push(c)}else{g.splice(s,1);s--;u--}}}}else{b.splice(t,1);t--}}p.pages=b}else{p.pages=[]}if(p.homepage&&!n[p.homepage]){if(k.length){p.homepage=k[0].id}else{p.homepage=false}}this.pages=new fluid.Pages(k,{comparator:false,projectModel:this});this.widgets=new fluid.Widgets(o,{comparator:false,projectModel:this});var f=[],q,h;for(h in p.widgetGroups){if(p.widgetGroups.hasOwnProperty(h)){q={id:h,widgets:p.widgetGroups[h]}}f.push(q)}this.wdgGroups=new fluid.WidgetGroups(f,{comparator:false});this.links=new fluid.Links(null,{comparator:false});if(p.links){this.links.deserialize(p.links)}return p},get:function(b,f){var g=b.substr(0,1),c=f&&f.returnModel?true:false;if(b.substr(1,1)!=="_"&&this.attributes[b]!==undefined){return this.attributes[b]}else{if(g==="x"){var a=this.pages.get(b);if(!a){return false}return c?a:a.toJSON(f)}else{if(g==="w"){var e=this.widgets.get(b);if(!e){return false}return c?e:e.toJSON(f)}else{if(g==="l"){var d=this.links.get(b);if(!d){return false}return c?d:d.toJSON(f)}else{if(g==="p"){return c?this:this.toJSON(f)}}}}}},setChild:function(h,f){var a=h.substr(0,1);var b,e;if(a==="x"){e=this.pages;f.id=h;b=this.pages.get(h)}else{if(a=="w"){e=this.widgets;f.id=h;b=this.widgets.get(h)}else{if(a=="l"){e=this.links;b=this.links.get(h)}}}if(b){var d=_.clone(b.attributes);for(var g in d){if(typeof f[g]==="undefined"&&d.hasOwnProperty(g)){var c=["id","pageId","box","imgData"];if(c.indexOf(g)!==-1){b.unset(g,{silent:true})}}}b.set(f)}else{e.add(f)}},isEmpty:function(){return this.pages.length===0},isReadOnly:function(){return this.get("active")===false?true:false},isMultiOrientation:function(){var b=this.pages&&this.pages.models;var c=this.get("orientation");var a=false;_.each(b,function(d){if(d.attributes.orientation!==c){a=true}});return a},hasLinks:function(){return(this.links&&this.links.length)?true:false},findProjectInBundle:function(a){for(var b in a){if(a.hasOwnProperty(b)&&b.substr(0,2)==="p_"){return[b,a[b]]}}return false},bundle:function(b){var a={};a[this.attributes.id]=this.toJSON(b);if(this.links){_.extend(a[this.attributes.id],{links:this.links.toJSON(b)})}_.extend(a,this.pages?this.pages.toJSON(b):{});_.extend(a,this.widgets?this.widgets.toJSON(b):{});a.uploads={};if(this.widgets){this.widgets.each(function(d,c,g){if(!d.attributes.upload){return}var f=d.toJSON(),e;e=fluid.main.uploads.get(f.data).toJSON();a.uploads[f.data]=_.pick(e,"type","wh","title")},this)}return a}});fluid.Projects=fluid.Collection.extend({model:fluid.models.project,initialize:function(b,a){},getLatestActiveProject:function(){var a=this.map(function(b){if(b.get("active")||b.get("unloaded")){return b}else{return false}});if(a.length){return a[a.length-1].get("id")}else{return false}},activeProjectCount:function(){var a=this.filter(function(c,b,d){if(c.get("active")===false||c.get("removed")===true){return false}return true});return a.length}});