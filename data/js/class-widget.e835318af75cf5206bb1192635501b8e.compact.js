var storage=require("./class-storage");var utils=require("./utils");var fns=require("./functions");var widget={editing:false,widgetOffset:null,locked:null,currSelection:null,useCanvas:false,get:function(b){var a;if(typeof widgets!=="undefined"){a=widgets.summary&&widgets.summary[b]&&$.extend(true,{id:b},widgets.summary[b])}if(a==undefined){a=storage.get(b)}return a||false},set:function(b,d){var a=storage.get(d,{getAll:true});if(!a){return false}for(var c in b){a[c]=b[c]}storage.set(d,a)},getSubTextElements:function(e){var c,b,d=[],a;a=e.id;c=storage.get(a,{returnModel:true}).getSubTextElements();c.forEach(function(f){d.push(f.id)});b=$("#"+d.join(", #"));return b},getSegmentRoots:function(d){var c=[],b,a;$(d).each(function(){b=storage.get(this.id,{returnModel:true});a=b.getSegmentRoot();if(a){c.push(a.id)}});c=$("#"+c.join(", #"));return c},getLockTos:function(c){var a=fluid.main.project.widgets.getRoots(c);var b=Array.prototype.reduce.call(a,function(e,d){_.forEach(document.querySelectorAll('[data-lockto="'+d.id+'"]'),function(f){if(e.indexOf(f)===-1){e.push(f)}});return e},[]);return $(b)},getSelectedOnly:function(c){function a(d){c.each(function(){if($(this).attr("data-segment")==$(this).attr("id")){if($(this).attr("data-lockto")==d){b=b.add($(this))}else{return}}})}var b=$([]);c.each(function(){if($(this).hasClass("ui-selected")){var d=widget.get($(this).attr("id"));if(d.sc&&!d.bg){var e=$(this).attr("id");a(e)}else{b=b.add($(this))}}});return b},getDependentsCache:[],getDependents:function(b,h,c){var d=[],g,f=[];if(c&&widget.getDependentsCache[b]){return widget.getDependentsCache[b]}if(!c){widget.getDependentsCache=[]}if(h){h.each(function(){f.push(storage.get(this.id,{returnModel:true}))});h=f}else{h=storage.get(b,{returnModel:true}).getLockTos()}for(var e=0,a=h.length;e<a;e++){if(h[e].get("of")===b){d.push(h[e].id)}}g=$("#"+d.join(", #"));widget.getDependentsCache[b]=g;return g},resetCache:function(){widget.getDependentsCache=[]},getAbsDimension:function(b,a){if(typeof b=="string"){if(b=="a"){return a||0}else{return(parseFloat(b||0)/100)*(a||0)}}else{return b}},getPagePos:function(b,g,d){if(!g){g={top:0,left:0}}var i=widget.get(b),e=i.ca,f=(i.tlwh||i.dp).slice(),h=i.tlwh?i.tlwh.slice(2):widget.wh.slice(),j=d.slice(),a=i.of&&i.of!=b;if(a){var c=widget.getBoxSize(i.of);j[0]=widget.getAbsDimension(c.width,d[0]);j[1]=widget.getAbsDimension(c.height,d[1])}f[0]=widget.getAbsDimension(f[0],j[1]);f[1]=widget.getAbsDimension(f[1],j[0]);h[0]=widget.getAbsDimension(h[0],j[0]);h[1]=widget.getAbsDimension(h[1],j[1]);if(e[0]=="b"){f[0]=j[1]-f[0]-h[1]}else{if(e[0]=="c"){f[0]=j[1]/2+f[0]-h[1]/2}}if(e[1]=="r"){f[1]=j[0]-f[1]-h[0]}else{if(e[1]=="c"){f[1]=j[0]/2+f[1]-h[0]/2}}g.top+=f[0];g.left+=f[1];if(a){widget.getPagePos(i.of,g,d)}return g},getBoxSize:function(c){var b={};var a=widget.get(c),d=[a.tlwh[2],a.tlwh[3]]||a.wh;b.width=d[0];b.height=d[1];return b},saveTempFile:function(b,a){storage.setTempItem(b+"_file",a)},getTempFile:function(a){return storage.get(a+"_file")},removeTempFile:function(a){storage.remove(a+"_file")},verticalAlign:function(c){var f=c.find(".widgetText");if(f.length==0){return}var j=parseInt(c.css("height"));var i=f.css("font-size");var a=f.css("font-family");f.contents().wrapAll("<span></span>");var e=f.find("span").eq(0);e.css("font-size",i);e.css("font-family",a);var d=parseFloat(e.css("height"));e.contents().eq(0).unwrap();var h=(parseFloat(f.css("top"))/j)*100;var b=(j-d)*h;b=(b<=0)?0:b;f.css("padding-top",b+"px");fns.updateTLWH();var g=widget.get(c.attr("id"));g.ts=f.attr("style");if(g.id){widget.set(g,g.id)}},autoWidth:function(c,d){var a=[c.tlwh[2],c.tlwh[3]];var b=d!="library"?utils.getActivePage().find(".widgetHolder").width():320;var b=d!="library"?utils.getActivePage().find(".widgetHolder").width():320;if(b==null&&a[0]=="a"){a[0]=320}else{if(a[0]=="a"){a[0]=b}}return a},addUploads:function(){var a=fluid.main.uploads.models;a.forEach(function(b){widgets.summary[b.id]=b.attributes})},_redraw:function(f,d,c){if(d.segment){var e=widget.get(d.lockTo);var a=widget._setupSegments(e);widget._updateSegments(e,a,c)}var b=$(".screen.active").attr("id");var g=widget._setTMPLVars(f.attr("id"),d,[0,0,parseInt(fluid.main.project.pages.get(b).get("width")),parseInt(fluid.main.project.pages.get(b).get("height"))]);widget._drawCanvasOrImage(f,g)},hasOwnColorProperties:function(a){if(typeof a=="string"){a=widget.get(a)}return !a.srps&&Boolean(a.bg||a.bgc)},serialize:function(d){function c(f,e){widget.getDependents(f).each(function(){var g=$(this).attr("id");e[g]=storage.get(g);c(g,e)})}function b(g){var f=_.clone(storage.get(g));if(!f){return}var e={id:g};f.insertAfterId=$("#"+g).prev().attr("id");e[g]=f;storage.set(g,f);if($("#"+g).prev().length==0){e[g].insertAfterId="first"}c(g,e);return e}var a;if($.isArray(d)){a=$.map(d,function(e){return b(e)})}else{a=b(d)}return JSON.stringify(a)},deserialize:function(d,f,e,c){function b(h){var m=h.id;var k=h[m];var j=$("#"+f);var g=j.find(".widgetHolder");var l=[0,0,g.outerWidth(),g.outerHeight()];var n=k.insertAfterId;widget._save(m,k,j);widget._draw(m,g,l,false,false,n);var i=e&&storage.get(e);if(i&&i.seg&&"segment" in k&&k.segment==m){widget._insertSegmentObj(i,m,k,c)}n=m;delete h.id;delete h[m];for(m in h){k=h[m];if(k){widget._save(m,k,j);widget._draw(m,g,l,false,false,n);n=m}}}if(d){var a=JSON.parse(d);if(a){if($.isArray(a)){$.each(a,function(g,h){b(h)})}else{b(a)}}}},checkIntegrity:function(d,b){var c=widget.get(d);if(!c){return true}if(c.name){var a={blackSearch:"widget201010120",tablerowsliderlongblank:"widget201010120",pROGRESSBAR:"widget893",iconStatusBarDark:"widget730",iconStatusBarLight:"widget729",iconStatusBarTrans:"widget731",webLoading:"widget615",webUrlEntry:"widget613",webShortcuts:" widget614",barmapbottomwithtext:"widget910",iPHONEMENUSDARK1:"widget917",rOWCONTENTX1SELECTED:"widget926",spinner:"widget308",dIALINGPAD:"widget908",mEDIAPLAYER:"widget3071",buttonbackandnext:"widget919",switchonwithtext:"widget309",iconLibrary:"widget137",iconAdd:"widget127",iconNext:"widget133",iconRemove:"widget135",sortAlpha:"widget788",iconsorthandles:"widget789",iconAttach:"widget128",iconBack:"widget129",iconForward:"widget130",iconForward1:"widget1301293847",iconInfo:"widget131","'iconTick":"widget136",iconTick1:"widget1342343236",iconWorking:"widget132"};if(a[c.name]){widget.replace(d,a[c.name])}}if(!c.tlwh){widget.fixTLWH(d,c,b)}return true},load:function(b,c,g){var k=$("#"+b).find(".widgetHolder");var a=[0,0,k.outerWidth(),k.outerHeight()];if(g==true){var f=$("#"+b).find(".fixedWidgetHolderFront");var e=k}for(var d=0;d<c.length;d++){if(g==true){var i=widget.get(c[d]);k=e;var h=false;if(i.st=="f"){h=utils.findPositionOnScreen($([]),c[d],g);if(h==true){k=f}}}widget._draw(c[d],k,a,false,false,c[d].insertAfterId)}},fixTLWH:function(h,f,c){if(!f.wh){return false}var b=f.top.toString();var d=f.left.toString();if(b.indexOf("%")>-1){b=b.substring(0,b.indexOf("%")+1)}if(d.indexOf("%")>-1){d=d.substring(0,d.indexOf("%")+1)}if((f.lockTo!=h)&&(b.indexOf("%")==-1)){var a=widget.get(f.lockTo);var g=(!a||isNaN(a.tlwh[0]))?0:a.tlwh[0];b=f.top-g}if((f.lockTo!=h)&&(d.indexOf("%")==-1)){var a=widget.get(f.lockTo);var g=(!a||isNaN(a.tlwh[1]))?0:a.tlwh[1];d=f.left-g}if(b.toString().indexOf("%")==-1){b=parseFloat(b)}if(d.toString().indexOf("%")==-1){d=parseFloat(d)}if((f.wh[0]).toString().indexOf("%")==-1){f.wh[0]=parseFloat(f.wh[0])}if((f.wh[1]).toString().indexOf("%")==-1){f.wh[1]=parseFloat(f.wh[1])}if(f.st!="b"){var e=[b,d,f.wh[0],f.wh[1]];f.tlwh=e}f.ca="tl";delete f.top;delete f.left;delete f.wh;delete f.id;delete f.title;delete f.dp;delete f.x;storage.set(h,f)},getBlurBox:function(d,b,f){var e,k,h,j;j=storage.get(d,{returnModel:true});if(j&&j.getPage){h=j.getPage().getBox()}else{var g=storage.get(b);h=[0,0,g.width,g.height]}if(j&&j.getBox){k=j.getBox().slice(0)}else{if(d.indexOf("helper-")===0){k=[0,0,h[2],h[3]]}else{k=[0,0,1,1]}}var a=f*2;k[0]-=f;k[1]-=f;k[2]+=a;k[3]+=a;e=k;for(var c=0;c<2;c++){if(k[c]<0){e[c]=0;e[c+2]=e[c+2]+e[c]}}for(var c=2;c<=3;c++){if(k[c-2]+k[c]>h[c]){e[c]=h[c]-e[c-2]}}return e},renderBlurLayer:function(g,e,m,k){e=e||storage.get(g,{returnModel:true}).getPage().id;var j=storage.get(e),c=document.createElement("canvas"),i=c.getContext("2d"),b=(b=g.match(/^helper-(.+)/))&&b[1],h=(b?widgets.summary[b].blur:widget.get(g).blur),l=widget.getBlurBox(g,e,h);if(l[2]<=0||l[3]<=0){return null}var d=l[0]+l[2],f=l[1]+l[3],a=new fluid.wdgRenderer(d,f);j=a.preparePage(e);c.width=d;c.height=f;a.renderBlur=false;a.useOneCanvas=true;a.pageId=e;a.renderingQueue[e]=[];a.generateCanvas(e);a.ctx.fillStyle="white";a.ctx.fillRect(0,0,a.canvasSize[0],a.canvasSize[1]);a.afterPageRendered=function(n,p){i.drawImage(a.canvas[0],0,0);utils.blur.canvasRGB(c,l[0],l[1],l[2],l[3],h);if(m){try{return m(c.toDataURL(0,0))}catch(o){return k?k(o):o}}};a.renderWidgetsBelow(g,j,!m);i.drawImage(a.canvas[0],0,0);utils.blur.canvasRGB(c,l[0],l[1],l[2],l[3],h);return c.toDataURL()},renderBlurLayerImmediate:function(e,c){c=c||storage.get(e,{returnModel:true}).getPage().id;var b=storage.get(c),a=document.createElement("canvas"),d,g=(g=e.match(/^helper-(.+)/))&&g[1],f=(g?widgets.summary[g].blur:widget.get(e).blur);a.width=b.width;a.height=b.height;d=widget.getBlurBox(e,c,f);if(d[2]<=0||d[3]<=0){return null}if(this.canvases[c]){utils.blur.canvasRGB(a,d[0],d[1],d[2],d[3],f,this.canvases[c].get(0))}else{utils.blur.canvasRGB(a,d[0],d[1],d[2],d[3],f)}return a},setBlurBG:function(e,b,a){var c=widget.blurLayers[e.id];if(c){var d=widget.blurOffsets[e.id];if(!d){d=widget.blurOffsets[e.id]={left:0,top:0}}if(typeof b!=="number"){b=0;a=0;d.left=parseInt(e.style.left,10);d.top=parseInt(e.style.top,10)}e.style.backgroundImage="url("+c+")";e.style.backgroundPosition=-(d.left+b)+"px "+-(d.top+a)+"px";e.style.backgroundRepeat="no-repeat"}else{e.style.backgroundImage="none"}},blurLayers:{},blurOffsets:{}};fluid.main.on("uploaddone",function(a,b){widget.removeTempFile(b)});module.exports=widget;