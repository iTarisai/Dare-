var dbStorage=require("./class-dbStorage");var storage=require("./class-storage");var utils=require("./utils");var getParentWindow=utils.getParentWindow;var branding=require("./class-branding");var widget=require("./class-widget");var widgetEvents=require("./class-widgetEvents");var widgetMoving=require("./class-widgetNewMoving");var widgetDraw=require("./class-widgetNewDraw");var browserDetect=require("./browserdetect");var scrollview=require("./class-scrollview");var contextMenu=require("./class-contextMenu");var canvas2=require("./class-canvas");var share=require("./class-share");var previewMenu=require("./class-previewMenu");var userSettings=require("./class-userSettings");var preview={url:null,printURL:null,embedURL:null,pageTransitioning:false,multiOrientations:false,projectWH:[320,480],delayStart:1000,loaded:false,pageScale:1,pageRotation:0,pageTranslation:[0,0],viewportScaled:false,currentFrameScale:1,navigationStackBack:[],navigationStackForward:[],navigationQueueNext:[],navigationQueueFlow:[],navigationCompleted:false,navigationEnabled:false,navigationDefaultTransition:null,parentWindow:null,parentDoc:null,useZoomSlider:false,pageNotes:{},isOpen:false,exported:location.origin==="file://"||location.origin==="null",initExported:function(){if($("#previewPage").size()>0){$(window).on("message",preview._crossDomainCallListener)}preview._showPreviewPage(false)},scaleFrame:function(l,i,o){i=i||false;l=l||false;if(!preview.loaded&&!i&&l){return}if(window.g_print||window.g_embedded){return}var c=utils.getParentWindow()||window,f=c.document,b=$("#previewPage",f),h=window;if(b[0]){h=b[0].contentWindow}else{if(utils.getParentWindow()){b=$("#previewPage",f)}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"scaleFrame",arguments);return}}}if(!l&&!b[0]){if(utils.isMobileDevice()){preview.scaleViewport()}return}var e,a=f.getElementById("previewZoomSlider");if(!o&&a&&h.preview&&h.preview.useZoomSlider){e=a.value}else{var k=b.outerWidth(),d=b.outerHeight(),p=Math.max(k,d),g=(o?{width:k,height:d}:{width:p,height:p}),n=(o?{width:c.innerWidth,height:c.innerHeight}:preview.availableRect),m=utils.getFitSize({object:g,frame:n,expand:o});e=m.width/g.width}if(!preview.useZoomSlider&&a&&typeof e==="number"){var j=c.$(a);if(j){j.slider("value",e)}}if(o){if(c===window){b[0].contentWindow.preview.useZoomSlider=true}else{preview.useZoomSlider=true}}b.css({"-webkit-transform":"scale("+e+")","-moz-transform":"scale("+e+")",transform:"scale("+e+")"});preview.centerFrame(c);preview.positionNotes();preview.currentFrameScale=previewMenu.currentFrameScale=e;preview._showPreviewPage(true)},scaleViewport:function(h){if(!preview.viewportScaled){h=h||$(".ui-page-active");var f=$(".ui-content",h);var d=window.innerWidth;var g=preview.getTrueHeight();var c=d>g?[g,d]:[d,g];var a=preview.projectWH[0];var e=preview.projectWH[1];var b=a>e?[e,a]:[a,e];preview.pageScale=Math.min(c[0]/b[0],c[1]/b[1]);if(utils.hideBrowserBar()){window.scrollTo(0,1)}}},applyPageTransforms:function(c){var e=preview.pageScale!==1?"scale("+preview.pageScale+") ":"";var b=preview.pageRotation!=0?"rotate("+preview.pageRotation+"deg)":"";var d=(preview.pageTranslation[0]||preview.pageTranslation[1])?" translate("+preview.pageTranslation[0]+"px,"+preview.pageTranslation[1]+"px)":"";var a=e+b+d;$(".widgetHolder",c).css({"-webkit-transform":a,"-moz-transform":a,transform:a})},_showPreviewPage:function(a){if(typeof a=="undefined"){a=true}var b=$("#previewPage");if(b.size()==0){if(utils.getParentWindow()){b=$("#previewPage",window.parent.document)}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"_showPreviewPage",[a])}}}b.css({visibility:a?"visible":"hidden"})},updateExportUi:function(c){var d={Pages:$("#previewShareContainer .shareLinkExportImg").add("#projectSettingsShareTop .shareLinkExportImg"),Project:$("#previewShareContainer .shareLinkExportImgFull").add("#projectSettingsShareTop .shareLinkExportImgFull")};var h;var g=["Pages","Project"];var e;var b;for(var f=0,a=g.length;f<a;f++){e=c["export"+g[f]];h=d[g[f]].next(".msg");if(e&&e.snapshotId){if(e.status==="FINISHED"){h.html('<a class="export-link" rel="'+e.snapshotId+'">Download ('+e.processDate+")</a>");b=h.find(".export-link");b.click(function(i){window.open(document.location.origin+document.location.pathname+"snapshot/"+i,"_snapshot")}.bind(b,e.snapshotId));h.removeClass("pulsing")}else{if(e.status==="STARTED"||(e.status==="NEW"&&e.queue===0)){h.html("exporting...");h.addClass("pulsing");share.startExportPolling(e.snapshotId)}else{if(e.status==="NEW"){e;h.html("queued ("+e.queue+")...");h.addClass("pulsing");share.startExportPolling(e.snapshotId)}else{if(e.status==="FAILED"){h.html("export failed...");h.removeClass("pulsing")}}}}}else{h.html("");h.removeClass("pulsing")}}},open:function(c,b){var d=fluid.main.project.get("id");var a=fluid.main.project.bundle(d);contextMenu.hide();fluid.main.fire("beforepreviewopen");fluid.api.projectSync(d,a,function(){canvas2.setEditorVisibility(false);$("#previewPage").contents().find("body").remove();$("#hud .hud-buttons .hud-secondary").hide();fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");preview.hideMenu();fluid.controllers.bin.hide();preview.hideNotes();if(document.getElementById("previewShowNotes").checked){preview.getNotesElement().style.display=""}else{preview.getNotesElement().style.display="none"}preview._showPreviewPage(false);fluid.main.fire("projectIntegrityCheckNeeded");var h=fluid.main.project.get("pageWH");var f=fluid.main.project.isMultiOrientation();if(c&&(c.currentTarget.id=="preview"||c.currentTarget.id==="pagePreview")){var i=(document.location.href).split("?");var g=d+"."+fluid.main.project.get("updated");share.init(d);preview.embedURL=i[0]+"embed/"+g;var e=$("#tmplEmbedCode").tmpl({url:preview.embedURL,width:f?Math.max(h[0],h[1]):h[0]+64,height:f?Math.max(h[0],h[1]):h[1],multiorient:f}).html();$("#embedCode").html(e)}if(fluid.main.account.get("loggedIn")!="yes"){$("#previewSignup").show();$("#previewShareContainer").hide()}$("#previewPage").css({width:h[0],height:h[1],webkitTransform:"scale(2)",transform:"scale(2)"}).attr("src","project/"+d);$("#previewHolder").fadeIn(200).addClass("open");$("#previewHolder2").fadeIn(200);$("#previewFrameParent").removeClass("to-landscape to-portrait");preview.setAvailableRect(preview.calcAvailableRect());preview.centerFrame();preview.isOpen=true;fluid.main.fire("preview")},function(){notification.add("alert","Could not save your project to the server. Please check your connection.")})},close:function(){canvas2.setEditorVisibility(true);$("#hud .hud-buttons .hud-secondary").fadeIn(300);fluid.command.create("showButton").dispatchTo("fluid.controllers.timeline");$("#previewPage").find(".widgetHolder").empty();$("#previewSignup").hide();$("#previewShareContainer").show();$("#previewHolder").removeClass("open").fadeOut(200);$("#previewHolder2").fadeOut(200);$(".messageError").hide();window.preview.startPage=null;fluid.controllers.bin.show();fluid.main.fire("previewclosed");previewMenu.close();preview.isOpen=false},parseDownload:function(b,i,d){var g="Couldn't download correctly (has it been deleted/made inactive?)";try{var c=JSON.parse(b)}catch(h){try{var c=JSON.parse(d.responseText)}catch(h){$("body").html("Unable to parse download - unknown error (1)");throw ("Error Downloading "+item+"Caller:"+arguments.callee.caller+" Second level:"+arguments.callee.caller.caller+"loadSate"+loading_Stage_Check)}}if(c.r!="s"){preview.displayErrorMessageOnLoad(g);return false}try{var f=JSON.parse(c.t.toString())}catch(h){preview.displayErrorMessageOnLoad("Unable to download the mockup - download was interrupted.")}if(!fluid.main.project&&g_preview){fluid.main.project=new fluid.models.project(f,{parse:true,projectId:g_preview,syncOnChange:false})}var c=f[g_preview];if(c&&c.active===false){var a=(location.origin==="file://"||location.origin==="null")?window:top;preview.displayErrorMessageOnLoad("");preview._crossDomainCall(window.parent,"setFrameSize",[324,500]);$("#projectInactive").tmpl().appendTo("body");return false}if(preview.exported){preview.afterPreviewLoad(f)}else{return f}},displayErrorMessageOnLoad:function(a){$("body").html(a);preview.scaleFrame(true,true)},afterPreviewLoad:function(e){if(e===false){return}var l=[];var p=$("#homePage");if(innerWidth===300&&e[window.g_preview]&&e[window.g_preview].pageWH){l=e[window.g_preview].pageWH;if(l[0]<l[1]){p.css("background-size",l[0]+"px auto")}else{p.css("background-size","auto "+l[1]+"px")}}else{if(innerWidth<innerHeight){l[0]=innerWidth+"px";l[1]="auto"}else{l[0]="auto";l[1]=innerHeight+"px"}p.css("background-size",l[0]+" "+l[1])}var b=branding.deviceScreen(),c=b.device,m=b.screen,f=e[window.g_preview]||e,j=f.deviceModel,i,o,h=window.innerWidth>window.innerHeight,d=document.getElementById("homePageStyle"),g='<link id="appIcon" rel="apple-touch-icon" href="'+(branding.getUrl("icon",null,f)||"img/apple-touch-icon-144.png")+'" />';if(/iPhone/.test(j)){i=(branding.getUrl("splash"+j,m.splash,f)||"img/fluidLoading"+branding.screens[j].splash+".png");g+='<link id="splashP" rel="apple-touch-startup-image" href="'+i+'" />'}else{i=branding.getUrl("splashP"+j,m.splashP,f)||(m.splashP?"img/fluidLoading"+m.splashP+".png":"");o=branding.getUrl("splashL"+j,m.splashL,f)||(m.splashL?"img/fluidLoading"+m.splashL+".png":"");g+='<link id="splashP" rel="apple-touch-startup-image" sizes="'+m.splashP+'" media="(orientation: portrait)" href="'+i+'" /><link id="splashL" rel="apple-touch-startup-image" sizes="'+m.splashL+'" media="(orientation: landscape)" href="'+o+'" />'}var k=f&&f.pageWH[0]||"1024px 748px;";var q=f&&f.pageWH[1]||"748px 1024px;";if(d){d.innerHTML="#homePage { background: url("+(h&&o?o:i)+") no-repeat bottom; background-size: "+(/iPad/.test(j)?(h?"1024px 748px;":"764px 1004px;"):j==="iPhone5"?"320px 568px;":j==="iPhone"?"320px 460px;":k+"px "+q+"px;}")}if(!c){if(!i&&!o){document.head.removeChild(d);$("#default-branding-links").tmpl().appendTo("head")}}$("head").append(g);try{utils.getParentWindow().preview.setAvailableRect()}catch(n){preview._crossDomainCall(window.parent,"setAvailableRect")}$(document).ready(function a(r){if(utils.isMobileDevice()){$("body").addClass("mobile")}widget.useCanvas=true;preview.runDraw(e);$(window).bind("orientationchange",function(){$("body").scrollTop(0).scrollLeft(0);loading_Stage_Check="preview Loaded"})})},load:function(a,c){if(location.origin==="file://"||location.origin==="null"||!frameElement){b()}else{$(frameElement).load(b)}function b(){dbStorage.onReady(function(){storage.init(function(){if(location.origin!=="file://"&&location.origin!=="null"){$(frameElement).off("load")}var d=storage.get(a);if(d&&d.unloaded!==true){if(typeof c==="function"){c(d)}if(window.g_print){preview.runDraw(a)}}else{function e(f){var g=preview.parseDownload.apply(this,arguments);if(typeof c==="function"){c(g)}f=JSON.parse(f);var h=JSON.parse(f.t);if(window.g_print){preview.runDraw(h)}}fluid.api.syncDown(a,false,false,e,e)}})})}},draw:function(r){if(!r){return false}if($.mobile){$.mobile.defaultHomeScroll=0}for(var t in r){storage.setTempItem(t,r[t])}var c=r[g_preview]||r;for(var l=0;l<c.pages.length;l++){var a=storage.get([c.pages[l]]);preview.pageNotes[c.pages[l]]=a&&a[3]||""}preview.viewportScaled=window.navigator.hasOwnProperty("standalone")&&window.navigator.standalone;preview.projectWH=[c.pageWH[0],c.pageWH[1]];var k=preview.viewportScaled?preview.projectWH[0]:$(window).width();var b=preview.viewportScaled?preview.projectWH[1]:preview.getTrueHeight();if(utils.isMobileDevice()&&k>b&&window.screen.width<window.screen.height){var p=k;k=b;b=p}var s=preview.viewportScaled?Math.min(window.screen.width/k,window.screen.height/b):1;if(/iP(hone|od|ad)/.test(navigator.platform)){var g=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);if(g&&g[1]&&g[1]==="6"){$("#metaViewport").attr("content","initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no")}}else{$("#metaViewport").attr("content","width="+k+",height="+b+",minimum-scale="+s+",maximum-scale="+s+",initial-scale="+s+",user-scalable=0")}if(utils.getParentWindow()){if(!window.g_embedded){try{var d=$("#previewPage",window.parent.document);if(d.size()>0){d.css({width:c.pageWH[0],height:c.pageWH[1]});$(".ui-mobile-viewport").css("overflow","hidden")}}catch(o){}}preview.scaleFrame()}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"setFrameSize",c.pageWH);preview._crossDomainCall(window.parent,"scaleFrame")}}if(location.origin==="file://"||location.origin==="null"){$(".pageList:not(#homePage)").css("height",preview.getTrueHeight()+"px")}else{$(".pageList").css("height",preview.getTrueHeight()+"px")}document.title=c.name;document.projectLoaded=true;for(var l=0;l<c.pages.length;l++){if(!storage.get(c.pages[l])){c.pages.splice(l,1);l--}}if(!storage.get(c.homepage)){c.homepage=c.pages[0]}var j=c.orientation;preview.multiOrientations=false;for(var l=0,m=c.pages.length;l<m;l++){if(storage.get(c.pages[l]).orientation!=j){preview.multiOrientations=true;break}}if(browserDetect.OS=="Android"&&preview.multiOrientations){var q=$(window).width();var f=window.outerHeight||getTrueHeight();$(".ui-mobile-viewport").css({"min-height":Math.max(q,f)+"px"})}if(window.g_embedded&&(preview.projectWH[0]>preview.projectWH[1]||preview.multiOrientations)){}if(window.g_print){for(var l=0,m=c.pages.length;l<m;l++){preview.drawPage(c.pages[l],c)}$("#font-preloader").remove()}else{var h=utils.getParentWindow()?utils.getParentWindow().preview.startPage:null,n=h||(c.homepage?c.homepage:c.pages[0]);preview.homePage=n;preview.drawPage(n,c);if(typeof g_previewMode!="undefined"&&g_previewMode==true){preview.scaleViewport();preview.bindMobileEvents(c.links);g_homepage=n;setTimeout(function(){preview.changePage("#"+n,null,false,true)},preview.delayStart)}}},showPage:function(a){$(".previewPage").hide();$("#"+a).show();if(typeof window.callPhantom==="function"){window.callPhantom({event:"shownPage",id:a})}},drawPage:function(b,e){if(!e){e=storage.get(g_preview)}var f="transparent";var g=storage.get(b);if(!g){return}var a=[g.width,g.height];var d={pageId:b,width:a[0],height:a[1],widthScreen:$(window).width(),heightScreen:preview.getTrueHeight(),bgColor:f};if(window.g_embedded){if(preview.multiOrientations){if(a[0]>a[1]){d.top=(a[0]-a[1])>>1}else{d.left=(a[1]-a[0])>>1}}else{d.left=$(".previewLogoHolder").outerWidth()}}if((window.g_print)&&(g.notes!=undefined)){d.notes=g.notes[3];d.title=g.name==undefined?"":g.name}var c=$("#tmplPreviewPage").tmpl(d).appendTo("body");preview.drawWidgets(g_preview,b,e.links);preview.showLinks(e.links,b);$("#"+b).bind("pageshow",preview.navigateInit);if(window.g_print){if(g.width===e.pageWH[0]&&g.height===e.pageWH[1]){c.addClass("project-size")}}},changePage:function(g,h,e,a){var c=g.substr(1);if($(g).size()==0){preview.drawPage(c);$(g).trigger("pageinit")}$(g).addClass("visited");var i=h;var b=a=="undefined"?true:!a;if((!i)&&(b)){var f=preview.navigationDefaultTransition.split(":");var d=(f.length>1)?true:false;i={transition:f[0],reverse:d}}preview.orient(null,$(g),$(".ui-page.ui-page-active"));if(utils.isMobileDevice()){$.mobile.changePage(g,i)}else{setTimeout(function(){$.mobile.changePage(g,i)},300)}if(window.Android){Android.updateOrientation()}window.setTimeout(function(){preview.preloadLinkedPages(c);preview._fixNavigationStatus(c,h,e)},100)},_fixNavigationStatus:function(c,d,e){if((preview.navigationStackBack.length>0)&&(e!=2)){var b=d;if(preview.navigationQueueNext.length>0){if(preview.navigationQueueNext[0].args){b=preview.navigationQueueNext[0].args;b.reverse=!b.reverse}}preview.navigationStackBack.push({pageId:c,args:b})}preview.navigationQueueFlow=$.grep(preview.navigationQueueFlow,function(g,f){return g.pageId!=c});var a=$("#"+c).hasClass("blank");if(!a){preview.navigationQueueFlow.push({pageId:c,args:d})}preview.navigationQueueNext=$.grep(preview.navigationQueueNext,function(g,f){return g.pageId!=c})},_isPageVisited:function(a){var b=$("#"+a);if((b.size()>0)&&(b.hasClass("visited"))){return true}return false},preloadLinkedPages:function(b){if((preview.navigationCompleted)&&(preview.navigationQueueFlow.length>1)){var f=preview.navigationQueueFlow.slice(0);var h=f.pop();preview.navigationStackBack.push(h);return}var d=storage.get(g_preview);var g=storage.get(b);var a=d.links;var e=0;var c=0;$.each(a.linkOrigin,function(n,k){if(a.linkType[n]=="ahref"&&$("#"+k).closest(".page").attr("id")==b){var j=a.linkDest[n];var q=storage.get(j);if(!q){return}var o=$("#"+j);if((o.size()==0)&&(q.widgets.length>0)){var r=a.transType[n].split(":");var m=(r.length>1)?true:false;var l={transition:r[0],reverse:m};preview.navigationQueueNext.push({pageId:j,args:l});preview.drawPage(j,d);e++}else{if(o.size()>0){if((preview.navigationQueueFlow.length>0)&&(j==preview.navigationQueueFlow[0].pageId)&&(!preview.navigationQueueFlow[0].args)){var r=a.transType[n].split(":");var m=(r.length>1)?true:false;preview.navigationQueueFlow[0].args={transition:r[0],reverse:m}}}}}if((preview.navigationStackBack.length==0)&&(c<1)){if((a.linkType[n]=="ahref")&&(a.linkDest[n]==b)){var j=preview.getPageIdForWidget(k);var q=storage.get(j);if(!q){return}if((!preview._isPageVisited(j))&&(q.widgets.length>0)){var r=a.transType[n].split(":");var m=(r.length>1)||r[0]=="none"?false:true;var l={transition:r[0],reverse:m};preview.navigationStackBack.push({pageId:j,args:l});c++}}}});preview.preloadNextUndisplayedPage(d);preview.preloadPreviousUndisplayedPage(d)},preloadNextUndisplayedPage:function(a){return preview.findUnlinkedPage(a,a.pages,preview.navigationQueueNext,true)},preloadPreviousUndisplayedPage:function(a){var d=a.pages.slice(0);preview.findUnlinkedPage(a,d.reverse(),preview.navigationStackBack,false);if((preview.navigationCompleted)&&(preview.navigationQueueFlow.length>1)){var b=preview.navigationQueueFlow.slice(0);var c=b.pop();preview.navigationStackBack.push(c)}},findUnlinkedPage:function(c,a,e,b){if((preview.navigationCompleted)||(e.length>0)){return false}var d=false;$.each(a,function(g,f){if(!preview._isPageVisited(f)){var h=storage.get(f);if(h.widgets.length>0){e.push({pageId:f,args:null});if(b){preview.drawPage(f,c)}d=true;return false}}});if(!d){preview.navigateSetCompleted()}return d},showLinks:function(b,a){$.each(b.linkOrigin,function(d,c){if(b.linkType[d]=="ahref"&&(!a||$("#"+c).closest(".page").attr("id")==a)){$("[id="+c+"]").addClass("widgetLink");var f=$("[id="+c+"]").attr("data-lockto");var e=$('[data-lockto="'+f+'"]').each(function(){var g=$(this).attr("id");if(preview.linkShowRipple(g,c)){$("#"+g).addClass("widgetLink")}})}})},drawWidgets:function(e,d,c){if(!fluid.main.project&&top&&top.fluid&&top.fluid.main.project){fluid.main.project=top.fluid.main.project}var h=$("#"+d).find("[data-role=content]");var b=[];for(var g in c.linkDest){if(c.linkType[g]=="template"&&c.linkDest[g]==d){var f=fluid.main.project.pages.get(c.linkOrigin[g]).attributes.widgets;b=b.concat(f)}}var f=fluid.main.project.pages.get(d).attributes.widgets;widgetList=b.concat(f);for(var g=0;g<widgetList.length;g++){widget.checkIntegrity(widgetList[g])}if(widgetList.length>0){var a=true;widget.load(d,widgetList,a)}else{preview.showBlankPage(d,c)}},showBlankPage:function(b,a){var c=$("#blankPage").find(".pageList").html();var d=$("#"+b).find(".widgetHolder");d.html(c);d.parent().addClass("blank");$(".blankPageBackButton",d).bind("click",preview.navigateBack)},getPageIdForWidget:function(d){var c=storage.get(g_preview);var a=c.pages;var b="";$.each(a,function(e,f){var g=storage.get(f).widgets;$.each(g,function(i,h){if(h==d){b=f;return false}});if(b!=""){return false}});return b},orient:function(c,b,a){if(!window.g_embedded){try{if(utils.isMobileDevice()){preview._orientMobile(b,a)}else{preview._orientParent(b,a)}preview.scaleViewport(b);preview.centerFrame()}catch(c){}}},_orientationData:function(j){var e=storage.get(g_preview);var g=storage.get(j.attr("id"));var c=e.pageWH||[320,480];var h=g.orientation?(g.orientation!="Landscape"):(g.width<=g.height);var a=h?g.width>g.height:g.width<=g.height;var b=$.event.special.orientationchange;var d=(b&&$.isFunction(b.orientation))?b.orientation()=="portrait":window.screen.width<window.screen.height;var f=c[1]>=c[0];var i=h&&f||!h&&!f;return{portrait:h,crossOriented:d!=h,multiOriented:preview.multiOrientations,projectOriented:i,width:c[0],height:c[1]}},_orientMobile:function(c,a,d){d=d||preview._orientationData(c);preview.pageRotation=d.crossOriented?(d.portrait?-90:90):0;var b;if((d.portrait&&d.projectOriented)||(!d.portrait&&!d.projectOriented)){b="width"}else{b="height"}preview.pageTranslation=preview.pageRotation?(preview.pageRotation>0?[0,-d[b]]:[-d[b],0]):[0,0];preview.applyPageTransforms(c);if(browserDetect.OS=="iOS"){var f=window.screen.width*(preview.viewportScaled?window.devicePixelRatio:1);var g=window.screen.height*(preview.viewportScaled?window.devicePixelRatio:1);var e=d.portrait!=d.crossOriented;$(document.body).css({width:(e?Math.min(f,g):Math.max(f,g))+"px"})}else{if(utils.hideBrowserBar()){window.scrollTo(0,1)}}},orientPrevPage:function(c,a,d){if(!a){return}var b,e=(d.portrait&&d.projectOriented)||(!d.portrait&&!d.projectOriented);translateSide=e?"width":"height";if(d.portrait){b="rotate(90deg) translate(0,-"+d[translateSide]+"px)"}else{b="rotate(-90deg) translate(-"+d[translateSide]+"px, 0)"}$(".widgetHolder",a).css({"-webkit-transform":b,"-moz-transform":b,transform:b})},_orientParent:function(d,b,f){var g=$("#previewPage",utils.getParentWindow()?frameElement.ownerDocument:document);f=f||preview._orientationData(d);if(f.crossOriented){if(!utils.getParentWindow()&&window.g_preview){setTimeout(function(){preview.orientPrevPage(d,b,f)},0)}else{preview.orientPrevPage(d,b,f)}if(g&&g.length){preview.hideNotes();var a=g[0],e=a.parentNode,c={};if(f.projectOriented){c.width=f.width;c.height=f.height}else{c.width=f.height;c.height=f.width}$(".widgetHolder",d).css({"-webkit-transform":"","-moz-transform":"",transform:"",width:c.width+"px",height:c.height+"px"});a.style.width=c.width+"px";a.style.height=c.height+"px";preview.centerFrame(window.parent||window);if(f.portrait){e.classList.remove("to-landscape");e.classList.add("to-portrait")}else{e.classList.remove("to-portrait");e.classList.add("to-landscape")}}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"_orientParent",[null,null,f])}}}fluidEvent.triggerPreview("changeOrientation",{},true)},finishOrient:function(c,b,a){if(!window.g_embedded){try{if(!utils.isMobileDevice()){preview._finishOrient(b,a)}}catch(c){}}},clearPageOrientation:function(){preview.pageRotation=0;preview.pageTranslation=[0,0]},_finishOrient:function(b,a,c){var d=utils.getParentWindow()&&window.parent&&$("#previewPage",window.parent.document);c=c||preview._orientationData(b);if(utils.getParentWindow()&&b){preview.multiOrientations=c.multiOriented;preview.updateNotes(b[0].id);preview.debouncedPositionAndShowNotes()}if(a){preview.clearPageOrientation();a.find(".widgetHolder").css({transform:"",webkitTransform:"",mosTransform:""});preview.clearPageOrientation();preview._crossDomainCall(window.parent,"_finishOrient",[null,null,c])}},bindMobileEvents:function(h){scrollview.setup(h);function d(k,j){preview.pageTransitioning=true;scrollview.showPage.call(k.target,k)}function b(k,j){scrollview.isScrolling=false;scrollview.isDoubleTapping=false;scrollview.isSwiping=false;preview.pageTransitioning=false;preview.finishOrient(k,$(k.target),j.prevPage);$(".ui-scrollview-clip",k.target).scrollview("option","rotate",preview.pageRotation);setTimeout(function(){scrollview.isTapHolding=false;if(utils.hideBrowserBar()){window.scrollTo(0,1)}},350)}function g(j){preview.orient(j,$.mobile.activePage);$(".ui-scrollview-clip",$.mobile.activePage).scrollview("option","rotate",preview.pageRotation)}function e(n){scrollview.isScrolling=false;scrollview.isDoubleTapping=false;scrollview.isTapHolding=false;scrollview.isSwiping=true;var k={up:0,right:90,down:180,left:270};var j={0:"up",90:"right",180:"down",270:"left"};var m=n.type.substr(5);var l=j[(360+(k[m]-preview.pageRotation))%360];preview.handleUserInput("swipe"+l,$(n.currentTarget).attr("id"),h);return false}function a(j){j.stopImmediatePropagation();if(scrollview.isSwiping){scrollview.isSwiping=false}else{if(scrollview.isScrolling){scrollview.isScrolling=false}else{if(scrollview.isDoubleTapping){scrollview.isDoubleTapping=false}else{if(scrollview.isTapHolding){scrollview.isTapHolding=false}else{preview.handleUserInput(j.type,$(j.currentTarget).attr("id"),h)}}}}}function i(k){scrollview.isTapHolding=true;var j=$(k.currentTarget).attr("id");preview.handleUserInput(k.type,j,h)}function f(k){scrollview.isDoubleTapping=true;var j=$(k.target).parents(".pageWidget").attr("id");preview.handleUserInput("doubletap",j,h)}function c(j){$(document).trigger("mouseup")}if(utils.isMobileDevice()){if($.support.orientation){$(window).bind("orientationchange",g)}$(window).resize(function(){window.setTimeout(function(){preview.scaleViewport($.mobile.activePage)},100)})}$("body").bind("pageinit",function(j){$(".pageWidget",j.target).doubletap(f)}).bind("pagebeforeshow",d).bind("pageshow",b).mouseleave(c);$(document).bind("touchmove",false);$(".pageWidget").live("swipeleft swiperight swipeup swipedown",e).live("vclick",function(j){j.preventDefault();a(j)}).live("taphold",i)},handleUserInput:function(d,f,b){var e=utils.getParentWindow()&&utils.getParentWindow().fluid.main.project||fluid.main.project;var b=e.get("links");if(scrollview.isScrolling){return false}d=(d=="vclick"||d=="click")?"tap":d;var a=preview.linkCheck(f,b);if(a>-1&&b.triggerType[a]==d){preview.navigateSetIncompleted();var g=e.links.get(b.linkCanvId[a]).get("transType").split(":");var c=(g.length>1)?true:false;preview.changePage("#"+b.linkDest[a],{transition:g[0],reverse:c})}else{}},alertCopyEmbedCode:function(a){notification.add("alert","Embed Code Copied")},showDebugInfo:function(b){var a=$("#divDebugInfo").html();if(a){b=a+b}$("#divDebugInfo").remove();$("body").append("<div id='divDebugInfo'>"+b+"<br/></div>")},getTrueHeight:function(){return(window.hasOwnProperty("innerHeight")?window.innerHeight:$(window).height())||480},linkCheck:function(c,a){do{var b=$.inArray(c,a.linkOrigin);if(b>-1){return b}c=storage.get(c);if(c==null){return -1}c=c.of}while(c);return -1},linkShowRipple:function(c,b){var a=storage.get(c);if(a&&a.segments==null){if(a.of==null){return}if(b!=a.of){if(preview.linkShowRipple(a.of,b)){$("#"+c).addClass("widgetLink")}}if(b==a.of){return true}}},runDraw:function(l){var b=l;var e;if(typeof(l)=="string"){l=fluid.main.project.bundle(l);e=l[g_preview];if(!e||!e.pages){fluid.api.syncDown(previewId,false,false,preview.parseDownload,preview.parseDownload);return}}e=e||l[window.g_preview];preview.loaded=true;preview.navigationStackBack=[];preview.navigationStackForward=[];preview.navigationQueueNext=[];preview.navigationQueueFlow=[];preview.navigationCompleted=false;preview.navigationDefaultTransition=e?e.defaultTransition:"none";preview.draw(l);if(window.g_print){var j=20,c=e.pageWH[0];height=e.pageWH[1],printStyle="@page { size: "+e.orientation+"; margin: "+j+"px; }\n.printPageWrapper { width: "+c+"px; height: "+height+" }\n";for(var f=1;f>0;f-=0.1){f=f.toFixed(1);var h=Math.floor(c*f),a=Math.floor(height*f);printStyle+="@media print and (max-width: "+(h+j)+"px) {\n    .project-size .page { -webkit-transform: scale("+f+"); transform: scale("+f+"); }\n    .printPageWrapper.project-size { width: "+h+"px; height: "+a+"px}\n}\n"}for(var g=0;g<e.pages.length;g++){var d=e.pages[g],k=l[d];if(k.width===c&&k.height===height){continue}printStyle+="#print_"+d+" { width: "+k.width+"px; height: "+k.height+"px; }\n";for(var f=1;f>0;f=f-=0.1){f=f.toFixed(1);var h=Math.floor(k.width*f),a=Math.floor(k.height*f);printStyle+="@media print and (max-width: "+(h+j)+"px) {\n    #"+d+" { -webkit-transform: scale("+f+"); transform: scale("+f+"); }\n    #print_"+d+" { width: "+h+"px; height: "+a+"px; }\n}\n"}}$("head").append('<style type="text/css">'+printStyle+"</style>")}},restart:function(){preview.changePage("#"+preview.homePage,null,false,true)},hideMenu:function(){},navigateInit:function(b,a){preview.navigationEnabled=true},navigateSetCompleted:function(){preview.navigationQueueNext=[];preview.navigationStackForward=[];preview.navigationCompleted=true},navigateSetIncompleted:function(){preview.navigationCompleted=false},navigateWithKeys:function(c){if((c.keyCode==27)&&(self!=top)&&(window.parent.lib!=undefined)){window.parent.lib.esc()}var b=utils.getNavigationKeyDirection(c.keyCode);if(b==""){return}var a=top==self?document.getElementById("previewPage").contentWindow.preview:window.preview;if((!a)||(!a.navigationEnabled)){return}if((b=="top")||(b=="right")){a.navigateNext();return}a.navigateBack()},navigateNext:function(){if(preview.navigationStackForward.length>0){var a=preview.navigationStackForward.pop();preview.changePage("#"+a.pageId,a.args);return}if(preview.navigationQueueNext.length>0){var a=preview.navigationQueueNext.shift();preview.changePage("#"+a.pageId,a.args);return}if(preview.navigationQueueFlow.length>0){var a=preview.navigationQueueFlow.shift();preview.changePage("#"+a.pageId,a.args);return}},navigateBack:function(){if(preview.navigationStackBack.length>1){var g=preview.navigationStackBack.pop();var f=preview.navigationStackBack.pop();var a=$("#"+f.pageId).hasClass("blank");if(a){if(preview.navigationStackBack.length>0){f=preview.navigationStackBack.pop()}else{return}}if(preview.navigationCompleted){var e=preview.navigationQueueFlow.pop();preview.navigationQueueFlow.splice(0,0,e);var b=preview.navigationQueueFlow.pop();if(b.pageId!=f.pageId){preview.navigationQueueFlow.push(b)}}else{preview.navigationStackForward=$.grep(preview.navigationStackForward,function(j,h){return j.pageId!=g.pageId});var d=$("#"+g.pageId).hasClass("blank");if(!d){var c={pageId:g.pageId,args:f.args};preview.navigationStackForward.push(c)}}preview.changePage("#"+f.pageId,f.args,1);return}if((preview.navigationCompleted)&&(preview.navigationQueueFlow.length>0)){var e=preview.navigationQueueFlow.pop();preview.changePage("#"+e.pageId,e.args,1)}},_crossDomainCall:function(c,b,a){c.postMessage(JSON.stringify({funcName:b,args:a}),"*")},_crossDomainCallListener:function(a){var b=JSON.parse(a.originalEvent.data);if($.isFunction(preview[b.funcName])){preview[b.funcName].apply(preview,b.args)}},getNotesElement:function(c){c=c||window;var b=c.document.getElementById("inPreviewNotes");if(b){return b}try{if(c.frameElement){return preview.getNotesElement(c.frameElement.ownerDocument.defaultView)}}catch(a){}return null},positionNotes:function(){var b=preview.getNotesElement(),c=b&&b.clientWidth||0;if(b){var d=document.getElementById("previewPage")||window.frameElement,a=d.getClientRects()[0];if(!a){return}x=a.left;y=a.top;b.style.left=(x-c+1)+"px";b.style.top=Math.max(y,0)+"px"}},updateNotes:function(a){var b=preview.getNotesElement();if(!b){return}var d=preview.getNotesElement().querySelector("#previewNotesContent");var c=fluid.main.project.pages.get(a).get("notes");d.textContent=c&&c[3]||"This page has no notes"},showNotes:function(){notesElement=preview.getNotesElement();notesElement&&notesElement.classList.remove("hide")},hideNotes:function(){notesElement=preview.getNotesElement();notesElement&&notesElement.classList.add("hide")},toggleShare:function(){var a=document.getElementById("previewShare");a.classList.toggle("closed");preview.setAvailableRect(preview.calcAvailableRect());preview.scaleFrame()},centerFrame:function(d){d=d||utils.getParentWindow()||window;var h=d.document,c=h.getElementById("previewPage");if(!c){preview._crossDomainCall(window.parent,"centerFrame");return}var f=c.parentNode,i=f.style,b=preview.availableRect,a=$(c).outerWidth(),j=$(c).outerHeight(),e=b.width/2+b.left,g=b.height/2+b.top;i.marginLeft=-(a/2)+"px";i.marginTop=-(j/2)+"px";i.left="50%";i.top="50%";i.width=a+"px";i.height=j+"px";setTimeout(preview.positionNotes,400)},calcAvailableRect:function(a){a=a||window;var b=a.document;return{width:a.innerWidth,height:a.innerHeight,left:0,top:0}},setFrameSize:function(b,a){$("#previewPage").css({width:b,height:a});preview.scaleFrame()},availableRect:{width:(location.origin==="file://"||location.origin==="null")?window.innerWidth:top.innerWidth,height:(location.origin==="file://"||location.origin==="null")?window.innerHeight:top.innerHeight,top:0,left:0},setAvailableRect:function(a){a=a||preview.calcAvailableRect();preview.availableRect=a;if(preview.canAccessFrame()&&$("#previewPage")[0].contentWindow.preview){$("#previewPage")[0].contentWindow.preview.availableRect=a}else{if($("#previewPage").length){preview._crossDomainCall($("#previewPage")[0].contentWindow,"setAvailableRect",a)}}},canAccessFrame:function(){try{return !!(document.getElementById("previewPage").contentWindow.document)}catch(a){return false}},debouncedPositionAndShowNotes:debounce(function(){preview.positionNotes();preview.showNotes()},300,false)};function debounce(b,d,a){var c;return function(){var h=this,g=arguments;var f=function(){c=null;if(!a){b.apply(h,g)}};var e=a&&!c;clearTimeout(c);c=setTimeout(f,d);if(e){b.apply(h,g)}}}fluid.main.on("previewzoomsliderchanged previewbestfitclick previewfullscreenclick",function(a,b){if(b&&b.sliderValue){preview.pageScale=b.sliderValue}preview.hideNotes();preview.debouncedPositionAndShowNotes();if(b&&b.bestFit){preview.scaleFrame()}else{if(b&&b.fullscreen){preview.scaleFrame(undefined,undefined,true)}}});fluid.main.on("previewshownoteschange",function(a,b){if(b){preview.getNotesElement().style.display="";$(".show-notes-icon").children().eq(0).hide().next().show();preview.positionNotes()}else{preview.getNotesElement().style.display="none";$(".show-notes-icon").children().eq(0).show().next().hide()}});fluid.main.on("keyup",function(a,b){if(!userSettings.isOpen){preview.navigateWithKeys(b)}});fluid.main.on("escpressed",function(){if($("#previewHolder").hasClass("open")){preview.close()}});fluid.main.on("project.opening",function(a,b){if($("#previewHolder").is(":visible")){preview.close()}});module.exports=preview;