var storage=require("./class-storage");var widget=require("./class-widget");var group=require("./class-group");var fns=require("./functions");var utils=require("./utils");var grid=require("./class-grid");var page={frame:null,frameVisible:false,menu:null,displayingMenu:false,orient:function(){var a=$(".screen.active");var c=a.attr("id");var b=$(this).val();page.update({orientation:b},c);a.each(page.resizeAfterOrient);page.updateOptionsMenu();grid.showGrid()},resizeAfterOrient:function(){var c=$(this);var a=c.attr("id");var b=[page.get(a,"height"),page.get(a,"width")];c.css({width:b[0],height:b[1]});c.find(".page").css({width:b[0],height:b[1]});c.find(".page").children(".widgetHolder").css({width:b[0],height:b[1]});page.update({width:b[0],height:b[1]},a);if(fluid.zoom.isEditMode()&&c.hasClass("active")){if($("#"+a).hasClass("active")){page.drawDetailed(a,"init")}}else{page.draw(a,"init")}fluid.main.fire("afterpageorientationchange",c)},updateOptionsMenu:function(){var c=$("#canvasPages > .screen.active").first().attr("id");if(typeof c==="undefined"){return}var k=fluid.main.project.get("pageWH");var n=fluid.main.project.get("homepage");var d=page.get(c,"orientation");var i=fluid.main.project.get("orientation");var j=$("#pageMenu");var l=n==c?"This is the start page":"Make this the start page";var o=n==c?"Start Page":"Make Start Page";var h=n==c?"homePageOn":"homePageOff";var m=page.get(c,"name");m=m==undefined?"":m;$(".homePageStatusText").text(l);$(".homePageStatusText").attr("alt",o).attr("title",o);$(".iconPageSettingsIndicator").not(".gridOff, .gridOn, .snapToWidgetsOff, .snapToWidgetsOn").removeClass("homePageOn homePageOff").addClass(h).attr("alt",o).attr("title",o);j.find(".pageSize.rangeWidget.width>input").val(page.get(c,"width"));j.find(".pageSize.rangeWidget.height>input").val(page.get(c,"height"));j.find(".orientationSelector2").find("[value='"+i+"']").attr("selected","selected");var b=j.find(".buttonSwitchContainer");b.children().removeClass("activeOption");b.find("[data-for='"+d+"']").addClass("activeOption");$(".inputPageTitle").val(m);var a=fluid.main.project.get("deviceModel");var f=$("#DeviceSizeTmpl");var g=$("#deviceModelTemplate");if(a){$("option[data-type='"+a+"']",f).attr("selected","selected");$("option[data-type='"+a+"']",g).attr("selected","selected")}else{var p=fluid.main.project.get("pageWH");var e=false;$.each(f.children(),function(q,t){if($(t).val()!="Custom"){var r=$(t).val().split(",");if(((p[0]==r[0])&&(p[1]==r[1]))||((p[0]==r[1])&&(p[1]==r[0]))){$(t).attr("selected","selected");var s=$(t).attr("data-type");$("option[data-type='"+s+"']",g).attr("selected","selected");e=true;return false}}});if(!e){$("option[data-type='Custom']",f).attr("selected","selected");$("option[data-type='Custom']",g).attr("selected","selected")}}if($("option:selected",f).val()=="Custom"){$(".screenSize").parents("tr").children().show()}else{$(".screenSize").parents("tr").children().hide()}fns.updateTLWH();var m=page.get(c,"name");fluid.main.fire("afteroptionsmenuupdated")},addViaLinkDrop:function(d,j,i,b,h,f){var c=$("#viewport");var a=page.add({x:(c.get(0).scrollLeft+c.width()*0.75),y:(c.get(0).scrollTop+c.height()*0.5)},b,h);if(!a){return}var e="ahref";var g=fluid.zoom.getselectedBeforeZoomOut();fluid.main.fire("pageaddedvialinkdrop",g,a,e);$(canvas).fadeIn(600);return a},click:function(c){group.deselect();if(!fluid.zoom.isZoomingNow()&&c.target.tagName!=="TEXTAREA"){var b=$(this).closest(".screen").attr("id");if(!b){b=$(this).closest(".scaled-screen").attr("id").split("-")[1]}var a=c.originalEvent&&$(c.originalEvent.target);if(a&&(a.hasClass("track")||a.hasClass("thumb"))){return}if(fluid.zoom.getCtx()==="project"||b!==$(".screen.active").attr("id")){fluid.zoom.zoomToPage({pageId:b,clientX:c.clientX,clientY:c.clientY,shiftKey:c.shiftKey||c.ctrlKey})}fluid.controllers.bin.show();page.hideOptionsMenu()}},makeHome:function(b,a){if(typeof a==="undefined"){a=$(this).closest(".screen")}if($(a).hasClass("template")){return}var c=$(a).attr("id");fluid.main.project.set({homepage:c});page.updateOptionsMenu();$(".scaled-screen").removeClass("homePage");$(a).addClass("homePage")},removeHome:function(a){fluid.main.project.set({homepage:a||null});if(a){$("#scaled-"+a+".scaled-screen").addClass("homePage")}page.updateOptionsMenu()},add:function(e,b,d){if(fluid.main.project.isReadOnly()){fluid.main.fire("showAlertEditInactive");return false}if(fluid.zoom.isEditMode()){return}var a=$("#cmLink").data("lastClicked")||0;if((new Date()).getTime()<a+600){return}var c=page.create(e.y/fluid.zoom.getCurrentScale(),e.x/fluid.zoom.getCurrentScale());return c},correctPageCoords:function(f,e){var a=fluid.zoom.getCurrentScale();var c=fluid.main.project.get("canvasWidth");var d=fluid.main.project.get("canvasHeight");var b=fluid.main.project.get("pageWH");if(e+b[1]>d){e=d-b[1]}if(f+b[0]*a>c){f=c-b[0]}return{left:f,top:e}},create:function(e,f,g,d){var h=fluid.main.project.get("pageWH");var c=fluid.main.project.get("orientation");if(d){if(page.lastCameraY){if(page.lastCameraY===viewport.scrollTop){if(c==="Portrait"){f=page.lastPageX+h[0]+20}else{f=page.lastPageX+h[1]+20}page.lastPageX=f}else{page.lastCameraY=viewport.scrollTop;page.lastPageX=f}}else{page.lastCameraY=viewport.scrollTop;page.lastPageX=f}}var j=page.correctPageCoords(f,e);if(!fluid.main.fire("page.beforeAdd")){return}var a={x:j.left,y:j.top,width:h[0],height:h[1],orientation:c,widgets:[]};var b=utils.guid("x");page.addPageToProject(b);storage.set(b,a);page.template(a,b,g);$("#zoomedOutPages").append('<div id="scaled-'+b+'" class="scaled-screen"></div>');var i=fluid.zoom.getCurrentScale();$("#scaled-"+b).css({top:storage.get(b).y*i,left:storage.get(b).x*i,width:storage.get(b).width*i,height:storage.get(b).height*i});if(!g){$("#scaled-"+b).bounce()}fluid.main.fire("pageadded",b);return b},addPageToProject:function(b){var a=fluid.main.project.get("pages")||[];a.push(b);fluid.main.project.set({pages:a})},hideOptionsMenu:function(c){page.hideNotes();page.pageMenuClick();$("#pageMenus").children().addClass("hide");var b=$(".zoomModeSwitch .buttonSwitch.activeOption").attr("data-for");var d=$(".screen.active");if(b!==undefined&&d.length&&b!==fluid.main.account.get("zoomMode")){fluid.main.account.set({zoomMode:b});fluid.zoom.zoomToPageDebounced({pageId:d.attr("id"),forceZoom:true})}var a=parseInt($("#zoomToInput").val(),10);if(a&&d.length&&a!==fluid.main.account.get("zoomTo")){fluid.main.account.set({zoomTo:a});fluid.zoom.zoomToPageDebounced({pageId:d.attr("id"),forceZoom:true})}},toggleOptionsMenu:function(b){var a=document.getElementById("pageMenu"),c;if(!a){return}c=!a.classList.contains("hide");page.pageMenuClick();page.updateOptionsMenu();page.toggleMenus();if(!c){a.classList.remove("hide")}},toggleSettingsMenu:function(b){var a=document.getElementById("deviceSettingsMenu"),c=!a.classList.contains("hide");page.pageMenuClick();page.updateSettingsMenu();page.toggleMenus();if(!c){a.classList.remove("hide")}},hideSettingsMenu:function(){var a=document.getElementById("deviceSettingsMenu"),b;b=!a?false:!a.classList.contains("hide");if(b){a.classList.remove("hide")}},updateSettingsMenu:function(){var g=utils.getActivePageId();var b=fluid.main.project.get("pageWH");var c=page.get(g,"orientation");var e=fluid.main.project.get("orientation");$("#currentDeviceSize").text(b[0]+"X"+b[1]);var a=fluid.main.project.get("deviceModel");if($("#deviceModelTemplate").attr("data-type")!=a){var d=$("#deviceModelTemplate").attr("data-type",a).val();$("#deviceModelTemplate").val(d)}var f=$("#deviceSettingsMenu").find(".buttonSwitchContainer");f.children().removeClass("activeOption");f.find("[data-for='"+e+"']").addClass("activeOption")},toggleSnapSettings:function(){var a=document.getElementById("snapSettingsPanel"),b;b=!a.classList.contains("hide");if(b){page.hideOptionsMenu();return}page.showDefaultSnapOptions()},showDefaultSnapOptions:function(){page.toggleMenus();document.getElementById("snapSettingsPanel").classList.remove("hide");var c=fluid.main.account.get("gridStatus");var b=fluid.main.account.get("snapToWidget");(c=="on")?$("#gridSwitchOn").show():$("#gridSwitchOff").show();(b=="on")?$("#snapSwitchOn").show():$("#snapSwitchOff").show();var d=fluid.main.account.get("zoomMode");var a=fluid.main.account.get("zoomScroll");if(!d||d==="Smart"){$(".zoomModeSwitch .buttonSwitch[data-for=Smart]").addClass("activeOption")}else{$(".zoomModeSwitch .buttonSwitch[data-for=Fixed]").addClass("activeOption")}var e=parseInt(fluid.main.account.get("zoomTo"),10);if(!e){e="100"}$("#zoomToInput").val(e+"%");if(!a||a==="ScrollOn"){$(".zoomScrollSwitch .buttonSwitch[data-for=ScrollOn]").addClass("activeOption");$(".zoomScrollSwitch .buttonSwitch[data-for=ScrollOff]").removeClass("activeOption")}else{$(".zoomScrollSwitch .buttonSwitch[data-for=ScrollOff]").addClass("activeOption");$(".zoomScrollSwitch .buttonSwitch[data-for=ScrollOn]").removeClass("activeOption")}},resize:function(e,c,i){var g=fluid.main.project.get("pageWH");var h=fluid.main.project.get("orientation");var f=page.get(e,"orientation");if(f!=h){g=[g[1],g[0]]}if((c<g[0])||(isNaN(c))){c=g[0]}else{if(c>g[0]){$(".pageSize").filter(".width").val(c)}}if((i<g[1])||(isNaN(i))){i=g[1]}else{if(i<g[1]){$(".pageSize").filter(".height").val(i)}}var b=$("#"+e+" .page");page.update({width:c,height:i},e);b.parent(".screen").css({width:c,height:i});b.css({width:c,height:i});b.children(".widgetHolder").css({width:c,height:i});var a=$("#"+e+" .backgroundWidget");var d={top:0,left:0,width:c,height:i};page.autoWidth(b.parent(".screen"));grid.showGrid();fluid.main.fire("pageresized",b);return false},get:function(a,c){if(typeof a!="string"){return""}var b=storage.get(a);if(typeof b==="undefined"||!b){return""}return b[c]},updateDragPos:function(f){var g=$(f);var i=fluid.zoom.getCurrentScale();var d=g.attr("id").indexOf("scaled-")!==-1?true:false;var c=d?g.attr("id").split("-")[1]:g.attr("id");if(!g.data().draggable){return}var h=d?g.data().draggable.position.top:Math.round(g.data().draggable.position.top/i);var b=d?g.data().draggable.position.left:Math.round(g.data().draggable.position.left/i);g.data().draggable.position.top=h;g.data().draggable.position.left=b;var a=fluid.main.project.get(c,{returnModel:true});var e=a.getBox();e[0]=b/fluid.zoom.getCurrentScale();e[1]=h/fluid.zoom.getCurrentScale();a.set({box:e},{silent:true});fluid.main.fire("pagedragged",g);if(fns.intersectTrash(g)==true){$("#trash").addClass("droppableStyle")}else{$("#trash").removeClass("droppableStyle")}},dragStart:function(a){if(fluid.main.project.isReadOnly()||fluid.zoom.isZoomingNow()){return false}if(fluid.zoom.isEditMode()){$("#canvasLinks").hide()}},drag:function(){page.updateDragPos(this)},dragStop:function(i){var h=$(this);var l=h.position();var g=h.attr("id").indexOf("scaled-")!==-1?true:false;var f=g?h.attr("id").split("-")[1]:h.attr("id");var c=$("#scaled-"+f);var k=storage.get(f);var j=fluid.main.project.toJSON();var d=j.canvasWidth-k.width;var b=j.canvasHeight-k.height;var m=fluid.zoom.getCurrentScale();var a=Math.min(Math.max(Math.round(l.left/m),0),d);var n=Math.min(Math.max(Math.round(l.top/m),0),b);fluid.command.create("move",{id:f,x:a,y:n}).dispatchTo("fluid.controllers.page");h.appendTo(h.parent("#canvasPages"));c.appendTo(c.parent("#zoomedOutPages"));fluid.zoom.updatePagesBounding();if(fluid.zoom.getCtx()==="page"){fluid.zoom.zoomToPage(f)}if(l.top<0){h.css({top:0})}else{if(l.top/m>b){h.css({top:(j.canvasHeight-k.height)*m})}}if(l.left<0){h.css({left:0})}else{if(l.left/m>d){h.css({left:(j.canvasWidth-k.width)*m})}}fluid.main.fire("afterpagedragged",f)},selectStart:function(a){if(fluid.main.project.isReadOnly()){a.preventDefault();a.stopPropagation();return false}},selectStop:function(b){var a=document.querySelectorAll("#canvasPages .ui-selected");fluid.main.fire("dragselection",{selected:a});if(fluid.selection.getSelectionModel().models.length){fluid.zoom.onSelectionChangedDebounced(b,null,{sourceEvt:"dragselection"})}},updatePageName:function(){var b=$(this).val(),a=$(this).parents(".screen");if(a.length){page.update({name:b},a.attr("id"))}},template:function(b,g,f){var e=$.extend(true,{},b);e.id=g;var d=page.get(g,"width");var a=page.get(g,"height");e.screenWH=[d,a];var c=$("#tmplPage").tmpl(e).appendTo("#canvasPages");if(e.id===fluid.main.project.get("homepage")){c.addClass("homePage")}},updatePagePreviewButton:function(){var d=$("#pagePreview"),c=fluid.zoom.getCurrentScale(),b=$(".canvasObject.active").attr("id"),a=storage.get(b).width*c;pageButtonsWidth=243;if(b&&storage.get(b).widgets.length===0){d.parent().hide()}else{d.parent().show()}},updateNotesIcon:function(){var b=document.querySelector(".canvasObject.active"),a=document.getElementById("pageAddNote");if(!b||!a){return}var c=storage.get(b.id).notes;if(c&&c[3]){a.classList.add("written")}else{a.classList.remove("written")}},hideNotes:function(){var a=document.getElementById("pageNote");if(!a){return}if(!a.classList.contains("hide")){page.saveNotesInput()}a.classList.add("hide")},showNotes:function(){page.hideOptionsMenu();var a=document.getElementById("pageNote");if(!a){return}page.setNotesTextboxValue();a.classList.remove("hide")},saveNotesInput:function(){var b=$(".canvasObject.active").attr("id"),a=$("#pageNote textarea");page.update({notes:[a.width(),a.height(),"",a.val()]},b);page.updateNotesIcon()},setNotesTextboxValue:function(){var b=document.getElementById("pageNote"),a=document.querySelector(".canvasObject.active").id,c=page.get(a,"notes")||[200,120,"",""];$("textarea",b).css({width:c[0],height:c[1]}).val(c[3])},toggleNotes:function(){var a=document.getElementById("pageNote");if(a.classList.contains("hide")){page.showNotes()}else{page.hideNotes()}},toggleMenus:function(){page.hideOptionsMenu();$("#pageMenus").show()},activate:function(c,b,e,d){var a;if(typeof(c)==="string"){a=c;c=$("#"+c)[0]}else{if($(c).hasClass("scaled-screen")){a=$(c).attr("id").split("-")[1];c=$("#"+a)[0]}}page.deactivate({activatingId:a});function f(){if(fluid.zoom.getCtx()==="project"){return}$("#canvasPages .screen.active").not($(c)).add(d).removeClass("active").each(function(){var i=$(this).attr("id");page.draw(i,"init")});$(c).addClass("active");var g=document.querySelector("#canvasPages .active");if(!fluid.main.project.isReadOnly()&&g){page.attachFrameTo(g)}page.updateOptionsMenu();var h=b==undefined?true:b;page.displayMenu(h);if($(c).find(".page-preview").length){page.drawDetailed($(c).attr("id"),"init")}if(e==="wdgDrag"){widget.afterSelectionChange()}group.drawExisting(a);fluid.main.fire("pageactivated",a)}f()},deactivate:function(a){var b=$("#canvasPages .screen.active");b.each(function(){if(!a||!a.activatingId||$(this).attr("id")!==a.activatingId){$(this).removeClass("active");$(this).selectable("destroy").removeData("initSelectable");$(this).draggable("destroy").removeData("initDraggable");var d=$(this).attr("id");var c=fluid.main.project.pages.get(d);if(c.attributes.imgData){page.draw(d,"useCache")}else{page.draw(d,"init")}}});page.detachFrame();widget.resetCache()},detachFrame:function(){if(page.frameVisible){page.frame.parentNode.removeChild(page.frame);page.menu.parentNode.removeChild(page.menu);page.frameVisible=page.displayingMenu=false;page.frame.style.display="none"}},attachFrameTo:function(a){page.frame=page.frame||document.getElementById("pageFrame");page.menu=page.menu||document.getElementById("pageMenus");page.frame.style.display="none";a.appendChild(page.menu);a.querySelector(".page").appendChild(page.frame);page.adjustPageFrameScale(a);page.frameVisible=page.displayingMenu=true;page.setNotesTextboxValue();page.updatePagePreviewButton()},adjustPageFrameScale:function(a){if(!page.frame){return}requestAnimationFrame(function(){var m=fluid.zoom.getCurrentScale();var b=51;var d=$(page.frame).closest(".screen").attr("id");if(!d&&a&&a.id){var h=$(a).find(".page");h.append(page.frame);d=a.id}if(!d){return}var i=storage.get(d);var k=i.width*m;var l=243;var j=41;var f=50/m;var e=$("#pageExpander");page.updatePagePreviewButton();var c=0;$("#pageSettingsMenu li").each(function(){if($(this).css("display")!=="none"){c++}});l=j*c;$("#pageSettingsMenuContainer").width(l+j);if(k<l){b=b+(l-k)/4;f=((k+2*b-l)/2+1)/m}else{if(i.widgets.length){$("#pageSettingsMenu li").show()}else{$("#pageSettingsMenu li > a:not(#pagePreview)").parent().show()}e.addClass("expanded").add(e.parent("li")).hide()}$(".pageBackground").css({"border-radius":(32/m)+"px"});$(".pageDragHandle").css({height:26/m,"border-bottom-width":1/m+"px","border-radius":(32/m)+"px "+(32/m)+"px 0 0"});page.frame.style.top=((-86)/m)+"px";page.frame.style.bottom=(-50/m)+"px";page.frame.style.left=(-b/m)+"px";page.frame.style.right=(-b/m)+"px";$("#pageSettingsMenuContainer").css({top:(((21+16)/m)+0)+"px",left:f+"px",transform:"scale("+1/m+")","transform-origin":"left top"});$("#pageMenus").css({transform:"scale("+(1/m)+")","transform-origin":"left top",left:(-b/m)+"px",top:(-78/m)+"px"});$("#pageMenus").children().each(function(n){$(this).css({left:(f*m+j*n)})});var g=$("#pageMenu").add("#deviceSettingsMenu").add("#snapSettingsPanel");g.show();$("#"+page.focusedInputId).focus().select();$(page.frame).fadeIn(250)})},onExpanderHovered:function(b){var a=$("#pageExpander");if(b.type==="mouseenter"){a.addClass("visible")}else{if(!a.hasClass("expanded")){a.removeClass("visible")}}},toggleSettingsBtns:function(){var c=$("#pageSettingsMenu li");if(!$(this).hasClass("expanded")){var a=0;var b=$(this).parents(".screen").attr("id");c.each(function(){if($(this).find("#pageExpander").length&&storage.get(b).widgets.length===0){$(this).css({left:a}).show()}else{$(this).css({left:a}).show();a=a+40}});$(this).addClass("expanded");page.updatePagePreviewButton()}else{page.hideOptionsMenu();c.each(function(){$(this).css({left:$(this).find("#pageExpander").length?40:0})});$(this).removeClass("expanded");setTimeout(function(){c.not($("#pageExpander").parents("li")).not($("#pageMenuToggle").parents("li")).hide()},300)}},displayMenu:function(b){var d=b==undefined?true:b;var e=true;if((fluid.main.project.isReadOnly()||(fluid.zoom.getCtx()==="project"))){e=false}if(e){page.updateNotesIcon();page.updatePagePreviewButton()}if(d&&e){function c(){if((page.displayingMenu)&&($("#pageSettingsMenuContainer").css("display")=="none")){$("#pageSettingsMenuContainer").fadeIn(300)}page.displayingMenu=false}page.displayingMenu=true;page.displayMenuTimer=setTimeout(c,200)}else{if(e){var a=fluid.selection.getSelectionModel().getRoots().getElements();if((a.length==1)&&($(".ui-selected").hasClass("backgroundWidget"))){page.displayMenu();return}}page.displayingMenu=false;$("#pageSettingsMenuContainer").stop(true,true).hide()}},del:function(b){function a(d,c){$(d).remove();if(fluid.main.project.pages.length===0){fluid.main.fire("pagedeleted",c);fluid.zoom.updatePagesBounding();return}if(fluid.main.project.widgets.length===0){$("#previewView, #preview, #pagePreview, #shareMenu").addClass("hud-hidden");$("#pagePreview").parent().hide()}fluid.main.fire("pagedeleted",c);fluid.zoom.updatePagesBounding()}b.each(function(){var c=$(this);var e=c.attr("id");fluid.main.fire("beforepagedeleted",e,c);var f=c.find("#canvasPages .widgetHolder > .pageWidget");f.each(function(){var h=$(this);widget.del(h)});page.deleteFromProject(e);storage.remove(e);if(e==fluid.main.project.get("homepage")){var g=fluid.main.project.get("pages");var d=g&&g.length?g[0]:null;page.removeHome(d)}c=c.add("#scaled-"+e);c.fadeOut(450,a(c,e));fluid.main.fire("afterpagedeleted",e,c)})},deleteFromProject:function(d){var c=null;var a=fluid.main.project.get("pages");for(var b=0;b<a.length;b++){if(a[b]==d){c=b;break}}a.splice(c,1);fluid.main.project.set({pages:a});page._deletePageWidgets(d)},_deletePageWidgets:function(d){var c=storage.get(d);if(c){for(var b=0,a=c.widgets.length;b<a;b++){storage.remove(c.widgets[b])}}},drawRasterised:function(e,d,a,c){page.checkIntegrity(e);var b=page.calculateWdgPositions(e);this.renderer.afterPageRendered=d;if(!b||b.widgets===0){return}this.renderer.renderPage(b,a,c)},draw:function(b,h){if(!b){return}page.checkIntegrity(b);var j=page.calculateWdgPositions(b);if(this.renderer.renderingQueue[j.id]&&this.renderer.renderingQueue[j.id].length){return}this.renderer.afterPageRendered=null;var i=$("#"+b);if(i.length===0){page.template(j,b,h);i=$("#"+b)}else{var a=i.find(".pageWidget");setTimeout(function(){a.remove()},650)}var c=i.find(".widgetHolder");if($("#scaled-"+b).length===0){$("#zoomedOutPages").append('<div id="scaled-'+b+'" class="scaled-screen"></div>');var k=fluid.zoom.getAllPagesParams().newScale;$("#scaled-"+b).css({top:storage.get(b).y*k,left:storage.get(b).x*k,width:storage.get(b).width*k,height:storage.get(b).height*k})}var l=storage.get(b,{returnModel:true}).get("imgData");if(h==="useCache"&&l){i.find(".page-preview, .pageWidget").remove();var f=new Image();var e=new Image();f.src=l;e.src=l;c.append(f);c.find("img").addClass("page-preview");$("#scaled-"+b).get(0).innerHTML="";$("#scaled-"+b).append(e);return}if(!j){return}else{if(j.widgets.length===0){$("#scaled-"+b).empty();return}}var g=this.renderer.renderPage(j);group.erase();i.find(".page-preview").remove();if(g.length){var d;if(g[0].$shapeRendition){d=g[0].$shapeRendition}else{if(g[0].$textRendition){d=g[0].$textRendition}else{if(g.length&&g[0].segments){d=g[0].segments[0].$shapeRendition}}}if(d){d.addClass("page-preview");c.append(d)}}},calculateWdgPositions:function(d){if(!this.renderer){this.renderer=new fluid.wdgRenderer()}var a=storage.get(d);if(a.widgets&&a.widgets.length>0){var c={};for(var b=0;b<a.widgets.length;b++){c[a.widgets[b]]=widget.get(a.widgets[b])}}a.widgets=c||[];a.id=d;this.renderer.canvasSize=[a.width,a.height];return a},drawDetailed:function(g,f,d){page.calculateWdgPositions(g);var c=$.extend({},storage.get(g));if(!c){return false}var a=$();var b=$("#"+g);if(b.length===0){page.template(c,g,f)}else{a=b.find(".pageWidget")}if(c.widgets.length>0){widget.load(g,c.widgets);fns.updateTLWH()}var e=$("#"+g).find(".page-preview");setTimeout(function(){e.remove()},200);a.remove();if(d&&d.restoreSelection){$("#"+d.restoreSelection).click()}},updateView:function(a,b){var c=true;if(b&&b.zoomedOutOnly){c=false}if(!c&&fluid.zoom.isEditMode()&&$("#"+a).hasClass("active")){page.drawDetailed(a,"init")}else{if(!fluid.zoom.isEditMode()){page.draw(a,"init")}}},move:function(f,a,e){page.update({x:a,y:e},f);var b=$("#"+f);var c=$("#scaled-"+f);var d=b.position();if(d.left!=a||d.top!=e){b.css({left:a+"px",top:e+"px"});c.css({left:(a*fluid.zoom.getCurrentScale())+"px",top:(e*fluid.zoom.getCurrentScale())+"px"});fluid.main.fire("pagemoved",b)}},update:function(b,d){var a=storage.get(d,{getAll:true});if(!a){return}for(var c in b){a[c]=b[c]}storage.set(d,a)},orderWidgets:function(d){var b=$(d).parents("li.canvasObject").attr("id");var c=$(d).find(".pageWidget");var a=[];c.each(function(){a.push($(this).attr("id"))});page.update({widgets:a},b)},removeWidget:function(a,d){var c=storage.get(a);if(!c){return}var b=$.inArray(d,c.widgets);c.widgets.splice(b,1);storage.set(a,c)},enableSelectableWidgetHolder:function(a){if($(".selectArea").data("selectable")){var c=$(".selectArea").selectable("option","cancel").split(/\s*,\s*/);var b=c.indexOf(".widgetHolder");if(a||a===undefined){if(b>-1){c.splice(b,1);$(".selectArea").selectable("option","cancel",c.join(","))}}else{if(b==-1){c.push(".widgetHolder");$(".selectArea").selectable("option","cancel",c.join(","))}}}},isLinked:function(b,f){var d=fluid.main.project.links.toJSON();var a=page.get(b,"widgets");var e;for(var c=0;c<a.length;c++){e=d.linkOrigin.indexOf(a[c]);if(e!=-1){if(d.linkDest[e]==f){return d.linkCanvId[e]}}}return false},checkIntegrity:function(b){if(b){var c=page.get(b,"widgets");if(c){var a=storage.get(b);$.each(c,function(d,e){if(!widget.checkIntegrity(e,a)){return false}})}}},autoWidth:function(g){var c=$(g).children(".page");var e=$(g).attr("id");var h=c.children(".widgetHolder");var d=h.children(".rootWidget");for(var f=0;f<d.length;f++){var k=$(d[f]);var b=k.attr("id");var i=storage.get(b);if((typeof(i.tlwh[0])==="string")||(typeof(i.tlwh[1])==="string")||(typeof(i.tlwh[2])==="string")||(typeof(i.tlwh[3])==="string")){var a=widget._setTMPLVars(b,i,[0,0,c.width(),c.height()]);k.css({top:a.absTLWH[0],left:a.absTLWH[1],width:a.absTLWH[2],height:a.absTLWH[3]});widget._resize(k,e,a.tlwh)}}},duplicate:function(e){var a=$("#"+e);var d=$(".page",a);var c=page.get(e,"orientation");var b={top:parseFloat(a.css("top")),left:parseFloat(a.css("left"))+parseFloat(d.css("width"))+100};var f={width:parseFloat(d.css("width")),height:parseFloat(d.css("height"))};var j=page.get(e,"name");var g=j==undefined||j==""?"":j+" - Copy";var i=page.create(b.top,b.left,"init");if(i){var k=$("#"+i);page.update({orientation:c},i);page.update({name:g},i);page.resize(i,f.width,f.height);var l=$.extend(true,{},widget._copies);widget.resetSelection();var h=storage.get(e,{returnModel:true}).get("widgets");widget._copy(null,h,false,e);page.activate(k,false);fluid.zoom.zoomToPage(k);if(widget._copies.oldId.length>0){widget._paste(null)}widget._copies=$.extend(true,[],l);l=null;widget.resetSelection()}return i},createNew:function(e){var i=$("#canvas");var j=fluid.zoom.getCurrentScale();var b=(e==="button");var h=fluid.main.project.get("pages");var a;e=e||"init";if(fluid.zoom.isEditMode()){var c=$(".screen.active").attr("id");if(!c){if(h.length){c=h[h.length-1]}}if(c){var g=storage.get(c);a={top:g.y,left:g.x+g.width+100}}else{var f=$("#viewport");a={top:Math.abs(parseInt(i.css("top"),10))+Math.round(f.height()/2),left:Math.abs(parseInt(i.css("left"),10))+Math.round(f.width()/2)+450}}}else{var f=$("#viewport");a={top:(f.get(0).scrollTop+Math.round(f.height()/2))/j,left:(f.get(0).scrollLeft+Math.round(f.width()/2))/j};e=""}var d=page.create(a.top,a.left,e,b);if(d){page.postCreate(d)}return d},postCreate:function(c,b){if(fluid.zoom.getCtx()!=="project"){var a=$("#"+c);page.activate(a,undefined,b);fluid.zoom.zoomToPage(a);widget.resetSelection()}},serialize:function(g){var d=storage.get(g);if(!d){return}var c={id:g};c[g]=d;var f=d.widgets;for(var b=0,a=f.length;b<a;b++){var e=storage.get(f[b]);if(!e){continue}c[f[b]]=e}return JSON.stringify(c)},deserialize:function(i,c){var k=JSON.parse(i);if(k){var a=k.id;var e=k[a],f=!fluid.main.project.get(a);if(!e){return}storage.set(a,e);page.addPageToProject(a);var g=e.widgets;for(var j=0,d=g.length;j<d;j++){var b=g[j];var h=k[b];if(h){storage.set(b,h)}}if(fluid.zoom.getCtx()==="project"){page.draw(a,c)}else{page.drawDetailed(a,c)}if(f){page.postCreate(a,c)}}},navigateWithKeys:function(h){if(fluid.zoom.getCtx()==="project"||!$("#canvas").hasClass("editing")){return true}var i=h!=undefined?utils.getNavigationKeyDirection(h.keyCode):"right";if(i==""){return true}var b=$(".ui-selected").not(".backgroundWidget");if(b.size()>0){return}var c=fluid.main.project.get("pages");if(c<2){return}var f={distance:Number.MAX_VALUE,id:""};var d={distance:0,id:""};var g=$(".screen.active").attr("id");var k={x:page.get(g,"x"),y:page.get(g,"y")};$.each(c,function(l,e){if(g!=e){var n={x:page.get(e,"x"),y:page.get(e,"y")};var m=page._getNavigationDistanceFrom(k,n,i);if((m>=0)&&(m<f.distance)){f={distance:m,id:e}}else{if((m<0)&&(m<d.distance)){d={distance:m,id:e}}}}});var a=f.id!=""?f.id:d.id;if(a!=""){var j=$("#"+a);$(".screen").removeClass("active").filter(j).addClass("active");fluid.zoom.zoomToPage(j);page.activate(j);widget.resetSelection()}},_getNavigationDistanceFrom:function(a,d,c){if(a==d){return -1}var b=0;if((c=="left")||(c=="right")){b=d.x-a.x}else{b=d.y-a.y}if(((c=="left")||(c=="top"))&&(b<0)){return Math.abs(b)}else{if(((c=="right")||(c=="bottom"))&&(b>0)){return b}}return Math.abs(b)*-1},pageMenuClick:function(){$("input","#pageMenus").blur();return false},renderBlurs:function(a){a=a||((a=document.querySelector(".canvasObject.active"))&&a.id);if(!a){return}page.calculateWdgPositions(a);storage.get(a).widgets.forEach(function(b){var c=document.getElementById(b);if(!c){return}if(storage.get(b).blur){widget.blurLayers[b]=widget.renderBlurLayer(b,a);widget.setBlurBG(c)}})}};fluid.main.on("afterzoomaction",function(){page.hideSettingsMenu()});fluid.main.on("beforezoomout",function(a,c,b){page.hideOptionsMenu();if(!c.keepActivePage&&c.newCtx==="project"){page.deactivate()}else{if(c.newCtx==="project"){fluid.zoom.setSelectedBeforeZoomOut($("#canvasPages .ui-selected").attr("id"));page.draw(b,"init")}}page.hideOptionsMenu();if(c.newScale!==c.oldScale){page.detachFrame();page.adjustPageFrameScale()}});fluid.main.on("afterzoomedtopage",function(a,b){if(b.newScale!==b.oldScale||$("#canvasPages .screen.active").attr("id")!==b.pageId){page.activate(b.pageId)}page.enableSelectableWidgetHolder()});fluid.main.on("beforezoomin",function(a,b){var c=$("#pageMenu");if(!c.hasClass("hide")&&fluid.zoom.getCurrentScale()!==b.newScale){page.focusedInputId=c.find("input:focus").attr("id");c.hide()}});fluid.main.on("beforewidgetadd",function(b,c){var a=fluid.main.project.pages.get(c);if(a&&a.get("widgets").length===0){$("#previewView, #preview, #pagePreview, #shareMenu").removeClass("hud-hidden");$("#pagePreview").parent().show();page.makeHome(null,$("#"+c))}});fluid.main.on("beforelinkadded",function(a,d,c){if(!fluid.main.project.hasLinks()){var b=$("#"+c);page.makeHome(null,b)}});fluid.main.on("wdgselection librarywdgdragstart",function(){if($("#pageMenu").is(":visible")){page.hideOptionsMenu()}});fluid.main.on("widgetDropped widgetDroppedUndone",function(){page.adjustPageFrameScale($(".screen.active"))});fluid.main.on("widgetdragstart",page.hideOptionsMenu);fluid.main.on("afterzoomedtoselection",page.adjustPageFrameScale);fluid.main.on("afterzoomedonselectioreset",function(a,b){if(b.oldScale!==b.newScale){page.activate($(".screen.active").attr("id"))}else{page.displayMenu()}});fluid.main.on("widgetdragstart",function(){page.displayMenu(false)});fluid.main.on("afterwidgetdragstop",function(a,b){if(!b.dragStartSelection.length){page.displayMenu();$(".ui-selected").removeClass("ui-selected")}});fluid.main.on("zalignmentchange",function(a,b){if(b.renderBlurs){page.renderBlurs(b.pageId)}});fluid.main.on("beforelogout",function(){page.detachFrame()});fluid.main.on("linkdragstart",function(a,b){page.calculateWdgPositions(b)});fluid.main.on("project.orientantionchanged",function(){page.updateSettingsMenu()});fluid.main.on("resolutionChanged",function(){page.adjustPageFrameScale()});fluid.main.on("fluidmenutoggled beforepreviewopen beforesharetoggle libmousedown",function(){page.hideOptionsMenu()});module.exports=page;