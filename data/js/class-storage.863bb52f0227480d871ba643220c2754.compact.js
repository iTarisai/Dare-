var main=require("./fluid/fluid.main");var projects=require("./fluid/models/project");var uplds=require("./fluid/models/upload");var acc=require("./fluid/models/account");var dbStorage=require("./class-dbStorage");var fluidEvent=require("./class-event");var getParentWindow=require("./utils").getParentWindow;var locStorage={tempStorage:{},cachedUpdates:{},caching:false,lastUpdate:new Date().getTime(),get:function(b){if(storage.tempStorage[b]){return storage.tempStorage[b]}if(localStorage){var a=localStorage.getItem(b);if(a){storage.tempStorage[b]=JSON.parse(a);return storage.tempStorage[b]}}return null},tabSynchronisationCheckInterval:3000,lastTabSynchronisationCheck:null,set:function(i,f,a){if(!i||!f){return}var h=a==undefined?true:a;if(this.lastTabSynchronisationCheck+this.tabSynchronisationCheckInterval<new Date().getTime()){var c=localStorage.getItem("instanceId");if(c&&parseInt(c)!=g_instanceId){var g=localStorage.getItem("restoreMyInstanceId");if(g){storage._setItem("instanceId",g_instanceId);localStorage.removeItem("restoreMyInstanceId");return}storage._setItem("postloadMessage","tab");location.reload();return}}if(typeof(f)=="string"){f=JSON.parse(f)}storage.lastUpdate=this.lastTabSynchronisationCheck=new Date().getTime();if((f)&&(h)){f.updated=storage.lastUpdate}var b=JSON.stringify(f);try{if(this.caching){this.cachedUpdates[i]=f}else{storage._setItem(i,b)}this.tempStorage[i]=f}catch(d){}fluidEvent.triggerEditor("storageChanged",{id:i,obj:f,timeUpdated:h})},remove:function(a){delete this.tempStorage[a];delete this.cachedUpdates[a];localStorage.removeItem(a)},cacheStart:function(){this.caching=true},commitCache:function(){if(!this.caching){return}this.caching=false;for(var a in this.cachedUpdates){this.set(a,this.cachedUpdates[a]);delete (this.cachedUpdates[a])}},setTempItem:function(b,a){this.tempStorage[b]=a},removeItem:function(a){localStorage.removeItem(a)},clear:function(){tempStorage={};cachedUpdates={};localStorage.clear()},_setItem:function(d,a){var c=false;while(!c){try{localStorage.setItem(d,a);c=true}catch(b){if(b&&(b.name=="QUOTA_EXCEEDED_ERR"||b.name=="NS_ERROR_DOM_QUOTA_REACHED"||b.code===22)){projTempObj.unloadOldest()}else{throw b}}}}};var storage={get:function(g,c){var e=g&&g.substr?g.substr(1,1):"";var b,f,a;if(!g){return false}if(g[0]==="p"&&(!fluid.main.project||fluid.main.project.id!==g)&&fluid.main.projects){b=fluid.main.projects.get(g,c);if(c&&c.returnModel){return b}else{return b?b.toJSON():false}}else{if(fluid.main&&fluid.main.project&&((e==="_"&&(g[0]==="p"||g[0]==="x"||g[0]==="w"||g[0]==="l"))||((g[0]==="p"||g[0]==="x"||g[0]==="w"||g[0]==="l")&&g.length===33))){f=fluid.main.project.get(g,c);if(f){return f}else{_.each(fluid.main.projects,function(j,h,k){var i=k.models[h].get(g,c);if(i){f=i}});return f}}else{if(fluid.main&&fluid.main.account&&((e==="_"&&g[0]==="u")||(g[0]==="u"&&g.length===33))){f=fluid.main.account.toJSON();return f}else{if(fluid.main&&fluid.main.uploads&&((e==="_"&&g[0]==="i")||(g[0]==="i")||g.length===33)){b=fluid.main.uploads.get(g);if(c&&c.returnModel){return b}else{return b?b.toJSON():false}}else{if(!(location.origin!=="file://"&&location.origin!=="null")&&window.g_preview&&getParentWindow()&&window.fluid.storage){var d=window.top.fluid.storage.get(g,c);return d}}}}}a=locStorage.get(g);if(g!=="accounts"&&g!=="bin"&&a){}if(a){return $.extend({},a)}else{return false}},set:function(g,f,b){f=_.clone(f);var e=g&&g.substr?g.substr(1,1):"";if(!g||!g.length){}if(e==="_"||((g.length===33)&&(g[0]==="p"||g[0]==="x"||g[0]==="w"||g[0]==="i"||g[0]==="u"))){if(g[0]==="p"&&fluid.main.project){if(fluid.main.project.id===g){fluid.main.project.set(f);return true}else{var d=fluid.main.projects.get(g);if(d){d.set(f);return true}else{return false}}}else{if(g[0]==="u"){if(fluid.main.account&&fluid.main.account.id===g){fluid.main.account.set(f);return true}else{return false}}else{if(g[0]==="i"){if(!f.id){f.id=g}var a=fluid.main.uploads.get(g);if(a){a.set(f)}else{fluid.main.uploads.add(f)}delete f.id;return true}else{if(g[0]==="b"){var c=fluid.main.account.customwidgets.get(g);if(c){c.set(f)}else{fluid.main.account.customwidgets.add(f)}}else{if(fluid.main.project){fluid.main.project.setChild(g,f);return true}}}}}}locStorage.set(g,f,b);return true},remove:function(b){var a=b.substr(0,2);if(a==="w_"){fluid.main.project.widgets.remove(b)}else{if(a==="x_"){fluid.main.project.pages.remove(b)}}return locStorage.remove(b)},cacheStart:function(){return locStorage.cacheStart()},commitCache:function(){return locStorage.commitCache()},setTempItem:function(b,a){return locStorage.setTempItem(b,a)},removeItem:function(a){return locStorage.removeItem(a)},clear:function(){return locStorage.clear()},_setItem:function(b,a){return locStorage._setItem(b,a)},init:function(a){a=_.once(a);if(window.g_preview){a();return}fluid.main.projects=new fluid.Projects();fluid.main.uploads=new fluid.Uploads();dbStorage.onReady(function(){var b=storage.get("accounts");if(b&&b.last){dbStorage.get("accounts",b.last,function(c){if(c.fetched.length){fluid.main.account=new fluid.models.Account(c.resultsObj[c.fetched[0]].data);dbStorage.get("uploadHeaders",fluid.main.account.id,function(f){if(f.fetched.length&&f.resultsArr[0]){var e=fluid.util._.toArray(f.resultsArr[0].data);fluid.main.uploads=new fluid.Uploads(e)}var h=fluid.main.account.get("lastOpenProject");var g=false;var d=fluid.main.account.get("projectIds");if(d.length){dbStorage.get("projects",d,function(m){if(m.fetched.length===0){a()}else{d=_.difference(d,m.failed);for(var l=0;l<m.resultsArr.length;l++){if(m.resultsArr[l]){var j=m.resultsArr[l].id,o=m.resultsArr[l].data,n=m.resultsArr[l].data[m.resultsArr[l].id];if(!n.id){n.id=j}if(j===h){g=true;fluid.main.project=new fluid.models.project(o,{parse:true,projectId:h});fluid.main.projects.add(fluid.main.project,{silent:true});if(fluid.main.project.get("removed")){fluid.main.project.set({removed:false})}d=_.without(d,m.resultsArr[l].id);if(o[h].unloaded){projTempObj.loadIfUnloaded(h,function(){if(d.length===0){a()}},{buildModel:true})}else{dbStorage.get("uploads",_.keys(o.uploads),function(q){if(q.fetched.length){var i;for(var p=0;p<q.resultsArr.length;p++){i=false;if(q.resultsArr[p]&&q.resultsArr[p].id){i=storage.get(q.resultsArr[p].id,{returnModel:true})}if(i&&q.resultsArr[p]&&q.resultsArr[p].data){i.set({imgData:q.resultsArr[p].data},{})}}}if(d.length===0){a()}})}}else{if(n.unloaded){fluid.main.projects.add(n,{silent:true});d=_.without(d,m.resultsArr[l].id);if(d.length===0){a()}}else{var k=new fluid.models.project(o,{parse:true,projectId:j});fluid.main.project=k;fluid.main.projects.add(k,{silent:true});d=_.without(d,m.resultsArr[l].id);if(d.length===0){a()}}}}}if(!g){a()}}})}else{localStorage.clear();localStorage.setItem("badinit",true);dbStorage.clear();setTimeout(function(){location.reload()},200)}})}else{a()}})}else{a()}})},tempStorage:locStorage.tempStorage};if(!fluid){fluid={}}fluid.storage=storage;module.exports=storage;