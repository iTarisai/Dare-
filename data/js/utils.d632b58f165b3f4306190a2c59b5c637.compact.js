var storage=require("./class-storage");(function(){var b=0;var c=["ms","moz","webkit","o"];for(var a=0;a<c.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[c[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[c[a]+"CancelAnimationFrame"]||window[c[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(h,e){var d=new Date().getTime();var f=Math.max(0,16-(d-b));var g=window.setTimeout(function(){h(d+f)},f);b=d+f;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());var utils={ensureInstanceId:function(){var a=localStorage.getItem("instanceId");if(typeof g_instanceId=="undefined"||!g_instanceId||!a||g_instanceId!=a){g_instanceId=1+parseInt(Math.random()*99999999);localStorage.setItem("instanceId",g_instanceId)}},selectText:function(b){var a=(b=="control+a")?$(".ui-selected").find("textarea"):$(this);a.focus();a.select();return false},getTLWH:function(c){var e=$(c);if(e.length==0){return{top:0,left:0,width:0,height:0}}var b=e.offset();var d=e.outerWidth();var a=e.outerHeight();return{top:b.top,left:b.left,width:d,height:a}},getCenterPoint:function(a){var c=utils.getTLWH(a);var d=Math.floor(c.top+(c.height/2));var b=Math.floor(c.left+(c.width/2));return{top:d,left:b}},getTranslateDistanceToCenter:function(t,q){var k=$(t).outerWidth();var r=$(t).outerHeight();var f=parseFloat($(t).css("top"));var j=parseFloat($(t).css("left"));var h=utils.getCenterPoint(q);var s=utils.getTLWH(q);var m=k-s.width;var l=r-s.height;var a=Math.max(0,m,l);var d=a==m?false:true;var b=a==l?false:true;var e=-parseFloat($("#viewport").get(0).scrollTop);var g=-parseFloat($("#viewport").get(0).scrollLeft);var i=b?f+r/2:f;var c=d?j+k/2:j;var p=h.top-i-e;var o=h.left-c-g;if(l>0){var n=0.5*s.height-95;p=p-n}return{top:p,left:o}},getBoundingAreaRelative:function(b){var c=$(b);if(c.length==0){return{top:0,left:0,bottom:0,right:0}}var a={top:null,left:null,right:null,bottom:null};$(c).each(function(){var f=$(this);var d={top:parseFloat(f.css("top")),left:parseFloat(f.css("left")),width:parseFloat(f.css("width")),height:parseFloat(f.css("height"))};if(f.hasClass("screen")){var e=$(".page",f);d={top:parseFloat(f.css("top")),left:parseFloat(f.css("left")),width:parseFloat(e.css("width")),height:parseFloat(e.css("height"))}}if((a.left>d.left)||a.left==null){a.left=~~d.left}if((a.top>d.top)||a.top==null){a.top=~~d.top}if((a.right<d.left+d.width)||a.right==null){a.right=~~(d.left+d.width)}if((a.bottom<d.top+d.height)||a.bottom==null){a.bottom=~~(d.top+d.height)}});return a},getBoundingArea:function(a){utils.boundingLeft=null;utils.boundingTop=null;utils.boundingRight=null;utils.boundingBottom=null;var c=$(a);if(c.length==0){return{top:0,left:0,bottom:0,right:0}}c.each(function(){var d=utils.getTLWH(this);if((utils.boundingLeft>d.left)||utils.boundingLeft==null){utils.boundingLeft=d.left}if((utils.boundingTop>d.top)||utils.boundingTop==null){utils.boundingTop=d.top}if((utils.boundingRight<d.left+d.width)||utils.boundingRight==null){utils.boundingRight=d.left+d.width}if((utils.boundingBottom<d.top+d.height)||utils.boundingBottom==null){utils.boundingBottom=d.top+d.height}});var b={top:utils.boundingTop,left:utils.boundingLeft,bottom:utils.boundingBottom,right:utils.boundingRight};return b},guid:function(b){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var f=32;var d="";for(var c=0;c<f;c++){var a=Math.floor(Math.random()*e.length);d+=e.substring(a,a+1)}return b+"_"+d},prevent:function(a){a.stopPropagation();a.preventDefault();return false},arraysEqual:function(d,c){var e=d.length==c.length;if(e){for(var b=0,a=d.length;b<a;b++){e=d[b]===c[b];if(!e){break}}}return e},hslToHex:function(j){function i(g,b,l){if(l<0){l+=1}else{if(l>1){l-=1}}if(l*6<1){return g+(b-g)*l*6}if(l*2<1){return b}if(l*3<2){return g+(b-g)*(2/3-l)*6}return g}var d=j.h/360,n=j.s/100,c=j.l/100;var m,k;if(c<=0.5){k=c*(1+n)}else{k=c+n-(c*n)}m=c*2-k;var a=i(m,k,d+1/3);var e=i(m,k,d);var f=i(m,k,d-1/3);a=Math.round(a*255);e=Math.round(e*255);f=Math.round(f*255);a=parseInt(a).toString(16);e=parseInt(e).toString(16);f=parseInt(f).toString(16);if(a.length<2){a="0"+a}if(e.length<2){e="0"+e}if(f.length<2){f="0"+f}return a+e+f},hex2rgba:function(d,b){if(!d[0]=="#"){return false}if(d.indexOf("rgba(")===0){return d}if(d.indexOf("rgb(")===0){var c;d=d.replace("rgb(","rgba(");c=d.split(",");c[c.length-1]=parseInt(c[c.length-1]);c.push("1)");d=c.join(",");return d}if(d.length=="4"){d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]}return"rgba("+(parseInt(d.substr(1,2),16))+","+(parseInt(d.substr(3,2),16))+","+(parseInt(d.substr(5,2),16))+","+(b||1)+")"},rgb2hex:function(a){a=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);function b(c){return("0"+parseInt(c).toString(16)).slice(-2)}return"#"+b(a[1])+b(a[2])+b(a[3])},toHSL:function(m){var m=(m)?m:"rgb(0, 0, 0)";m=m.replace(/ /g,"");if(m.match(/hsla/gi)){return{h:m.match(/[0-9]*/g)[5],s:m.match(/[0-9]*/g)[7],l:m.match(/[0-9]*/g)[10]}}if(m.match(/hsl/gi)){return{h:m.match(/[0-9]*/g)[4],s:m.match(/[0-9]*/g)[6],l:m.match(/[0-9]*/g)[9]}}if(m.match(/#/gi)){if(m.length==4){m="#"+m[1]+m[1]+m[2]+m[2]+m[3]+m[3]}else{if(m.length!=7){m="#000000"}}var a=parseInt(m.substring(1,3),16);var i=parseInt(m.substring(3,5),16);var k=parseInt(m.substring(5,7),16)}else{if(m.match(/rgba/gi)){var a=m.match(/[0-9]*/g)[5];var i=m.match(/[0-9]*/g)[7];var k=m.match(/[0-9]*/g)[9]}else{if(m.match(/rgb/gi)){var a=m.match(/[0-9]*/g)[4];var i=m.match(/[0-9]*/g)[6];var k=m.match(/[0-9]*/g)[8]}}}a/=255,i/=255,k/=255;var c=Math.max(a,i,k);var e=Math.min(a,i,k);var f=0;var n=0;var d=(c+e)/2;if(c!=e){var j=c-e;n=(d<0.5)?j/(c+e):j/(2-c-e);switch(c){case a:f=(i-k)/j;break;case i:f=(k-a)/j+2;break;case k:f=(a-i)/j+4;break}f/=6;if(f<0){f+=1}}f=f*360;d=d*100;n=n*100;return{h:f,s:n,l:d}},replaceRgbaAlpha:function(c,b){var d=c.match(/rgba/i);if(d){ret=c.split(",");ret[ret.length-1]=b+")";ret=ret.join(",");return ret}return c},getRgbaAlpha:function(b){if(b[0]=="#"||b.indexOf("rgb(")!=-1){return 1}var a=b.split(",");a=a[a.length-1];a=parseFloat(a);return a},getAlphaFromColor:function(a){if(a[0]=="#"){return 1}else{if(a.indexOf("rgba(")===0){a=a.split(",");a=a[a.length-1].replace(")","");return a}}return 1},isMobileDevice:function(){var a=false;if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i)){a=true}return a},hideBrowserBar:function(){var a=false;if(navigator.userAgent.match(/Android/i)){a=true}return a},isMouseOver:function(b,a){var c=a.offset();return b.pageX>=c.left&&b.pageX<(c.left+a.outerWidth())&&b.pageY>=c.top&&b.pageY<(c.top+a.outerHeight())},relativeMousePos:function(b,a){var c=a.offset();return{top:b.pageY-c.top,left:b.pageX-c.left}},animateRaf:function(a,e,i,d,k){if($.isFunction(i)){d=i;i=undefined}var b,g,f,j=false;var h=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(l){window.setTimeout(function(){l(new Date().valueOf())},16.667)};function c(n){if(!j&&n<946684800000){if(f){b=startTimeHiResClock;g=endTimeHiResClock;j=true}else{n=new Date().valueOf()}}var l=n-b;var m=g!=b?l/e:1;if(m<1){if(i){m=i(m,l,0,1,e)}a(m,k);h(c)}else{a(1,k);if(d&&$.isFunction(d)){window.setTimeout(d,10)}}}if(e===undefined){e=300}f=window.hasOwnProperty("performance")&&window.performance.hasOwnProperty("now");b=new Date().valueOf();startTimeHiResClock=f?window.performance.now():b;g=b+e;endTimeHiResClock=startTimeHiResClock+e;if(i){i=$.easing[i]}h(c)},toPercent:function(c,f,d){if(typeof c=="string"){var e=utils.parsePercentString(c);c=e&&!isNaN(e)?e*f/100:parseFloat(c)}var a=c*100/f;var b=Math.pow(10,d);return(Math.round(a*b))/b},parsePercentString:function(c){var b=NaN;if(typeof c=="string"){var a=c.match(/^\s*(\d+(?:\.\d*)?|\.\d+)\s*\%\s*$/);if(a){b=parseFloat(a[1])}}return b},isPercentString:function(b){var a=utils.parsePercentString(b);return Boolean(a)&&!isNaN(a)},fromPercentString:function(c,b){var a=utils.parsePercentString(c);if(a&&!isNaN(a)){a*=b/100}return a},getNavigationKeyDirection:function(b){var a="";switch(b){case 37:a="left";break;case 38:a="top";break;case 39:a="right";break;case 40:a="bottom";break}return a},replaceTooltip:function(a){},Vector:(function(){function a(b,d,c){if(!(this instanceof a)){return new a(b,d,c)}if(b instanceof Object){d=b.y;c=b.z;b=b.x}c=c||0;if(typeof b!=="number"||typeof d!=="number"){b=d=c=0}this.x=b;this.y=d;this.z=c;a.created++}a.created=0;a.prototype={set:function(b,d,c){if(b instanceof Object){d=b.y;b=b.x;c=b.z}c=c||0;if(typeof b==="number"&&typeof d==="number"&&typeof c==="number"){this.x=b;this.y=d;this.z=c}return this},distanceTo:function(c){var b=this.x-c.x,e=this.y-c.y,d=this.z-c.z;return Math.sqrt(b*b+e*e+d*d)},distanceSqTo:function(c){var b=this.x-c.x,e=this.y-c.y,d=this.z-c.z;return b*b+e*e},plus:function(b){return new a(this.x+b.x,this.y+b.y,this.z+b.z)},minus:function(b){return new a(this.x-b.x,this.y-b.y,this.z-b.z)},scale:function(b){return new a(this.x*b,this.y*b,this.z*b)},dot:function(b){return this.x*b.x+this.y*b.y+this.z*b.z},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},angle:function(b){if(!b){b=a.I}else{return this.angle()-b.angle()}if(this.y<0){return 2*Math.PI-(new a(this.x,-this.y,this.y)).angle(b)}return Math.acos(this.dot(b)/(this.magnitude()*b.magnitude()))},rotateBy:function(b){if(b>Math.PI){return this.rotateBy(-(2*Math.PI-b))}else{if(b<-Math.PI){return this.rotateBy(2*Math.PI+b)}}return new a(this.x*Math.cos(b)-this.y*Math.sin(b),this.x*Math.sin(b)+this.y*Math.cos(b))},rotateTo:function(c){var b=c-this.angle();return this.rotateBy(b)},unitVector:function(){return this.scale(1/this.magnitude())},add:function(b){this.x+=b.x;this.y+=b.y;return this},sub:function(b){this.x-=b.x;this.y-=b.y;return this},mul:function(b){this.x*=b;this.y*=b;return this},rotBy:function(b){this.x=this.x*Math.cos(b)-this.y*Math.sin(b);this.y=this.x*Math.sin(b)+this.y*Math.cos(b);return this},rotTo:function(c){var b=c-this.angle();return this.rotBy(b)},copy:function(){return new a(this.x,this.y)}};a.I=Object.freeze(new a(1,0,0));a.J=Object.freeze(new a(0,1,0));a.K=Object.freeze(new a(0,0,1));return a}()),drawVectors:function(l,m,n){var g=[],b=[],h=n[0],f=[],j=m.length;for(var a=j-1,e=0;e<j;e++){b[a]=m[e].distanceTo(m[a]);a=e}for(var e=0,a=j-1;e<j;e++){f[e]=Math.min(h,b[a]/2,b[e]/2)}for(var a=j-1,e=0;e<j;e++){g[a]=m[e].minus(m[a]).unitVector().scale(f[a]);a=e}var k=m[0].plus(g[0]);l.moveTo(k.x,k.y);for(e=0;e<j;e++){var d=e<j-1?e+1:0;k=m[d].minus(g[e]);l.lineTo(k.x,k.y);k=m[d].plus(g[d]);l.quadraticCurveTo(m[d].x,m[d].y,k.x,k.y)}},getFitSize:function(d){var e,f,c=d.object.width>d.frame.width||d.object.height>d.frame.height,a=d.frame.width/d.frame.height,g=d.object.width/d.object.height;if(!c&&!d.expand){return d.object}var b={};if(a>g){e="height";f="width";b.top=0}else{e="width";f="height";b.left=0}b[e]=d.frame[e];b[f]=(d.frame[e]/d.object[e])*d.object[f];return b},isTaintedCanvas:function(b){b=b instanceof HTMLCanvasElement?b.getContext("2d"):b;try{return !b.getImageData(0,0,1,1)}catch(a){return a.code===18}}};utils.getParentWindow=function(){var a;var c;try{a=window.frameElement.ownerDocument;c=a.defaultView}catch(b){c=null}return c};utils.getTrueHeight=function(){return(window.hasOwnProperty("innerHeight")?window.innerHeight:$(window).height())||480};utils.isPageInViewport=function(b,i){var c=i&&i.mode?i.mode:false;var a=i&&i.withPageFrame?i.withPageFrame:false;var h=fluid.zoom.getCurrentScale();var d=document.getElementById("viewport");var g={left:c==="init"?-fluid.main.project.get("canvasPosX")/h:d.scrollLeft/h,top:c==="init"?-fluid.main.project.get("canvasPosY")/h:d.scrollTop/h,width:window.innerWidth/h,height:window.innerHeight/h};if(c!=="init"&&fluid.zoom.getCtx()!=="project"&&fluid.zoom.getLibWidth()){g.left=g.left+fluid.zoom.getLibWidth()/h;g.width=g.width-fluid.zoom.getLibWidth()/h}g.right=g.left+g.width;g.bottom=g.top+g.height;var f=$("#pageFrame");if(a&&f.length&&f.parents("#"+b).length){g.left=g.left+50/h;g.right=g.right-50/h;g.bottom=g.bottom-50/h;g.top=g.top+85/h;g.height=g.bottom-g.top;g.width=g.right-g.left}var e=fluid.main.project.pages.get(b).toJSON();if(c!=="strict"&&((e.x<=g.right)&&(g.left<=e.x+e.width)&&(e.y<=g.bottom)&&(g.top<=e.y+e.height))){return true}else{if(c==="strict"&&((e.x+e.width<=g.right)&&(g.left<=e.x)&&(e.y+e.height<=g.bottom)&&(g.top<=e.y))){return true}}return false};utils.getActivePage=function(){return $("#canvasPages > .screen.active").first()};utils.getActivePageId=function(){return utils.getActivePage().attr("id")};utils.getLatestActiveProject=function(){var c;var b=fluid.main.account.get("projectIds");for(var a=b.length-1;a>=0;a--){if(fluid.main.projects.get(b[a]).get("active")!==false){c=b[a];break}}return c};utils.findPositionOnScreen=function(i,l,f){function g(n,t,p){t=$.extend(true,[],t);var r=fluid.main.project.widgets.get(n).toJSON();var s=20;var o=r.tlwh[2];var v=r.tlwh[3];var u=(t[0]<t[1])?"Portrait":"Landscape";var q=t[0]+s;var m=t[1]+s;if(p!==u){q=t[1]+s;m=t[0]+s}h=((r.tlwh[0]>(m-s-5))||(r.tlwh[1]>(q-s-5)))?false:true}var h=false;if(f==true){var d=$(".page").attr("id");var e=fluid.main.project?fluid.main.project.toJSON():window.top.fluid.main.project.toJSON();var j=e.pageWH;var c=fluid.main.project?fluid.main.project.pages.get(d).toJSON():window.top.fluid.main.project.pages.get(d).toJSON();if(j){var b=l;var a=c.orientation;g(b,j,a)}}else{var d=utils.getActivePageId();var k=fluid.main.project.widgets.getRoots(i);k.each(function(){var o=$(this).attr("id");var m=fluid.main.project.get("pageWH");var n=fluid.main.project.pages.get(d).get("orientation");g(o,m,n)})}return h};utils.loadjscssfile=function(a,b){if(b=="js"){var c=document.createElement("script");c.setAttribute("type","text/javascript");c.setAttribute("src",a)}else{if(b=="css"){var c=document.createElement("link");c.setAttribute("rel","stylesheet");c.setAttribute("type","text/css");c.setAttribute("href",a)}}if(typeof c!="undefined"){document.getElementsByTagName("head")[0].appendChild(c)}};module.exports=utils;