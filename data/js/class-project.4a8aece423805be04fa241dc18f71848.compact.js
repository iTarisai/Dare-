var account=require("./class-account");var projectSettings=require("./class-projectSettings");var storage=require("./class-storage");var i18n=require("./fluid/fluid.i18n");var utils=require("./utils");fluid.command=require("./fluid/fluid.command");var page=require("./class-page");var notification=require("./class-notification");var link=require("./class-link");var fluidMenu=require("./class-fluidMenu");var lib=require("./class-lib");var userSettings=require("./class-userSettings");var staticWidgets=require("./class-staticWidgets");require("./class-wdgRenderer");var project={isInitialized:false,isModified:false,activeProjectTooltip:"",autoPreviewTimeout:300000,inactiveProjectTooltip:"This project is inactive. Editing is disabled.",colors:{hStart:5,hEnd:210,s:"90%",l:"50%"},unloadedProps:["name","created","updated","active","preview"],lastProjectClosed:false,orient:function(g,b){var b=g!=undefined?$(g.target).attr("data-for"):b;var c=fluid.main.project.get("pageWH");var j=parseInt(c[0],10);var h=parseInt(c[1],10);var d=Math.min(j,h);var k=Math.max(j,h);c=b=="Portrait"?[d,k]:[k,d];project.set({orientation:b});project.set({pageWH:c});var a=fluid.main.project.get("pages");for(var f in a){page.update({orientation:b,width:c[1],height:c[0]},a[f])}$(".screen").each(page.resizeAfterOrient);page.updateOptionsMenu()},isMultiOrientation:function(){var d=fluid.main.project.get("pages");var f=fluid.main.project.get("orientation");var c=false;if(!d||!d.length){return false}for(var b=0,a=d.length;b<a;b++){var e=page.get(d[b],"orientation");if(e!=f){c=true;break}}return c},setNumber:function(b,d){var c=fluid.main.projects.filter(function(f,e,g){if(f.get("removed")){return false}return true}).length;var a="All Projects ("+c+")";$(".projectSettingsButton").removeClass("buttonDisabled").find("span").text(a);$("#logout").removeClass("hidden")},hoverIn:function(){$(this).children(".foreground").addClass("projectHover");$(this).children(".popOutPage").addClass("popOutPageHover")},hoverOut:function(){$(this).children(".foreground").removeClass("projectHover");$(this).children(".popOutPage").removeClass("popOutPageHover")},_template:function(a,c){a.id=c;a.name=a.name||"New Project";a.date=fluid.i18n.formatDate(a.created);a.dateCreate=moment(a.created).format("YYYY/MM/DD HH:mm:ss");a.dateUpdate=moment(a.updated).format("YYYY/MM/DD HH:mm:ss");a.tooltip=a.active===false?project.inactiveProjectTooltip:project.activeProjectTooltip;a.nameLower=a.name.toLowerCase();var b=$("#tmplProjectThumb").tmpl(a);if(a.active===false){b.addClass("inactivePrj")}else{b.addClass("activePrj")}b.insertAfter("#projectAdd");projectSettings.updateThumbnail(c);delete a.dateCreate;delete a.dateUpdate;delete a.nameLower;return b},hasWidgets:function(){var b=fluid.main.account.get("lastOpenProject");var c=storage.get(b);var a=false;if((c)&&(c.pages)){$.each(c.pages,function(d,f){var e=page.get(f,"widgets");if((e)&&(e.length>0)){a=true;return false}})}return a},get:function(a){return fluid.main.project.get(a)},set:function(a){var b=fluid.main.account.get("lastOpenProject");project.loadIfUnloaded(b,function(){var c=storage.get(b);if(!c){return}for(var d in a){c[d]=a[d]}storage.set(b,c)})},changeScreenSize:function(i,b){if(typeof b==="object"){var g=b[0];var a=b[1]}else{var g=parseInt($(".screenSize").filter(".width").val());var a=parseInt($(".screenSize").filter(".height").val())}var f=50;var h=50;if((isNaN(g))||(isNaN(a))){g=project.get("pageWH")[0];a=project.get("pageWH")[1];$(".screenSize").filter(".width").val(g);$(".screenSize").filter(".height").val(a)}else{g=g<f?f:g;a=a<h?h:a;g=parseInt(g,10);a=parseInt(a,10);project.set({pageWH:[g,a]});var c=a>=g?"Portrait":"Landscape";project.orient(null,c)}staticWidgets.zoomInBoundary();var d=$("#canvasPages .screen.active").attr("id");if(d){fluid.zoom.zoomToPage({pageId:d})}else{fluid.zoom.zoomToAllPages()}},save:function(){var b=fluid.main.project.get("id");var a=storage.get(b);a.updated=new Date().getTime();storage.set(b,a)},dragStart:function(n,i){var d=$(this).hasClass("inactiveProject");var c=$("#projects").outerHeight();var a=$("#projects").closest(".viewport").height();var l=$("#projects").parent().position().top;var e=d?$("#projectList"):$("#inactiveProjectList");var o=e.outerHeight();var j=e.children("h2, h3, h4, h5");var k=j.outerHeight(true)||50;var m=d?l+o:o-c+a-l;var r=m<k;var f=0;if(r){var p=d?-1:1;f=p*(m-k-j.position().top);if(d){f+=2;j.css({"-webkit-transform":"translate(0, "+(o-k-8)+"px)","-moz-transform":"translate(0, "+(o-k-8)+"px)"});e.children(".addProject, .project").css({"-webkit-transform":"translate(0, -"+(j.outerHeight()||0)+"px)","-moz-transform":"translate(0, -"+(j.outerHeight()||0)+"px)"})}e.removeClass("bouncing").css({top:m<0?m+4+"px":"","z-index":1}).addClass("bouncing scrolledIntoView");var b=parseInt(e.css("-webkit-transition-duration"));var h=m>=0?m/k:1;b=b*h+(b>1?"ms":"s");e.css({top:f+"px","-webkit-transition-duration":b,"-moz-transition-duration":b,"-webkit-animation-delay":b,"-moz-animation-delay":b});var g=$("#projects .project").first().outerHeight(true)||0;var q=f-p*g;$("#projects").data("popoutAreaHeight",g).data("popoutTranslateTop",q)}$("#projects").data("showDest",r)},drag:function(b,i){var h=$(this);var g=$("#fluidDropdown .viewport");if($("#projects").is(":visible")&&utils.isMouseOver(b,g)){var a=$(this).hasClass("inactiveProject");var f=a?$("#projectList"):$("#inactiveProjectList");var e=$("#projects");var j=e.data("popoutAreaHeight");var d=e.data("popoutTranslateTop");var c=utils.relativeMousePos(b,g).top;if(e.data("showDest")&&((a&&c<j)||(!a&&g.height()-c<j))){f.removeClass("bouncing").css({top:d+"px","-webkit-transition":"top 0.2s ease-in-out","-moz-transition":"top 0.2s ease-in-out"}).bind("webkitTransitionEnd",function(){f.unbind("webkitTransitionEnd")})}project._updateDroppables(b,h)}else{$("#projectList, #inactiveProjectList").removeClass("hover")}if(intersectTrash(h.data().draggable.helper)==true){$("#trash").addClass("droppableStyle")}else{$("#trash").removeClass("droppableStyle")}},_updateDroppables:function(c,b){var a=[{elem:$("#projectList"),accept:".inactiveProject"},{elem:$("#inactiveProjectList"),accept:".project:not(.inactiveProject)"}];$.each(a,function(d,f){var e=f.elem;if(utils.isMouseOver(c,e)&&b&&b.is(f.accept)){if(!e.hasClass("hover")){e.addClass("hover")}}else{if(e.hasClass("hover")){e.removeClass("hover")}}})},dragStop:function(a){$("#projectList, #inactiveProjectList").removeClass("hover");$("#projects").data("showDest",false);var b=$(this).hasClass("inactiveProject")?$("#projectList"):$("#inactiveProjectList");b.removeClass("bouncing").animate({top:"0px"},200,function(){b.removeClass("scrolledIntoView").children("h2, h3, h4, h5, .addProject, .project").removeAttr("style")});$("#trash").removeClass("droppableStyle")},dropToActive:function(b,a){var a=a==undefined?false:true;var c=false;if(fluid.main.fire("project.beforeActivate")&&!a){if(project.isOpen(b)){notification.removeAll("alert","projectInactive")}notification.removeAll("alert","projectLimit");project._handleActiveInactiveDrop(b,false);projectSettings.getItemById(b).removeClass("inactivePrj").addClass("activePrj");projectSettings.displayStatus(true);projectSettings.applyFilter();projectSettings.actionLoadVersions();$("#canvasPages .pageWidget").draggable("option","disabled",false);c=true}page.displayMenu();$("#projectList, #inactiveProjectList").removeClass("hover");return c},dropToInactive:function(a){var b=false;project._handleActiveInactiveDrop(a,true);notification.removeAll("alert","projectLimit");page.displayMenu(false);$("#projectList, #inactiveProjectList").removeClass("hover");projectSettings.getItemById(a).addClass("inactivePrj").removeClass("activePrj");projectSettings.applyFilter();$("#canvasPages .pageWidget").draggable("option","disabled",true);b=true;return b},_handleActiveInactiveDrop:function(b,a){project.loadIfUnloaded(b,function(){var c=storage.get(b);c.active=!a;c.updated=new Date().getTime();storage.set(b,c);project.sync(b);project.setNumber()})},updateInactiveProjectList:function(){var g=$("#inactiveProjectList");var f=g.find(".inactiveProject");var b=g.children(".promptContainer");var a=b.css("display")!="none";var e=b.is(":visible");if(f.size()==0){if(!a){if(e){b.fadeIn(300)}else{b.show()}}}else{if(a){if(e){b.fadeOut(300)}else{b.hide()}}}var c=g.find(".projectPlaceholder");var d=c.size();c.hide().slice(-1*(d-f.size()%d)).fadeIn(300);g.removeWhitespace()},unbundle:function(a,b){b(a)},checkIntegrity:function(b){var e=storage.get(b);if(e.unloaded){delete e.unloaded}project.save();if(!e){account.logout();localStorage.setItem("postloadMessage","loginAgain");location.reload()}if(!fluid.main.project.get("canvasWidth")){project.set({canvasWidth:24004})}if(!fluid.main.project.get("canvasHeight")){project.set({canvasHeight:16004})}if(!fluid.main.project.get("canvasPosX")&&fluid.main.project.get("canvasPosX")!==0){project.set({canvasPosX:1000})}if(!fluid.main.project.get("canvasPosY")&&fluid.main.project.get("canvasPosY")!==0){project.set({canvasPosY:1000})}if(typeof fluid.main.project.get("lastTransition")==="undefined"){project.set({lastTransition:"pop"})}if(typeof fluid.main.project.get("pageWH")==="undefined"){project.set({pageWH:[320,480]})}if(typeof fluid.main.project.get("orientation")==="undefined"){project.set({orientation:"Portrait"})}if(typeof fluid.main.project.get("defaultTransition")==="undefined"){project.set({defaultTransition:"slide"})}if(typeof fluid.main.project.get("defaultGesture")==="undefined"){project.set({defaultGesture:"tap"})}if(typeof fluid.main.project.get("widgetGroups")==="undefined"){project.set({widgetGroups:{}})}if(!e.pages){e.pages=[]}if(e.pages.length!==fluid.util._.uniq(e.pages).length){e.pages=fluid.util._.uniq(e.pages);project.set({pages:e.pages})}if(!storage.get(e.homepage)&&e.pages.length){project.set({homepage:e.pages[0]})}for(var h=0;h<e.pages.length;h++){var c=storage.get(e.pages[h]);if(!c){e.pages.splice(h,1);h--;continue}if(c.x>e.canvasWidth){page.update({x:c.x/4},e.pages[h])}if(c.y>e.canvasHeight){page.update({y:c.y/4},e.pages[h])}if(!c.height){page.update({height:480},e.pages[h])}if(!c.width){page.update({width:320},e.pages[h])}if(!c.orientation){page.update({orientation:"Portrait"},e.pages[h])}if(c.width!==~~c.width){page.update({width:~~c.width},e.pages[h])}if(c.height!==~~c.height){page.update({height:~~c.height},e.pages[h])}var g,a;if(!c.widgets){page.update({widgets:[]},e.pages[h]);c.widgets=[]}for(var f=0;f<c.widgets.length;f++){g=storage.get(c.widgets[f]);if(!g){page.removeWidget(e.pages[h],c.widgets[f]);continue}else{if(g.upload&&g.upload==="y"){a=storage.get(g.data);if(!a&&account.syncedUploads){continue}}}}}var l=fluid.main.project.links.toJSON();if(!l){l={linkCanvId:[],linkDest:[],linkOrigin:[],linkType:[],transType:[],triggerType:[]};e.links=l}if(typeof l.transType==="undefined"){l.transType=(l.linkType).slice(0);for(var h in l.transType){l.transType[h]=(l.linkType[h]=="ahref")?fluid.main.project.get("defaultTransition"):null}}if(typeof l.triggerType==="undefined"){l.triggerType=(l.linkType).slice(0);for(var h in l.triggerType){l.triggerType[h]=(l.linkType[h]=="ahref")?fluid.main.project.get("defaultGesture"):null}}var k=false;var d;for(var h=0;h<l.linkDest.length;h++){k=false;if(!storage.get(l.linkDest[h])){l.linkCanvId.splice(h,1);l.linkDest.splice(h,1);l.linkOrigin.splice(h,1);l.linkType.splice(h,1);l.transType.splice(h,1);l.triggerType.splice(h,1);h--}else{if(!storage.get(l.linkOrigin[h])){l.linkCanvId.splice(h,1);l.linkDest.splice(h,1);l.linkOrigin.splice(h,1);l.linkType.splice(h,1);l.transType.splice(h,1);l.triggerType.splice(h,1);h--}}}fluid.main.project.widgets.each(function(o,n,q){var p=o.get("segment"),m=o.get("segmentRoot"),j=o.get("lockTo"),i=o.get("seg");if((p||i)&&m&&m!==j){o.set({segmentRoot:j})}});project.save()},bundle:function(b){if(fluid.main.project&&fluid.main.project.id===b){return fluid.main.project.bundle()}else{var a=fluid.main.projects.get(b);return a.bundle()}},notifySyncAttempt:function(a,b){},sync:function(d,c){if(fluid.main.account.get("accType")=="New"){a();return}var b=fluid.main.account.get("lastOpenProject");if(d===undefined||d===null){d=b}function a(e){if($.isFunction(c)){c.call(null,e)}}project.loadIfUnloaded(d,function(){var g=storage.get(d,{returnModel:true});var f=d==b?!g.isSynced():true;project.notifySyncAttempt(f,d);if(f){var e=storage.get(d);e.saved=new Date().getTime();storage.set(d,e,false);var h=project.bundle(d);setTimeout(function(){fluid.api.projectSync(d,h,function(){a({data:h,synced:true})},function(){notification.add("alert","Could not save your project to the server. Please check your connection.")})},2000)}else{a({synced:false})}if(d==b){fluid.main.project.setModified(false)}})},setName:function(b){var a=storage.get(b.id);if(!a){return}a.name=b.name;storage.set(b.id,a);if(fluid.main.account.get("lastOpenProject")==b.id){account.set({name:b.name})}},sort:function(){var a=fluid.main.account.get("projectIds");var b=$.merge([],a);b.sort(function(d,c){var f=storage.get(d)?storage.get(d).created:0;var e=storage.get(c)?storage.get(c).created:0;return f-e});account.set({projectIds:b})},load:function(){account.setLoadingStep(2);if($(".submenuLink .fluidSubmenuActive").length==0){$("#fluidDropdownSubmenu a:first").addClass("fluidSubmenuActive")}project.sort();var d=fluid.main.account.get("accType");var c=fluid.main.account.get("projectIds");var h=fluid.main.account.get("maxActiveProjects");var i=0;if(h!=0&&fluid.main.projects.activeProjectCount()>h){i=fluid.main.projects.activeProjectCount()-h}projectSettings.displayFrame();$("#fluidDropdown .project").not(".addProject").remove();$(".projectThumb").not("#projectAdd").not("#profile .projectThumb").remove();projectSettings.resetFilter();for(var e=0,g=c.length;e<g;e++){var f=c[e];var b=storage.get(f);if(b){b=project.ensureHeaderIntegrity(b);var a=b.active!==undefined?b.active:true;project._template(b,c[e])}fluid.main.fire("project.loaded",{step:e,count:c.length})}project.setNumber();this.updateInactiveProjectList()},ensureHeaderIntegrity:function(a){if(!a.name){a.name="New Project"}return a},windowClose:function(){storage.commitCache();if(fluid.main.project.isEmpty()==false){project.sync()}},windowClose2:function(){alert("Close!");storage.commitCache();if(!fluid.main.project.isEmpty()){project.sync()}},close:function(b){fluid.command.history.reset();fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");page.detachFrame();var a=fluid.main.account.get("lastOpenProject");$("#canvas").removeClass("loaded");$(".project").removeClass("open");$(".projectThumb").removeClass("open");$(".screen").remove();$("#canvasLinks").empty();if($("#dragCanvas").length==0){$("#tmplDragCanv").tmpl({}).appendTo($("#canvas"))}if(a&&storage.get(a)&&!fluid.main.projects.get(a).isEmpty()&&!project.lastProjectClosed){project.sync(null,b)}project.lastProjectClosed=true},open:function(a,c){fluid.main.fire("project.opening");$("#canvas").removeClass("loaded");project.afterOpenedCallback=c;project.openStartTime=new Date().getTime();project.uploadPreload=true;project.useLocalDb=true;fluid.command.history.reset();account.setLoadingStep(3);$("#pagePreview",page.frame||document).parent().hide();notification.removeAll("alert",["projectInactive","projectLimit"]);if(!project.lastProjectClosed){project.close()}if(a=="last"){a=fluid.main.account.get("lastOpenProject");var b=storage.get(a);if(!a||!b){a=project.add("","New Project")}}account.set({lastOpenProject:a});project.lastProjectClosed=false;project.loadIfUnloaded(a,project.afterLoaded.bind(this,a),{buildModel:true,setAsMain:true});lib.changeActiveTab(a)},drawThumbnail:function(e){var d=$("#profile");d.find(".projectThumb").remove();var b={id:"opened_"+e,name:fluid.main.project.get("name")||"New Project"};var f=$("#tmplProjectThumb").tmpl(b);f.addClass(fluid.main.project.get("active")===false?"inactivePrj":"activePrj");var c=fluid.main.project.get("preview");if(!fluid.main.project.get("pages")||fluid.main.project.get("pages").length===0){f.append('<div class="project-thumb">Project empty</div>')}else{if(c&&c.src){f.append('<img class="project-thumb" src="'+c.src+'">')}}var a=$("#tmplProjectSettingsFrame").tmpl();$(".selectedProjectName",a).text(f.attr("title"));$(a).click(fluid.util.debounce(function(){projectSettings.lastSelectedId=fluid.main.project.get("id");project.sync();projectSettings.goToSettingsUpdate();userSettings.open(null,$("#projectSettingsPanelSettings"))},500));a.css({opacity:0.75,display:"block"}).appendTo(f);f.addClass("selectedPrj");d.prepend(f)},adjustViewport:function(){var a=24004;var m=16004;var e=$("#viewport");var k=fluid.zoom.getPagesBounding();var l={width:a,height:a*e.height()/e.width()};if(l.height<k.maxY-k.minY+3000){l={height:k.maxY-k.minY+5000,width:e.width()*(k.maxY-k.minY+5000)/e.height()}}project.set({canvasWidth:l.width,canvasHeight:l.height});var g=k.minX+(k.maxX-k.minX)/2;var f=k.minY+(k.maxY-k.minY)/2;var c=l.width/2-g;var b=l.height/2-f;var d=fluid.main.project.get("pages");if(d.length){var j;for(var h=0;h<d.length;h++){j=storage.get(d[h]);j.x=j.x+c;j.y=j.y+b;storage.set(d[h],j)}}else{e.get(0).scrollTop=l.height/2*fluid.zoom.getFitParams().newScale*0.25;e.get(0).scrollLeft=l.width/2*fluid.zoom.getFitParams().newScale*0.25}},afterLoaded:function(a){if(storage.get(account.get("id")).email.indexOf("@")===-1){$("#profile .projectThumb").remove()}else{project.drawThumbnail(a)}project.checkIntegrity(a);project.adjustViewport();$("#zoomedOutPages").get(0).innerHTML="";fluid.zoom.zoomToAllPages({instantSwitch:true,finishedCallback:function(b){project.preparePages(a)}})},preparePages:function(c){link.newLinks=true;function b(){var e=project.getPagesInViewport("init");if(e==0){project.centerOnHomepage();e=project.getPagesInViewport("init")}return e}var d=b();for(var a=0;a<d.length;a++){page.draw(d[a],"useCache")}project.onPagesPrepared(c);if(page.renderer&&page.renderer.countRemainingLoads()==0){fluid.main.fire("images.loaded")}},onPagesPrepared:function(b){project.updatePages(project.updateLinks);project.setSettingsPanelData();projectSettings.getItemById(b).addClass("open");document.title=fluid.main.project.get("name")+" :: Fluidui.com";$(".pageWidget").draggable("disable");$("#startMenu").delay(300).fadeIn(300);project.isInitialized=true;if(fluid.main.project.isReadOnly()){fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");account.alertEditInactive();$("#canvasPages .pageWidget").draggable("option","disabled",true);fluidMenu.setCanvasFirstPage()}else{if(fluid.main.project.get("pages").length>0){fluidMenu.setCanvasFirstPage()}else{fluidMenu.setCanvasNoPages()}}if(!project.previewRenderer){project.previewRenderer=new fluid.wdgRenderer()}project.previewRenderer.renderProjectPreview(project.bundle(b),function(d,c){project.onPreviewReady(d,c,"projectopen")});if(fluid.main.account.get("loggedIn")=="yes"){$("#projectName").hide().text(fluid.main.project.get("name")).fadeIn(1000).delay(1000).fadeOut(500)}var a=fluid.main.project.get("pages");if(!a||a.length==0){fluidMenu.setCanvasNoPages(false)}if($.isFunction(project.afterOpenedCallback)){project.afterOpenedCallback.call(null);project.afterOpenedCallback=null}$("#zoomedOutPages").fadeIn(300);$("#canvas").addClass("loaded");$("#scaled-"+fluid.main.project.get("homepage")).addClass("homePage");fluid.main.fire("projectopened");fluid.main.fire("project.opened");if(_.keys(fluid.main.project.bundle().uploads).length===0){fluid.main.fire("images.loaded")}},onPreviewReady:function(g,b,e){$("#profile .projectThumb .loader-wrap").remove();var d=b.get(0).toDataURL();var a=storage.get(g);if(!a||a.unloaded){return}a.preview={src:d};storage.set(g,a,false);projectSettings.updateThumbnail(g);if(fluid.main.project.get("id")===g){var c=fluid.main.project.get("pages");if(!c||c.length===0){$("#profile .project-thumb").remove();$("#profile .projectThumb").prepend('<div class="project-thumb">Project empty</div>')}else{$("#profile div.project-thumb").remove();var f=$("#opened_"+g+"Thumb img.project-thumb");if(f.length){f.attr("src",d)}else{$("#profile .projectThumb").prepend('<img class="project-thumb" src="'+d+'">')}}}if(e!=="autopreviewgen"){project.renderMissingPreviews(e!=="projectopen"?g:null)}if(e==="projectopen"){setTimeout(project.initAutoPreviewGen.bind(this,g),project.autoPreviewTimeout)}},initAutoPreviewGen:function(a){if(fluid.main.account.get("lastOpenProject")!==a){return}project.previewRenderer.renderProjectPreview(project.bundle(fluid.main.account.get("lastOpenProject")),function(c,b){project.onPreviewReady(c,b,"autopreviewgen")});setTimeout(project.initAutoPreviewGen.bind(this,a),project.autoPreviewTimeout)},renderMissingPreviews:function(c){var a=$(".projectThumb div.preview").not(".empty");var b;if(a.length>0){b=projectSettings.getSelectedId(a.eq(0).parents(".projectThumb").attr("id"));project.renderPreview(b)}},renderPreview:function(a,c){if(a===fluid.main.project.id&&!fluid.main.project.modifiedSinceThumb){return}var b=c||"missingpreview";if(a===fluid.main.project.get("id")){$('<div class="loader-wrap"><img class="ajax-loader" src="img/ajax-loader.gif"/></div>').insertAfter("#profile .project-thumb")}project.loadIfUnloaded(a,function(){if(!project.previewRenderer){project.previewRenderer=new fluid.wdgRenderer()}project.previewRenderer.renderProjectPreview(project.bundle(a),function(e,d){project.onPreviewReady(e,d,b);if(!project.isOpen(e)){project.sync(e,function(){project.unload(e)})}})})},isOpen:function(a){if(!a){a=this.id}return a==fluid.main.account.get("lastOpenProject")},addWithoutLimit:function(a){project._freeSlotForProject();project.add(a,null,true)},add:function(j,a,l,k){var l=l==undefined?false:true;if((!account.canAddProjects())&&(!l)){notification.removeAll("alert","projectLimit");var m;if(fluid.main.account.get("maxActiveProjects")<=1){m=account.alerts.projectLimitHit.onAddActive}else{m=account.alerts.projectLimitHit.onNeedHigherThanStandard}notification.add("alert",m,{scope:"projectLimit",stopBuggingCallBack:project.addWithoutLimit});return false}var c;if(a==undefined){var a="";var h=storage.get("projectsCount");var d=fluid.main.account.get("projectIds");if(!h){h=d.length+1}else{h+=1}function i(e){d.forEach(function(n){if(storage.get(n).name===e){h+=1;e=i("Project "+h)}});return e}storage.set("projectsCount",h);a=i("Project "+h)}var f=new Date().getTime();c=utils.guid("p");var g={name:a,created:f,updated:f,canvasWidth:24004,canvasHeight:16004,canvasPosX:-2000*0.5,canvasPosY:-2000*0.5,orientation:"Portrait",pages:[],pageWH:[320,568],deviceModel:"iPhone5",lastTransition:"pop",defaultTransition:"pop",defaultGesture:"tap",links:{linkOrigin:[],linkDest:[],linkCanvId:[],linkType:[],transType:[],triggerType:[]}};if(!fluid.main.project){fluid.main.project=new fluid.models.project(g,{projectId:c});fluid.main.newProjectModel=fluid.main.project}else{fluid.main.newProjectModel=new fluid.models.project(g,{projectId:c})}fluid.main.projects.add(fluid.main.newProjectModel);account.addProjectId(c);storage.set(c,g);fluid.main.newProjectModel.save(function(){if(k){k(c)}});var b=project._template(g,c);project.setNumber();projectSettings.applyFilter();project.sync(c,false);return c},del:function(e,d){function c(){function f(){$("#fluidDropdown #"+e).draggable("destroy").fadeOut(300,function(){var i=$(this).hasClass("inactiveProject");$(this).remove();if(i){project.updateInactiveProjectList()}lib.updateUploadsProjectsList()});var g=fluid.main.account.get("projectIds");g=fluid.util._.without(g,e);account.set({projectIds:g});var h=project.unload(e);storage.remove(e);project.setNumber();projectSettings.displayFrame();projectSettings.getItemById(e).remove();projectSettings.refreshListHeader();if(d){d.call(null,h)}}fluid.api.remove(e,f,f)}var b=project.isOpen(e);if(b){project.close()}var a=storage.get(e);a.removed=true;a.updated=new Date().getTime();storage.set(e,a);if(fluid.main.projects.get(e).isEmpty()){c()}else{project.sync(e,c)}notification.removeAll("alert","projectAction");notification.add("alert","Your project has been deleted.  In case you want to restore, please open the bin...",{scope:"projectAction"});fluid.controllers.bin.show()},rename:function(b){var c=userSettings.isOpen?projectSettings.lastSelectedId:$(b.target).closest(".project").attr("id");var a=$(b.target).val();project.setName({name:a,id:c});project.sync(c,false);if(project.isOpen(c)){document.title=fluid.main.project.get("name")+" :: Fluidui.com"}$(".title","#"+c).val(a);$(".selectedProjectName").text(a);projectSettings.getItemById(c).attr({"data-name":a.toLowerCase(),title:a,alt:a});fluid.main.trigger("projectNameChanged");return false},readOnly:function(){return fluid.main.project.get("active")===false},storageChangeProjectHandler:function(b,a){if((!a)||(!a.timeUpdated)){return}if(/^[xwp]/.test(a.id)){if(/^p/.test(a.id)&&(a.id!=fluid.main.account.get("lastOpenProject"))){return}fluid.main.project.setModified(true)}},unload:function(c,a){return storage.get(c);if(!a){a=storage.get(c)}if(this.previewRenderer){this.previewRenderer.onProjectUnloaded(c)}if(!a.unloaded){project._deleteProjectPages(c);for(var b in a){if(a.hasOwnProperty(b)&&$.inArray(b,project.unloadedProps)==-1){delete a[b]}}a.unloaded=true;storage.set(c,a)}return a},unloadOldest:function(){var h,d,c;var e=fluid.main.account.get("projectIds");for(var b=0,a=e.length;b<a;b++){var g=e[b];if(g!=fluid.main.account.get("lastOpenProject")){var f=storage.get(g);if(!f.unloaded&&(!c||c>f.updated)){c=f.updated;h=g;d=f}}}if(d){project.unload(h,d)}else{throw"Could not find a project to unload"}},loadIfUnloaded:function(f,e,b){function c(){if($.isFunction(e)){e.apply(this,arguments)}}var d=storage.get(f);if(d&&d.unloaded){function a(i){var l=JSON.parse(i);if(l.r==="f"){var m=storage.get(f,{returnModel:true});if(m){m.set({unloaded:false})}c();return}var k=l.t;if(k.length){k=k[0].replace(/[\r\n]/g,"\\n")}else{k=k.replace(/[\r\n]/g,"\\n")}var h=JSON.parse(k);var m=fluid.main.projects.get(f);var g=fluid.main.projects.indexOf(m);h[f].unloaded=false;h[f].removed=false;h[f].uniqueUploads=Object.keys(h.uploads);var j=fluid.main.project=new fluid.models.project(h,{parse:true,projectId:f});if(!b||b.setAsMain!==false){fluid.main.project=j}if(m&&m.get("active")===false){j.set({active:false})}fluid.main.projects.remove(m);fluid.main.projects.add(j,{at:g});c(j.bundle())}fluid.api.syncDown(f,false,false,a,a)}else{if(b&&b.setAsMain){fluid.main.project=fluid.main.projects.get(f);c()}else{c(project.bundle(f));return}}},resetCanvas:function(){var a=-1000,b=-1000;project.set({canvasPosY:b,canvasPosX:a});$("#viewport").get(0).scrollLeft=a;$("#viewport").get(0).scrollTop=b},centerOnHomepage:function(){var a=fluid.main.project.get("homepage");if(a){var g=storage.get(a),d=utils.getTLWH("#canvas"),c=utils.getTLWH("#viewport");var b=fluid.zoom.getCurrentScale(),f=Math.max((g.x*b+(g.width*b-c.width)/2),10),e=Math.max((g.y*b+(g.height*b-c.height)/2),10);if(f+c.width-10>d.width){f=d.width-c.width-10}if(e+c.height-10>d.height){e=d.height-c.height-10}$("#viewport").get(0).scrollLeft=f;$("#viewport").get(0).scrollTop=e;project.set({canvasPosY:-e,canvasPosX:-f})}},updateOnSignup:function(){project.setNumber();project.previewRenderer.renderProjectPreview(project.bundle(fluid.main.account.get("lastOpenProject")),function(b,a){project.onPreviewReady(b,a,"projectopen")})},_freeSlotForProject:function(){var f=false;if(!account.canAddProjects()){var b=fluid.main.account.get("projectIds");for(var a in b){var e=b[a];var d=storage.get(e);if(d){var c=d.active!==undefined?d.active:true;if(c){if(!project.isOpen(e)){project.dropToInactive($("#"+e));f=true;break}}}}}if(!f){project.dropToInactive($("#"+fluid.main.account.get("lastOpenProject")))}},getPagesInViewport:function(f){var j=[];var h=document.getElementById("viewport");var a=$.extend([],fluid.main.project.get("pages"));var n=fluid.zoom.getCurrentScale();var l={left:f==="init"?-fluid.main.project.get("canvasPosX")/n:h.scrollLeft/n,top:f==="init"?-fluid.main.project.get("canvasPosY")/n:h.scrollTop/n,width:window.innerWidth/n,height:window.innerHeight/n};l.right=l.left+l.width;l.bottom=l.top+l.height;var o,g,m,e,k,c;var b;for(var d=0;d<a.length;d++){b=a[d];a[d]=$.extend({},storage.get(a[d]));o=a[d].x;g=a[d].x+a[d].width;m=a[d].y;e=a[d].y+a[d].height;k=a[d].width;c=a[d].height;if(f!=="strict"&&((o<=l.right)&&(l.left<=g)&&(m<=l.bottom)&&(l.top<=e))){j.push(b)}else{if(f==="strict"&&((g<=l.right)&&(l.left<=o)&&(e<=l.bottom)&&(l.top<=m))){j.push(b)}}}fluid.main.project.set({visiblePages:j});return j},getLinksInViewport:function(f){var d=project.getPagesInViewport(f);var c=fluid.main.project.links.toJSON();var e={linkCanvId:[],linkDest:[],linkOrigin:[],linkType:[],transType:[],triggerType:[]};var a;for(var b=0;b<c.linkCanvId.length;b++){a=storage.get(c.linkOrigin[b],{returnModel:true});if(d.indexOf(c.linkDest[b])!==-1||(a&&d.indexOf(a.getPage().id)!==-1)){e.linkCanvId.push(c.linkCanvId[b]);e.linkDest.push(c.linkDest[b]);e.linkOrigin.push(c.linkOrigin[b]);e.linkType.push(c.linkType[b]);e.transType.push(c.transType[b]);e.triggerType.push(c.triggerType[b])}}return e},updateThumbsActiveStatus:function(){$("#projectSettingsPanelMain .projectThumb").each(function(){var c=$(this);var a=c.attr("id");if(a.indexOf("Thumb")!==-1){a=a.substring(0,a.indexOf("Thumb"));var b=fluid.main.projects.get(a);if(b&&b.get("active")===false){c.removeClass("activePrj").addClass("inactivePrj")}else{c.removeClass("inactivePrj").addClass("activePrj")}}})},setSettingsPanelData:function(){var a=fluid.main.project.get("orientation");var b=$("#deviceSettingsMenu").find(".buttonSwitchContainer");if(b.length===0){b=$(page.menu).find("#deviceSettingsMenu .buttonSwitchContainer")}b.children().removeClass("activeOption");b.find("[data-for='"+a+"']").addClass("activeOption")},updatePages:function(h,g){var f=$(".screen");var e=project.getPagesInViewport();var c=fluid.main.project.get("pages");var a;var d=f.filter(function(){if(e.indexOf($(this).attr("id"))!==-1){return false}else{return true}});d=d.filter(function(i,j){if(j.getAttribute("id")!==utils.getActivePageId()){return true}else{return false}});var b;g=g||fluid.zoom.getAllPagesParams().newScale;requestAnimationFrame(function(){if(c.length!==fluid.main.project.pages.length){return}for(var k=0;k<e.length;k++){b=f.filter("#"+e[k]);if(b.length===0){page.draw(e[k],"useCache")}else{if(!b.is(":visible")){b.show()}}}for(var k=0;k<c.length;k++){a=storage.get(c[k]);$("#scaled-"+c[k]).css({top:a.y*g,left:a.x*g,width:a.width*g,height:a.height*g})}var j=fluid.zoom.getAllPagesParams();if(fluid.zoom.getCtx()!=="project"){$("#zoomedOutPages").css({"-webkit-transform":"scale("+$("#canvas").width()/(fluid.main.project.get("canvasWidth")*j.newScale)+")","-moz-transform":"scale("+$("#canvas").width()/(fluid.main.project.get("canvasWidth")*j.newScale)+")"});fluid.zoom.setLastTransScale($("#canvas").width()/(fluid.main.project.get("canvasWidth")*j.newScale))}if(h){h()}d.hide()})},updateLinks:function(b){var c=$(".link");var a=project.getLinksInViewport();var e=c.filter(function(){if(a.linkCanvId.indexOf($(this).attr("id"))!==-1){return false}else{return true}});var d;var f=fluid.zoom.getCurrentScale();requestAnimationFrame(function(){var g=fluid.main.project.get("links");var j=j={linkCanvId:[],linkDest:[],linkOrigin:[],linkType:[],transType:[],triggerType:[]};for(var h=0;h<a.linkCanvId.length;h++){d=c.filter("#"+a.linkCanvId[h]);if(d.length===0){j.linkCanvId.push(a.linkCanvId[h]);j.linkDest.push(a.linkDest[h]);j.linkOrigin.push(a.linkOrigin[h]);j.linkType.push(a.linkType[h]);j.transType.push(a.transType[h]);j.triggerType.push(a.triggerType[h])}}link.load(j);link.drawSome(a,f);e.hide();if(b){b()}})},afterClone:function(g,e){var c=new Date();e.created=e.updated=c.getTime();e.active=account.canAddProjects();account.addProjectId(g);storage.set(g,e,false);account.set({lastOpenProject:g});project._template(e,g);project.setNumber();var d=projectSettings.getItemById(g);projectSettings.displayFrame(d);var f=moment().format("MMMM Do YYYY");$("#selectedProjectNameEdit").val("Copy of "+$("#selectedProjectNameEdit").val());$(".projectSettingsLastUpdateDate").text("Modified on "+f);$(".projectSettingsCreationDate").text("Created on "+f);projectSettings.displayStatus(e.active);if(e.active){$(".projectSettingsButtonVersions").text("Version History");projectSettings.actionLoadVersions()}fluid.main.fire("afterprojectcloned",g,e);function a(i){var j=JSON.parse(i).t;var h=JSON.parse(j);for(var k in h){if((k!="uploads")&&(k!=g)){if(h.hasOwnProperty(k)){storage.set(k,h[k])}}}}fluid.api.syncDown(g,false,false,a,a);function b(){$("#selectedProjectNameEdit").focus();$(".actionOpenProject").removeClass("disabled");fluid.main.trigger("projectCloned")}setTimeout(b,600)},cloneCallback:function(c,k){var b=projectSettings._callbackSanitize(c,k,"defaultShort");if(b==null){return}var h=new fluid.models.project(b.projectData,{parse:true,projectId:b.newProjectId});fluid.main.projects.add(h,{silent:true});var a=new Date().getTime();h.set({created:a,updated:a,active:account.canAddProjects()});var g=h.toJSON();var d=b.newProjectId;var j=JSON.parse(b.projectData);g=j[d];var i=j.uploads;var e=Object.keys(i).length;var f=0;if(i&&e){$.each(i,function(l){currentUpload=storage.get(l);if(currentUpload.groups){if($.inArray(g.id,currentUpload.groups)===-1){currentUpload.groups.push(g.id)}}else{currentUpload.groups=[g.id]}storage.set(l,currentUpload);f+=1;if(f===e){project.afterClone(d,g)}})}else{project.afterClone(d,g)}},clone:function(a,c){var b=project.bundle(c);fluid.api.projectSync(c,b,function(){fluid.api.projectDuplicate(c,project.cloneCallback)},function(){notification.add("alert","Could not save your project to the server. Please check your connection.")})},lastProjectClosed:true};fluid.main.on("projectclonetrigger",project.clone);fluid.main.on("noprojectssynceddown",function(){project.add("","",null,function(a){project.open(a);project.setNumber()})});fluid.main.on("projects.synced",project.sort);fluid.main.on("uploads.synced",function(a,b){fluid.main.fire("projects.loading",{count:b.length});project.load();fluid.main.fire("projects.loaded")});fluid.main.on("editor.afterAccountRegister",project.updateOnSignup);fluid.main.on("afteruploadssynced",function(){var a=fluid.main.account.get("lastOpenProject");var b=fluid.main.account.get("projectIds");if(b.length>0){project.open((($.inArray(a,b)>-1&&a)||fluid.main.projects.getLatestActiveProject()||b[b.length-1]))}});fluid.main.on("fluidmenuopenedbyuser",function(){project.renderPreview(fluid.main.project.get("id"))});fluid.main.on("canvasdragstop",function(){if(fluid.zoom.getCtx()!=="project"){project.updatePages();project.updateLinks()}else{if(project.getPagesInViewport("strict").length<project.get("pages").length){fluid.zoom.zoomToAllDebounced()}}});fluid.main.on("beforepaneldisplay",function(a,b){if(b==="projectSettingsPanelMain"){project.updateThumbsActiveStatus()}});fluid.main.on("projectIntegrityCheckNeeded",function(){project.checkIntegrity(fluid.main.project.get("id"))});fluid.main.on("beforelogout",function(){project.sync(null,account.syncedBeforeLogout)});fluid.main.on("needprojectsync",function(){project.sync()});fluid.main.on("loggingout projectclosetrigger",function(){project.close()});fluid.main.on("editor.afterLogout",function(){project.load()});fluid.main.on("orientationchange",function(a,b){project.orient(b);project.updatePages();project.updateLinks()});fluid.main.on("projectpreviewneeded",function(a,c,b){project.renderPreview(c,b)});fluid.main.on("projectloadneeded",function(a,d,c,b){project.loadIfUnloaded(d,c,b)});fluid.main.on("projectactivestatuschange",function(a,d,b){var c=false;if(b){c=project.dropToActive(projectSettings.lastSelectedId)}else{c=project.dropToInactive(projectSettings.lastSelectedId);fluid.main.fire("projectInactive")}fluid.main.fire("afterprojectstatuschange",d,c)});fluid.main.on("projectrenametrigger",function(a,b){project.rename(b)});fluid.main.on("projectaddtrigger",function(a,f){var b=parseInt(fluid.main.account.get("maxActiveProjects"),10);var d=fluid.main.projects.filter(function(e){if(e.get("removed")){return false}else{return true}}).length;if(b!==0&&d>=b){fluid.main.fire("account:alert","projectLimitHit","onAddActive")}else{var c=project.add(f);if(c){var g=projectSettings.getItemById(c);projectSettings.displayFrame(g);fluid.main.trigger("projectCreated",c)}}});fluid.main.on("projectopentrigger",function(a,c,b){project.open(c,b)});fluid.main.on("updatepagesandlinksneeded",function(){project.updatePages();project.updateLinks()});fluid.main.on("userSettings.closePanels",function(){if(!fluid.main.project||fluid.main.project.get("removed")){var a=fluid.main.account.get("projectIds");if(a.length){project.open(a[a.length-1])}else{project.add("","",null,function(b){project.open(b)})}}});fluid.main.on("accountupgraded",function(a,b){if(fluid.main.projects.activeProjectCount()>b.maxActiveProjects){project.load()}else{project.setNumber();projectSettings.resetFilter()}});fluid.main.on("branding.uploadError branding.uploadComplete",function(a,b){if(!b){b={}}if(b.needSync&&b.projectId){project.sync(b.projectId,null)}else{if(b.projectObj){project.set(b.projectObj)}}});fluid.main.on("editor.afterLogout",function(){var a=project.add(null,"Project 1");project.load();fluid.command.create("open",{id:a}).dispatchTo("fluid.controllers.project")});window.projTempObj=project;module.exports=project;